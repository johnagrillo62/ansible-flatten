~d0.name = Clone the app's source code
~d1.ansible.builtin.git = 
~d2.repo = '{{ rails_deploy_git_location }}'
~d2.dest = '{{ rails_deploy_src }}'
~d2.version = '{{ rails_deploy_git_version }}'
~d2.remote = '{{ rails_deploy_git_remote }}'
~d2.accept_hostkey = True
~d1.register = rails_deploy_register_repo_status
~d1.when = rails_deploy_git_location is defined and rails_deploy_git_location
~d1.become = True
~d1.become_user = '{{ rails_deploy_service }}'
~d0.name = Detect a temporary public deploy page
~d1.ansible.builtin.stat = 
~d2.path = '{{ rails_deploy_src }}/public/deploy.html'
~d1.register = rails_deploy_register_public_deploy_page
~d0.name = Enable the temporary deploy page
~d1.ansible.builtin.copy = 
~d2.src = '{{ rails_deploy_src }}/public/deploy.html'
~d2.dest = '{{ rails_deploy_src }}/public/index.html'
~d2.mode = '0644'
~d2.remote_src = True
~d1.when = rails_deploy_register_public_deploy_page.stat.exists and
~d1.changed_when = False
~d1.become = True
~d1.become_user = '{{ rails_deploy_service }}'  # noqa no-handler
~d0.name = Update gems
~d1.ansible.builtin.command = bundle install --deployment
~d1.args = 
~d2.chdir = '{{ rails_deploy_src }}'
~d1.changed_when = False
~d1.when = rails_deploy_register_repo_status is defined and
~d1.become = True
~d1.become_user = '{{ rails_deploy_service }}'  # noqa no-handler
~d0.name = Restart the background worker asynchronously
~d1.ansible.builtin.service = 
~d2.name = '{{ rails_deploy_worker }}'
~d2.state = 'restarted'
~d1.async = 90  # noqa no-handler
~d1.when = rails_deploy_worker_enabled and
~d0.name = Prepare the database
~d1.ansible.builtin.shell = '{{ rails_deploy_env_source }} && bundle exec rake db:schema:load db:seed'
~d1.args = 
~d2.chdir = '{{ rails_deploy_src }}'
~d1.when = (rails_deploy_database_create and rails_deploy_register_database_created is defined and
~d1.become = True
~d1.become_user = '{{ rails_deploy_service }}'  # noqa no-handler
~d1.register = rails_deploy__register_db_schema_load
~d1.changed_when = rails_deploy__register_db_schema_load.changed | bool
~d0.name = Store mtime of the config folder
~d1.ansible.builtin.stat = 
~d2.path = '{{ rails_deploy_src }}/config'
~d1.register = rails_deploy_register_mtime_config
~d1.when = inventory_hostname == rails_deploy_hosts_master and
~d0.name = Store mtime of the db/schema.rb file
~d1.ansible.builtin.stat = 
~d2.path = '{{ rails_deploy_src }}/db/schema.rb'
~d1.register = rails_deploy_register_mtime_schema
~d1.when = inventory_hostname == rails_deploy_hosts_master and
~d0.name = Execute shell commands before migration
~d1.ansible.builtin.shell = '{{ rails_deploy_env_source }} && {{ item }}'
~d1.args = 
~d2.chdir = '{{ rails_deploy_src }}'
~d1.when = rails_deploy_pre_migrate_shell_commands and rails_deploy_git_location and
~d1.with_items = '{{ rails_deploy_pre_migrate_shell_commands }}'
~d1.become = True
~d1.become_user = '{{ rails_deploy_service }}'  # noqa no-handler
~d1.register = rails_deploy__register_migration_pre_commands
~d1.changed_when = rails_deploy__register_migration_pre_commands.changed | bool
~d0.name = Migrate the database
~d1.ansible.builtin.shell = '{{ rails_deploy_env_source }} && bundle exec rake db:migrate'
~d1.args = 
~d2.chdir = '{{ rails_deploy_src }}'
~d1.when = inventory_hostname == rails_deploy_hosts_master and
~d1.register = rails_deploy_register_migration
~d1.changed_when = rails_deploy_register_migration.changed | bool
~d1.become = True
~d1.become_user = '{{ rails_deploy_service }}'  # noqa no-handler
~d0.name = Execute shell commands after migration
~d1.ansible.builtin.shell = '{{ rails_deploy_env_source }} && {{ item }}'
~d1.args = 
~d2.chdir = '{{ rails_deploy_src }}'
~d1.when = rails_deploy_post_migrate_shell_commands and rails_deploy_git_location and
~d1.with_items = '{{ rails_deploy_post_migrate_shell_commands }}'
~d1.become = True
~d1.become_user = '{{ rails_deploy_service }}'  # noqa no-handler
~d1.register = rails_deploy__register_migration_post_commands
~d1.changed_when = rails_deploy__register_migration_post_commands.changed | bool
~d0.name = Reload the backend server
~d1.ansible.builtin.service = 
~d2.name = '{{ rails_deploy_service }}'
~d2.state = 'reloaded'
~d1.when = rails_deploy_backend and (rails_deploy_register_repo_status is defined and
~d1.delegate_to = '{{ item }}'
~d1.with_items = '{{ groups[rails_deploy_hosts_group] }}'  # noqa no-handler
~d0.name = Restart the backend server
~d1.ansible.builtin.service = 
~d2.name = '{{ rails_deploy_service }}'
~d2.state = 'restarted'
~d1.when = rails_deploy_backend and (rails_deploy_database_force_migrate or
~d1.delegate_to = '{{ item }}'
~d1.with_items = '{{ groups[rails_deploy_hosts_group] }}'  # noqa no-handler
~d0.name = Set the extra services state
~d1.ansible.builtin.service = 
~d2.name = '{{ item.name }}'
~d2.state = '{{ item.changed_state | default("reloaded") }}'
~d1.when = rails_deploy_register_repo_status is defined and
~d1.with_items = '{{ rails_deploy_extra_services }}'  # noqa no-handler
~d0.name = Set the initial backend server state
~d1.ansible.builtin.service = 
~d2.name = '{{ rails_deploy_service }}'
~d2.state = '{{ rails_deploy_backend_state }}'
~d2.enabled = '{{ rails_deploy_backend_enabled }}'
~d1.when = rails_deploy_git_location is defined and rails_deploy_git_location and rails_deploy_backend
~d0.name = Set the initial background worker state
~d1.ansible.builtin.service = 
~d2.name = '{{ rails_deploy_worker }}'
~d2.state = '{{ rails_deploy_worker_state }}'
~d2.enabled = '{{ rails_deploy_worker_enabled }}'
~d1.when = rails_deploy_worker_enabled and
~d0.name = Set the initial extra services state
~d1.ansible.builtin.service = 
~d2.name = '{{ item.name }}'
~d2.state = '{{ item.state | default("started") }}'
~d2.enabled = '{{ item.enabled | default(True) }}'
~d1.when = rails_deploy_git_location is defined and rails_deploy_git_location and
~d1.with_items = '{{ rails_deploy_extra_services }}'
~d0.name = Execute shell commands after the backend is ready
~d1.ansible.builtin.shell = '{{ rails_deploy_env_source }} && {{ item }}  # noqa no-handler'
~d1.args = 
~d2.chdir = '{{ rails_deploy_src }}'
~d1.when = rails_deploy_post_restart_shell_commands and rails_deploy_git_location and
~d1.with_items = '{{ rails_deploy_post_restart_shell_commands }}'
~d1.become = True
~d1.become_user = '{{ rails_deploy_service }}'
~d1.register = rails_deploy__register_shell_commands
~d1.changed_when = rails_deploy__register_shell_commands.changed | bool
~d0.name = Disable the temporary deploy page
~d1.ansible.builtin.file = # noqa no-handler
~d2.path = '{{ rails_deploy_src + "/public/index.html" }}'
~d2.state = 'absent'
~d1.when = rails_deploy_register_public_deploy_page.stat.exists and
~d1.changed_when = False
~d1.become = True
~d1.become_user = '{{ rails_deploy_service }}'
