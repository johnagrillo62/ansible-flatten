[0].name = Generate a random string for test
[0]["ansible.builtin.set_fact"].test_id = {{ lookup('password', '/dev/null chars=ascii_letters length=16') }}
[0].when = test_id is not defined
[1].name = Generate usernames
[1]["ansible.builtin.set_fact"].usernames[0] = AWX-Collection-tests-api_lookup-user1-{{ test_id }}
[1]["ansible.builtin.set_fact"].usernames[1] = AWX-Collection-tests-api_lookup-user2-{{ test_id }}
[1]["ansible.builtin.set_fact"].usernames[2] = AWX-Collection-tests-api_lookup-user3-{{ test_id }}
[1]["ansible.builtin.set_fact"].hosts[0] = AWX-Collection-tests-api_lookup-host1-{{ test_id }}
[1]["ansible.builtin.set_fact"].hosts[1] = AWX-Collection-tests-api_lookup-host2-{{ test_id }}
[1]["ansible.builtin.set_fact"].group_name = AWX-Collection-tests-api_lookup-group1-{{ test_id }}
[2].name = Get our collection package
[2].controller_meta = null
[2].register = controller_meta
[3].name = Generate the name of our plugin
[3]["ansible.builtin.set_fact"].plugin_name = {{ controller_meta.prefix }}.controller_api
[4].name = Create all of our users
[4].user.username = {{ item }}
[4].user.is_superuser = true
[4].user.password = {{ test_id }}
[4].loop = {{ usernames }}
[4].register = user_creation_results
[5].block[0].name = Specify the connection params
[5].block[0].debug.msg = {{ query(plugin_name, 'ping', host='DNE://junk.com', username='john', password='not_legit', verify_ssl=True) }}
[5].block[0].register = results
[5].block[0].ignore_errors = yes
[5].block[1]["ansible.builtin.assert"].that[0] = 'dne' in (results.msg | lower)
[5].block[2].name = Create our hosts
[5].block[2].host.name = {{ item }}
[5].block[2].host.inventory = Demo Inventory
[5].block[2].loop = {{ hosts }}
[5].block[3].name = Test too many params (failure from validation of terms)
[5].block[3]["ansible.builtin.set_fact"].junk = {{ query(plugin_name, 'users', 'teams', query_params={}, ) }}
[5].block[3].ignore_errors = yes
[5].block[3].register = result
[5].block[4]["ansible.builtin.assert"].that[0] = result is failed
[5].block[4]["ansible.builtin.assert"].that[1] = 'You must pass exactly one endpoint to query' in result.msg
[5].block[5].name = Try to load invalid endpoint
[5].block[5]["ansible.builtin.set_fact"].junk = {{ query(plugin_name, 'john', query_params={}, ) }}
[5].block[5].ignore_errors = yes
[5].block[5].register = result
[5].block[6]["ansible.builtin.assert"].that[0] = result is failed
[5].block[6]["ansible.builtin.assert"].that[1] = 'The requested object could not be found at' in result.msg
[5].block[7].name = Load user of a specific name without promoting objects
[5].block[7]["ansible.builtin.set_fact"].users_list = {{ lookup(plugin_name, 'users', query_params={ 'username' : user_creation_results['results'][0]['item'] }, return_objects=False) }}
[5].block[8]["ansible.builtin.assert"].that[0] = users_list['results'] | length() == 1
[5].block[8]["ansible.builtin.assert"].that[1] = users_list['count'] == 1
[5].block[8]["ansible.builtin.assert"].that[2] = users_list['results'][0]['id'] == user_creation_results['results'][0]['id']
[5].block[9].name = Load user of a specific name with promoting objects
[5].block[9]["ansible.builtin.set_fact"].user_objects = {{ query(plugin_name, 'users', query_params={ 'username' : user_creation_results['results'][0]['item'] }, return_objects=True ) }}
[5].block[10]["ansible.builtin.assert"].that[0] = user_objects | length() == 1
[5].block[10]["ansible.builtin.assert"].that[1] = users_list['results'][0]['id'] == user_objects[0]['id']
[5].block[11].name = Loop over one user with the loop syntax
[5].block[11]["ansible.builtin.assert"].that[0] = item['id'] == user_creation_results['results'][0]['id']
[5].block[11].loop = {{ query(plugin_name, 'users', query_params={ 'username' : user_creation_results['results'][0]['item'] } ) }}
[5].block[11].loop_control.label = {{ item.id }}
[5].block[12].name = Get a page of users as just ids
[5].block[12]["ansible.builtin.set_fact"].users = {{ query(plugin_name, 'users', query_params={ 'username__endswith': test_id, 'page_size': 2 }, return_ids=True ) }}
[5].block[13].debug.msg = {{ users }}
[5].block[14].name = assert that user list has 2 ids only and that they are strings, not ints
[5].block[14]["ansible.builtin.assert"].that[0] = users | length() == 2
[5].block[14]["ansible.builtin.assert"].that[1] = user_creation_results['results'][0]['id'] not in users
[5].block[14]["ansible.builtin.assert"].that[2] = user_creation_results['results'][0]['id'] | string in users
[5].block[15].name = Get all users of a system through next attribute
[5].block[15]["ansible.builtin.set_fact"].users = {{ query(plugin_name, 'users', query_params={ 'username__endswith': test_id, 'page_size': 1 }, return_all=true ) }}
[5].block[16]["ansible.builtin.assert"].that[0] = users | length() >= 3
[5].block[17].name = Get all of the users created with a max_objects of 1
[5].block[17]["ansible.builtin.set_fact"].users = {{ lookup(plugin_name, 'users', query_params={ 'username__endswith': test_id, 'page_size': 1 }, return_all=true, max_objects=1 ) }}
[5].block[17].ignore_errors = yes
[5].block[17].register = max_user_errors
[5].block[18]["ansible.builtin.assert"].that[0] = max_user_errors is failed
[5].block[18]["ansible.builtin.assert"].that[1] = 'List view at users returned 3 objects, which is more than the maximum allowed by max_objects' in max_user_errors.msg
[5].block[19].name = Get the ID of the first user created and verify that it is correct
[5].block[19]["ansible.builtin.assert"].that = query(plugin_name, 'users', query_params={ 'username' : user_creation_results['results'][0]['item'] }, return_ids=True)[0] ==  user_creation_results['results'][0]['id'] | string
[5].block[20].name = Try to get an ID of someone who does not exist
[5].block[20]["ansible.builtin.set_fact"].failed_user_id = {{ query(plugin_name, 'users', query_params={ 'username': 'john jacob jingleheimer schmidt' }, expect_one=True) }}
[5].block[20].register = result
[5].block[20].ignore_errors = yes
[5].block[21]["ansible.builtin.assert"].that[0] = result is failed
[5].block[21]["ansible.builtin.assert"].that[1] = 'Expected one object from endpoint users' in result['msg']
[5].block[22].name = Lookup too many users
[5].block[22]["ansible.builtin.set_fact"].too_many_user_ids =  {{ query(plugin_name, 'users', query_params={ 'username__endswith': test_id }, expect_one=True) }}
[5].block[22].register = results
[5].block[22].ignore_errors = yes
[5].block[23]["ansible.builtin.assert"].that[0] = results is failed
[5].block[23]["ansible.builtin.assert"].that[1] = 'Expected one object from endpoint users, but obtained 3' in results['msg']
[5].block[24].name = Get the ping page
[5].block[24]["ansible.builtin.set_fact"].ping_data = {{ lookup(plugin_name, 'ping' ) }}
[5].block[24].register = results
[5].block[25]["ansible.builtin.assert"].that[0] = results is succeeded
[5].block[25]["ansible.builtin.assert"].that[1] = 'active_node' in ping_data
[5].block[26].name = Make sure that expect_objects fails on an API page
[5].block[26]["ansible.builtin.set_fact"].my_var = {{ lookup(plugin_name, 'settings/ui', expect_objects=True) }}
[5].block[26].ignore_errors = yes
[5].block[26].register = results
[5].block[27]["ansible.builtin.assert"].that[0] = results is failed
[5].block[27]["ansible.builtin.assert"].that[1] = 'Did not obtain a list or detail view at settings/ui, and expect_objects or expect_one is set to True' in results.msg
[5].block[28].name = Load the UI settings
[5].block[28]["ansible.builtin.set_fact"].controller_settings = {{ lookup('awx.awx.controller_api', 'settings/ui') }}
[5].block[29]["ansible.builtin.assert"].that[0] = 'CUSTOM_LOGO' in controller_settings
[5].block[30].name = Display the usernames of all admin users
[5].block[30].debug.msg = Admin users: {{ query('awx.awx.controller_api', 'users', query_params={ 'is_superuser': true }) | map(attribute='username') | join(', ') }}
[5].block[30].register = results
[5].block[31]["ansible.builtin.assert"].that[0] = 'admin' in results.msg
[5].block[32].name = debug all organizations in a loop
[5].block[32].debug.msg = Organization description={{ item['description'] }} id={{ item['id'] }}
[5].block[32].loop = {{ query('awx.awx.controller_api', 'organizations') }}
[5].block[32].loop_control.label = {{ item['name'] }}
[5].block[33].name = Make sure user 'john' is an org admin of the default org if the user exists
[5].block[33].role.organization = Default
[5].block[33].role.role = admin
[5].block[33].role.user = {{ usernames[0] }}
[5].block[33].role.state = absent
[5].block[33].register = role_revoke
[5].block[33].when = query('awx.awx.controller_api', 'users', query_params={ 'username': 'DNE_TESTING' }) | length  == 1
[5].block[34]["ansible.builtin.assert"].that[0] = role_revoke is skipped
[5].block[35].name = Create an inventory group with all 'foo' hosts
[5].block[35].group.name = {{ group_name }}
[5].block[35].group.inventory = Demo Inventory
[5].block[35].group.hosts = {{ query(
     'awx.awx.controller_api',
      'hosts',
      query_params={ 'name__endswith' : test_id, },
  ) | map(attribute='name') | list }}
[5].block[35].register = group_creation
[5].block[36]["ansible.builtin.assert"].that = group_creation is changed
[5].always[0].name = Cleanup group
[5].always[0].group.name = {{ group_name }}
[5].always[0].group.inventory = Demo Inventory
[5].always[0].group.state = absent
[5].always[1].name = Cleanup hosts
[5].always[1].host.name = {{ item }}
[5].always[1].host.inventory = Demo Inventory
[5].always[1].host.state = absent
[5].always[1].loop = {{ hosts }}
[5].always[2].name = Cleanup users
[5].always[2].user.username = {{ item }}
[5].always[2].user.state = absent
[5].always[2].loop = {{ usernames }}
