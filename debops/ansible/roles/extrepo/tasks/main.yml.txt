[0].name = Import custom Ansible plugins
[0]["ansible.builtin.import_role"].name = ansible_plugins
[1].name = Import DebOps global handlers
[1]["ansible.builtin.import_role"].name = global_handlers
[2].name = Install required packages
[2]["ansible.builtin.package"].name = {{ q("flattened", (extrepo__base_packages
                              + extrepo__packages)) }}
[2]["ansible.builtin.package"].state = present
[2].register = extrepo__register_packages
[2].until = extrepo__register_packages is succeeded
[2].when = extrepo__enabled | bool
[3].name = Make sure that Ansible local facts directory exists
[3]["ansible.builtin.file"].path = /etc/ansible/facts.d
[3]["ansible.builtin.file"].state = directory
[3]["ansible.builtin.file"].mode = 0755
[4].name = Save extrepo local facts
[4]["ansible.builtin.template"].src = etc/ansible/facts.d/extrepo.fact.j2
[4]["ansible.builtin.template"].dest = /etc/ansible/facts.d/extrepo.fact
[4]["ansible.builtin.template"].mode = 0755
[4].notify[0] = Refresh host facts
[4].tags[0] = meta::facts
[5].name = Update Ansible facts if they were modified
[5]["ansible.builtin.meta"] = flush_handlers
[6].name = Divert original extrepo configuration
[6]["debops.debops.dpkg_divert"].path = /etc/extrepo/config.yaml
[6]["debops.debops.dpkg_divert"].state = present
[6].when = extrepo__enabled | bool and ansible_pkg_mgr == 'apt'
[7].name = Generate extrepo configuration file
[7]["ansible.builtin.template"].src = etc/extrepo/config.yaml.j2
[7]["ansible.builtin.template"].dest = /etc/extrepo/config.yaml
[7]["ansible.builtin.template"].mode = 0644
[7].register = extrepo__register_config
[7].when = extrepo__enabled | bool
[8].name = Update external APT sources if required
[8]["ansible.builtin.command"] = extrepo update {{ item.name }}
[8].loop = {{ q("flattened", extrepo__combined_sources) | debops.debops.parse_kv_config }}
[8].loop_control.label = {{ {"name": item.name, "state": item.state} }}
[8].register = extrepo__register_updated_sources
[8].changed_when = extrepo__register_updated_sources.changed | bool
[8].when = extrepo__enabled | bool and item.name in ansible_local.extrepo.sources | d() and item.state | d('present') not in ['absent', 'init', 'ignore'] and extrepo__register_config is changed
[9].name = Remove external APT sources when requested
[9]["ansible.builtin.file"].path = {{ "/etc/apt/sources.list.d/extrepo_" + item.name + ".sources" }}
[9]["ansible.builtin.file"].state = absent
[9].loop = {{ q("flattened", extrepo__combined_sources) | debops.debops.parse_kv_config }}
[9].loop_control.label = {{ {"name": item.name, "state": item.state} }}
[9].register = extrepo__register_removed_sources
[9].changed_when = extrepo__register_removed_sources.changed | bool
[9].when = extrepo__enabled | bool and item.name and item.state | d('present') == 'absent'
[10].name = Enable external APT sources
[10]["ansible.builtin.command"] = extrepo enable {{ item.name }}
[10].loop = {{ q("flattened", extrepo__combined_sources) | debops.debops.parse_kv_config }}
[10].loop_control.label = {{ {"name": item.name, "state": item.state} }}
[10].register = extrepo__register_enabled_sources
[10].changed_when = extrepo__register_enabled_sources.changed | bool
[10].when = extrepo__enabled | bool and item.name not in ansible_local.extrepo.sources | d() and item.state | d('present') not in ['absent', 'init', 'ignore']
[11].name = Update APT cache if required
[11]["ansible.builtin.apt"].update_cache = True
[11].notify[0] = Refresh host facts
[11].register = extrepo__register_apt_cache
[11].until = extrepo__register_apt_cache is succeeded
[11].when = (extrepo__enabled | bool and (extrepo__register_updated_sources is changed or extrepo__register_removed_sources is changed or extrepo__register_enabled_sources is changed))
[12].name = Update Ansible facts if APT cache was modified
[12]["ansible.builtin.meta"] = flush_handlers
