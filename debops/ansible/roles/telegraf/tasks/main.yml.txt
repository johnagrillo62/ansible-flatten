[0].name = Import custom Ansible plugins
[0]["ansible.builtin.import_role"].name = ansible_plugins
[1].name = Import DebOps global handlers
[1]["ansible.builtin.import_role"].name = global_handlers
[2].name = Import DebOps secret role
[2]["ansible.builtin.import_role"].name = secret
[3].name = Add Telegraf UNIX account to required groups
[3]["ansible.builtin.user"].name = telegraf
[3]["ansible.builtin.user"].groups = {{ telegraf__additional_groups | flatten | join(",") }}
[3]["ansible.builtin.user"].state = present
[3]["ansible.builtin.user"].append = True
[3].notify[0] = Check telegraf and restart
[4].name = Configure Telegraf instance leading file
[4]["ansible.builtin.template"].src = etc/telegraf/telegraf.conf.j2
[4]["ansible.builtin.template"].dest = /etc/telegraf/telegraf.conf
[4]["ansible.builtin.template"].owner = root
[4]["ansible.builtin.template"].group = root
[4]["ansible.builtin.template"].mode = 0644
[4].notify[0] = Check telegraf and restart
[5].name = Remove plugins configuration if requested
[5]["ansible.builtin.file"].path = /etc/telegraf/telegraf.d/{{ item.name }}.conf
[5]["ansible.builtin.file"].state = absent
[5].loop = {{ telegraf__combined_plugins | debops.debops.parse_kv_items }}
[5].loop_control.label = {{ {"name": item.name, "state": item.state | d("present")} }}
[5].when = item.state | d('present') == 'absent' and item.config | d()
[5].notify[0] = Check telegraf and restart
[6].name = Find plugins which are in filesystem
[6]["ansible.builtin.find"].paths = /etc/telegraf/telegraf.d
[6]["ansible.builtin.find"].patterns = *.conf
[6].register = telegraf__register_existing_plugins_filenames
[7].name = Backup and disactivate plugins unexisting in desired configuration
[7]["ansible.builtin.command"].cmd = mv -f '{{ item.path | quote }}' '{{ item.path | quote }}.inactive'
[7]["ansible.builtin.command"].removes = {{ item.path }}
[7].loop = {{ telegraf__register_existing_plugins_filenames.files }}
[7].loop_control.label = {{ {"path": item.path} }}
[7].when = item.path | basename | splitext | first not in telegraf__combined_plugins | debops.debops.parse_kv_items | map(attribute="name")
[7].notify[0] = Check telegraf and restart
[8].name = Configure plugins
[8]["ansible.builtin.template"].src = etc/telegraf/telegraf.d/plugin.conf.j2
[8]["ansible.builtin.template"].dest = /etc/telegraf/telegraf.d/{{ item.name }}.conf
[8]["ansible.builtin.template"].owner = root
[8]["ansible.builtin.template"].group = telegraf
[8]["ansible.builtin.template"].mode = 0640
[8].loop = {{ telegraf__combined_plugins | debops.debops.parse_kv_items }}
[8].loop_control.label = {{ {"name": item.name, "state": item.state | d("present")} }}
[8].when = (item.state | d('present') not in ['absent', 'ignore'] and (item.config | d() or item.raw | d()))
[8].no_log = {{ debops__no_log | d(True) }}
[8].notify[0] = Check telegraf and restart
[9].name = Make sure that Ansible local facts directory exists
[9]["ansible.builtin.file"].path = /etc/ansible/facts.d
[9]["ansible.builtin.file"].state = directory
[9]["ansible.builtin.file"].mode = 0755
[10].name = Save Telegraf instance local facts
[10]["ansible.builtin.template"].src = etc/ansible/facts.d/telegraf.fact.j2
[10]["ansible.builtin.template"].dest = /etc/ansible/facts.d/telegraf.fact
[10]["ansible.builtin.template"].owner = root
[10]["ansible.builtin.template"].group = root
[10]["ansible.builtin.template"].mode = 0755
[10].notify[0] = Refresh host facts
[10].tags[0] = meta::facts
[11].name = Re-read local facts if they have been modified
[11]["ansible.builtin.meta"] = flush_handlers
