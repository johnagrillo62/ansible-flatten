[0].name = Install Box Backup client package
[0]["ansible.builtin.package"].name = boxbackup-client
[0]["ansible.builtin.package"].state = present
[0].register = boxbackup__register_client_packages
[0].until = boxbackup__register_client_packages is succeeded
[1].name = Set backup softlimit size for client hosts
[1]["ansible.builtin.set_fact"].boxbackup_softlimit = {{ (ansible_mounts | sum(attribute="size_total") / 1024 / 1024
                              + boxbackup_softlimit_padding) | int }}
[1].when = (boxbackup_softlimit is undefined or not boxbackup_softlimit)
[2].name = Set backup hardlimit size for client hosts
[2]["ansible.builtin.set_fact"].boxbackup_hardlimit = {{ (boxbackup_softlimit | float * boxbackup_hardlimit_multiplier | float) | int }}
[2].when = (boxbackup_hardlimit is undefined or not boxbackup_hardlimit)
[3].name = Create accounts for client hosts
[3]["ansible.builtin.command"] = bbstoreaccounts create {{ boxbackup_account }} {{ boxbackup_discnum }} {{ boxbackup_softlimit }}M {{ boxbackup_hardlimit }}M
[3].args.creates = {{ boxbackup_storage }}/backup/{{ boxbackup_account }}/info.rfw
[3].delegate_to = {{ boxbackup_server }}
[4].name = Make sure that boxbackup client directories exists
[4]["ansible.builtin.file"].path = {{ item }}
[4]["ansible.builtin.file"].state = directory
[4]["ansible.builtin.file"].owner = root
[4]["ansible.builtin.file"].group = root
[4]["ansible.builtin.file"].mode = 0700
[4].with_items[0] = /etc/boxbackup
[4].with_items[1] = /etc/boxbackup/bbackupd
[4].with_items[2] = /etc/boxbackup/servers/{{ boxbackup_server }}
[5].name = Check if encryption key exists on Ansible Controller
[5]["ansible.builtin.stat"].path = {{ secret + "/storage/boxbackup/clients/" + ansible_fqdn + "/" + boxbackup_account + "-FileEncKeys.raw" }}
[5].register = boxbackup_register_enckeys
[5].delegate_to = localhost
[5].become = False
[6].name = Download BoxBackup encryption key from archive
[6]["ansible.builtin.copy"].src = {{ secret + "/storage/boxbackup/clients/" + ansible_fqdn + "/" + boxbackup_account + "-FileEncKeys.raw" }}
[6]["ansible.builtin.copy"].dest = /etc/boxbackup/bbackupd/{{ boxbackup_account }}-FileEncKeys.raw
[6]["ansible.builtin.copy"].owner = root
[6]["ansible.builtin.copy"].group = root
[6]["ansible.builtin.copy"].mode = 0600
[6].when = boxbackup_register_enckeys.stat.exists
[6].notify[0] = Restart boxbackup-client
[7].name = Create encryption key on client hosts
[7]["ansible.builtin.command"] = openssl rand -out /etc/boxbackup/bbackupd/{{ boxbackup_account }}-FileEncKeys.raw {{ boxbackup_encrypt_bits }}
[7].args.creates = /etc/boxbackup/bbackupd/{{ boxbackup_account }}-FileEncKeys.raw
[7].notify[0] = Restart boxbackup-client
[8].name = Archive client encryption key
[8]["ansible.builtin.fetch"].src = /etc/boxbackup/bbackupd/{{ boxbackup_account }}-FileEncKeys.raw
[8]["ansible.builtin.fetch"].dest = {{ secret }}/storage/boxbackup/clients/{{ ansible_fqdn }}/{{ boxbackup_account }}-FileEncKeys.raw
[8]["ansible.builtin.fetch"].flat = yes
[9].name = Install notification script on client hosts
[9]["ansible.builtin.template"].src = etc/boxbackup/bbackupd/NotifySysadmin.sh.j2
[9]["ansible.builtin.template"].dest = /etc/boxbackup/bbackupd/NotifySysadmin.sh
[9]["ansible.builtin.template"].owner = root
[9]["ansible.builtin.template"].group = root
[9]["ansible.builtin.template"].mode = 0700
[10].name = Configure client hosts
[10]["ansible.builtin.template"].src = etc/boxbackup/bbackupd.conf.j2
[10]["ansible.builtin.template"].dest = /etc/boxbackup/bbackupd.conf
[10]["ansible.builtin.template"].owner = root
[10]["ansible.builtin.template"].group = root
[10]["ansible.builtin.template"].mode = 0600
[10].notify[0] = Restart boxbackup-client
