[0].name = Check if Cilium Helm release exists (via cilium version)
[0].command = {{ bin_dir }}/cilium version
[0].register = cilium_release_info
[0].when = inventory_hostname == groups['kube_control_plane'][0]
[0].failed_when = false
[0].changed_when = false
[1].name = Set action to install or upgrade
[1].set_fact.cilium_action = {{ 'install' if ('release: not found' in cilium_release_info.stderr | default('') or 'release: not found' in cilium_release_info.stdout | default('')) else 'upgrade' }}
[2].name = Cilium | Install
[2].environment = {{ proxy_env }}
[2].command = {{ bin_dir }}/cilium {{ cilium_action }} --version {{ cilium_version }} -f {{ kube_config_dir }}/cilium-values.yaml -f {{ kube_config_dir }}/cilium-extra-values.yaml {{ cilium_install_extra_flags }}
[2].when = inventory_hostname == groups['kube_control_plane'][0]
[3].name = Cilium | Wait for pods to run
[3].command = {{ kubectl }} -n kube-system get pods -l k8s-app=cilium -o jsonpath='{.items[?(@.status.containerStatuses[0].ready==false)].metadata.name}'
[3].register = pods_not_ready
[3].until = pods_not_ready.stdout.find("cilium")==-1
[3].retries = {{ cilium_rolling_restart_wait_retries_count | int }}
[3].delay = {{ cilium_rolling_restart_wait_retries_delay_seconds | int }}
[3].failed_when = false
[3].when = inventory_hostname == groups['kube_control_plane'][0]
[4].name = Cilium | Wait for CiliumLoadBalancerIPPool CRD to be present
[4].command = {{ kubectl }} wait --for condition=established --timeout=60s crd/ciliumloadbalancerippools.cilium.io
[4].register = cillium_lbippool_crd_ready
[4].retries = {{ cilium_rolling_restart_wait_retries_count | int }}
[4].delay = {{ cilium_rolling_restart_wait_retries_delay_seconds | int }}
[4].failed_when = false
[4].when[0] = inventory_hostname == groups['kube_control_plane'][0]
[4].when[1] = cilium_loadbalancer_ip_pools is defined and (cilium_loadbalancer_ip_pools|length>0)
[5].name = Cilium | Create CiliumLoadBalancerIPPool manifests
[5].template.src = {{ item.name }}/{{ item.file }}.j2
[5].template.dest = {{ kube_config_dir }}/{{ item.name }}-{{ item.file }}
[5].template.mode = 0644
[5].with_items[0].name = cilium
[5].with_items[0].file = cilium-loadbalancer-ip-pool.yml
[5].with_items[0].type = CiliumLoadBalancerIPPool
[5].when[0] = inventory_hostname == groups['kube_control_plane'][0]
[5].when[1] = cillium_lbippool_crd_ready is defined and cillium_lbippool_crd_ready.rc is defined and cillium_lbippool_crd_ready.rc == 0
[5].when[2] = cilium_loadbalancer_ip_pools is defined and (cilium_loadbalancer_ip_pools|length>0)
[6].name = Cilium | Apply CiliumLoadBalancerIPPool from cilium_loadbalancer_ip_pools
[6].kube.name = {{ item.name }}
[6].kube.kubectl = {{ bin_dir }}/kubectl
[6].kube.resource = {{ item.type }}
[6].kube.filename = {{ kube_config_dir }}/{{ item.name }}-{{ item.file }}
[6].kube.state = latest
[6].loop[0].name = cilium
[6].loop[0].file = cilium-loadbalancer-ip-pool.yml
[6].loop[0].type = CiliumLoadBalancerIPPool
[6].when[0] = inventory_hostname == groups['kube_control_plane'][0]
[6].when[1] = cillium_lbippool_crd_ready is defined and cillium_lbippool_crd_ready.rc is defined and cillium_lbippool_crd_ready.rc == 0
[6].when[2] = cilium_loadbalancer_ip_pools is defined and (cilium_loadbalancer_ip_pools|length>0)
[7].name = Cilium | Wait for CiliumBGPPeeringPolicy CRD to be present
[7].command = {{ kubectl }} wait --for condition=established --timeout=60s crd/ciliumbgppeeringpolicies.cilium.io
[7].register = cillium_bgpppolicy_crd_ready
[7].retries = {{ cilium_rolling_restart_wait_retries_count | int }}
[7].delay = {{ cilium_rolling_restart_wait_retries_delay_seconds | int }}
[7].failed_when = false
[7].when[0] = inventory_hostname == groups['kube_control_plane'][0]
[7].when[1] = cilium_bgp_peering_policies is defined and (cilium_bgp_peering_policies|length>0)
[8].name = Cilium | Create CiliumBGPPeeringPolicy manifests
[8].template.src = {{ item.name }}/{{ item.file }}.j2
[8].template.dest = {{ kube_config_dir }}/{{ item.name }}-{{ item.file }}
[8].template.mode = 0644
[8].with_items[0].name = cilium
[8].with_items[0].file = cilium-bgp-peering-policy.yml
[8].with_items[0].type = CiliumBGPPeeringPolicy
[8].when[0] = inventory_hostname == groups['kube_control_plane'][0]
[8].when[1] = cillium_bgpppolicy_crd_ready is defined and cillium_bgpppolicy_crd_ready.rc is defined and cillium_bgpppolicy_crd_ready.rc == 0
[8].when[2] = cilium_bgp_peering_policies is defined and (cilium_bgp_peering_policies|length>0)
[9].name = Cilium | Apply CiliumBGPPeeringPolicy from cilium_bgp_peering_policies
[9].kube.name = {{ item.name }}
[9].kube.kubectl = {{ bin_dir }}/kubectl
[9].kube.resource = {{ item.type }}
[9].kube.filename = {{ kube_config_dir }}/{{ item.name }}-{{ item.file }}
[9].kube.state = latest
[9].loop[0].name = cilium
[9].loop[0].file = cilium-bgp-peering-policy.yml
[9].loop[0].type = CiliumBGPPeeringPolicy
[9].when[0] = inventory_hostname == groups['kube_control_plane'][0]
[9].when[1] = cillium_bgpppolicy_crd_ready is defined and cillium_bgpppolicy_crd_ready.rc is defined and cillium_bgpppolicy_crd_ready.rc == 0
[9].when[2] = cilium_bgp_peering_policies is defined and (cilium_bgp_peering_policies|length>0)
[10].name = Cilium | Wait for CiliumBGPClusterConfig CRD to be present
[10].command = {{ kubectl }} wait --for condition=established --timeout=60s crd/ciliumbgpclusterconfigs.cilium.io
[10].register = cillium_bgpcconfig_crd_ready
[10].retries = {{ cilium_rolling_restart_wait_retries_count | int }}
[10].delay = {{ cilium_rolling_restart_wait_retries_delay_seconds | int }}
[10].failed_when = false
[10].when[0] = inventory_hostname == groups['kube_control_plane'][0]
[10].when[1] = cilium_bgp_cluster_configs is defined and (cilium_bgp_cluster_configs|length>0)
[11].name = Cilium | Create CiliumBGPClusterConfig manifests
[11].template.src = {{ item.name }}/{{ item.file }}.j2
[11].template.dest = {{ kube_config_dir }}/{{ item.name }}-{{ item.file }}
[11].template.mode = 0644
[11].with_items[0].name = cilium
[11].with_items[0].file = cilium-bgp-cluster-config.yml
[11].with_items[0].type = CiliumBGPClusterConfig
[11].when[0] = inventory_hostname == groups['kube_control_plane'][0]
[11].when[1] = cillium_bgpcconfig_crd_ready is defined and cillium_bgpcconfig_crd_ready.rc is defined and cillium_bgpcconfig_crd_ready.rc == 0
[11].when[2] = cilium_bgp_cluster_configs is defined and (cilium_bgp_cluster_configs|length>0)
[12].name = Cilium | Apply CiliumBGPClusterConfig from cilium_bgp_cluster_configs
[12].kube.name = {{ item.name }}
[12].kube.kubectl = {{ bin_dir }}/kubectl
[12].kube.resource = {{ item.type }}
[12].kube.filename = {{ kube_config_dir }}/{{ item.name }}-{{ item.file }}
[12].kube.state = latest
[12].loop[0].name = cilium
[12].loop[0].file = cilium-bgp-cluster-config.yml
[12].loop[0].type = CiliumBGPClusterConfig
[12].when[0] = inventory_hostname == groups['kube_control_plane'][0]
[12].when[1] = cillium_bgpcconfig_crd_ready is defined and cillium_bgpcconfig_crd_ready.rc is defined and cillium_bgpcconfig_crd_ready.rc == 0
[12].when[2] = cilium_bgp_cluster_configs is defined and (cilium_bgp_cluster_configs|length>0)
[13].name = Cilium | Wait for CiliumBGPPeerConfig CRD to be present
[13].command = {{ kubectl }} wait --for condition=established --timeout=60s crd/ciliumbgppeerconfigs.cilium.io
[13].register = cillium_bgppconfig_crd_ready
[13].retries = {{ cilium_rolling_restart_wait_retries_count | int }}
[13].delay = {{ cilium_rolling_restart_wait_retries_delay_seconds | int }}
[13].failed_when = false
[13].when[0] = inventory_hostname == groups['kube_control_plane'][0]
[13].when[1] = cilium_bgp_peer_configs is defined and (cilium_bgp_peer_configs|length>0)
[14].name = Cilium | Create CiliumBGPPeerConfig manifests
[14].template.src = {{ item.name }}/{{ item.file }}.j2
[14].template.dest = {{ kube_config_dir }}/{{ item.name }}-{{ item.file }}
[14].template.mode = 0644
[14].with_items[0].name = cilium
[14].with_items[0].file = cilium-bgp-peer-config.yml
[14].with_items[0].type = CiliumBGPPeerConfig
[14].when[0] = inventory_hostname == groups['kube_control_plane'][0]
[14].when[1] = cillium_bgppconfig_crd_ready is defined and cillium_bgppconfig_crd_ready.rc is defined and cillium_bgppconfig_crd_ready.rc == 0
[14].when[2] = cilium_bgp_peer_configs is defined and (cilium_bgp_peer_configs|length>0)
[15].name = Cilium | Apply CiliumBGPPeerConfig from cilium_bgp_peer_configs
[15].kube.name = {{ item.name }}
[15].kube.kubectl = {{ bin_dir }}/kubectl
[15].kube.resource = {{ item.type }}
[15].kube.filename = {{ kube_config_dir }}/{{ item.name }}-{{ item.file }}
[15].kube.state = latest
[15].loop[0].name = cilium
[15].loop[0].file = cilium-bgp-peer-config.yml
[15].loop[0].type = CiliumBGPPeerConfig
[15].when[0] = inventory_hostname == groups['kube_control_plane'][0]
[15].when[1] = cillium_bgppconfig_crd_ready is defined and cillium_bgppconfig_crd_ready.rc is defined and cillium_bgppconfig_crd_ready.rc == 0
[15].when[2] = cilium_bgp_peer_configs is defined and (cilium_bgp_peer_configs|length>0)
[16].name = Cilium | Wait for CiliumBGPAdvertisement CRD to be present
[16].command = {{ kubectl }} wait --for condition=established --timeout=60s crd/ciliumbgpadvertisements.cilium.io
[16].register = cillium_bgpadvert_crd_ready
[16].retries = {{ cilium_rolling_restart_wait_retries_count | int }}
[16].delay = {{ cilium_rolling_restart_wait_retries_delay_seconds | int }}
[16].failed_when = false
[16].when[0] = inventory_hostname == groups['kube_control_plane'][0]
[16].when[1] = cilium_bgp_advertisements is defined and (cilium_bgp_advertisements|length>0)
[17].name = Cilium | Create CiliumBGPAdvertisement manifests
[17].template.src = {{ item.name }}/{{ item.file }}.j2
[17].template.dest = {{ kube_config_dir }}/{{ item.name }}-{{ item.file }}
[17].template.mode = 0644
[17].with_items[0].name = cilium
[17].with_items[0].file = cilium-bgp-advertisement.yml
[17].with_items[0].type = CiliumBGPAdvertisement
[17].when[0] = inventory_hostname == groups['kube_control_plane'][0]
[17].when[1] = cillium_bgpadvert_crd_ready is defined and cillium_bgpadvert_crd_ready.rc is defined and cillium_bgpadvert_crd_ready.rc == 0
[17].when[2] = cilium_bgp_advertisements is defined and (cilium_bgp_advertisements|length>0)
[18].name = Cilium | Apply CiliumBGPAdvertisement from cilium_bgp_advertisements
[18].kube.name = {{ item.name }}
[18].kube.kubectl = {{ bin_dir }}/kubectl
[18].kube.resource = {{ item.type }}
[18].kube.filename = {{ kube_config_dir }}/{{ item.name }}-{{ item.file }}
[18].kube.state = latest
[18].loop[0].name = cilium
[18].loop[0].file = cilium-bgp-advertisement.yml
[18].loop[0].type = CiliumBGPAdvertisement
[18].when[0] = inventory_hostname == groups['kube_control_plane'][0]
[18].when[1] = cillium_bgpadvert_crd_ready is defined and cillium_bgpadvert_crd_ready.rc is defined and cillium_bgpadvert_crd_ready.rc == 0
[18].when[2] = cilium_bgp_advertisements is defined and (cilium_bgp_advertisements|length>0)
[19].name = Cilium | Wait for CiliumBGPNodeConfigOverride CRD to be present
[19].command = {{ kubectl }} wait --for condition=established --timeout=60s crd/ciliumbgpnodeconfigoverrides.cilium.io
[19].register = cilium_bgp_node_config_crd_ready
[19].retries = {{ cilium_rolling_restart_wait_retries_count | int }}
[19].delay = {{ cilium_rolling_restart_wait_retries_delay_seconds | int }}
[19].failed_when = false
[19].when[0] = inventory_hostname == groups['kube_control_plane'][0]
[19].when[1] = cilium_bgp_advertisements is defined and (cilium_bgp_advertisements|length>0)
[20].name = Cilium | Create CiliumBGPNodeConfigOverride manifests
[20].template.src = {{ item.name }}/{{ item.file }}.j2
[20].template.dest = {{ kube_config_dir }}/{{ item.name }}-{{ item.file }}
[20].template.mode = 0644
[20].with_items[0].name = cilium
[20].with_items[0].file = cilium-bgp-node-config-override.yml
[20].with_items[0].type = CiliumBGPNodeConfigOverride
[20].when[0] = inventory_hostname == groups['kube_control_plane'][0]
[20].when[1] = cilium_bgp_node_config_crd_ready is defined and cilium_bgp_node_config_crd_ready.rc is defined and cilium_bgp_node_config_crd_ready.rc == 0
[20].when[2] = cilium_bgp_node_config_overrides is defined and (cilium_bgp_node_config_overrides|length>0)
[21].name = Cilium | Apply CiliumBGPNodeConfigOverride from cilium_bgp_node_config_overrides
[21].kube.name = {{ item.name }}
[21].kube.kubectl = {{ bin_dir }}/kubectl
[21].kube.resource = {{ item.type }}
[21].kube.filename = {{ kube_config_dir }}/{{ item.name }}-{{ item.file }}
[21].kube.state = latest
[21].loop[0].name = cilium
[21].loop[0].file = cilium-bgp-node-config-override.yml
[21].loop[0].type = CiliumBGPNodeConfigOverride
[21].when[0] = inventory_hostname == groups['kube_control_plane'][0]
[21].when[1] = cilium_bgp_node_config_crd_ready is defined and cilium_bgp_node_config_crd_ready.rc is defined and cilium_bgp_node_config_crd_ready.rc == 0
[21].when[2] = cilium_bgp_node_config_overrides is defined and (cilium_bgp_node_config_overrides|length>0)
