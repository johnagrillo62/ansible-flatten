[0].name = Generate a test ID
[0].set_fact.test_id = {{ lookup('password', '/dev/null chars=ascii_letters length=16') }}
[0].when = test_id is not defined
[1].name = Generate random string for template and project
[1].set_fact.jt_name = AWX-Collection-tests-job_wait-long_running-{{ test_id }}
[1].set_fact.proj_name = AWX-Collection-tests-job_wait-long_running-{{ test_id }}
[2].block[0].name = Create a project
[2].block[0].project.name = {{ proj_name }}
[2].block[0].project.scm_type = git
[2].block[0].project.scm_url = https://github.com/ansible/test-playbooks.git
[2].block[0].project.scm_update_on_launch = true
[2].block[0].project.organization = Default
[2].block[1].name = Create a job template
[2].block[1].job_template.name = {{ jt_name }}
[2].block[1].job_template.playbook = sleep.yml
[2].block[1].job_template.job_type = run
[2].block[1].job_template.project = {{ proj_name }}
[2].block[1].job_template.inventory = Demo Inventory
[2].block[1].job_template.extra_vars.sleep_interval = 600
[2].block[2].name = Check module fails with correct msg
[2].block[2].job_wait.job_id = 99999999
[2].block[2].register = result
[2].block[2].ignore_errors = yes
[2].block[3].assert.that[0] = result is failed
[2].block[3].assert.that[1] = result.msg == 'Unable to wait, no job_id 99999999 found: The requested object could not be found.' or result.msg == 'Unable to wait on job 99999999; that ID does not exist.'
[2].block[4].name = Launch Demo Job Template (take happy path)
[2].block[4].job_launch.job_template = Demo Job Template
[2].block[4].register = job
[2].block[5].assert.that[0] = job is changed
[2].block[6].name = Wait for the Job to finish
[2].block[6].job_wait.job_id = {{ job.id }}
[2].block[6].register = wait_results
[2].block[7].assert.that[0] = wait_results is successful
[2].block[7].assert.that[1] = 'elapsed' in wait_results
[2].block[7].assert.that[2] = 'id' in wait_results
[2].block[8].name = Launch a long running job
[2].block[8].job_launch.job_template = {{ jt_name }}
[2].block[8].register = job
[2].block[9].assert.that[0] = job is changed
[2].block[10].name = Timeout waiting for the job to complete
[2].block[10].job_wait.job_id = {{ job.id }}
[2].block[10].job_wait.timeout = 5
[2].block[10].ignore_errors = yes
[2].block[10].register = wait_results
[2].block[11].assert.that[0] = 'aborted due to timeout' in wait_results.msg
[2].block[11].assert.that[1] = 'id' in wait_results
[2].block[12].name = Async cancel the long running job
[2].block[12].job_cancel.job_id = {{ job.id }}
[2].block[12].async = 3600
[2].block[12].poll = 0
[2].block[13].name = Wait for the job to exit on cancel
[2].block[13].job_wait.job_id = {{ job.id }}
[2].block[13].job_wait.timeout = 60
[2].block[13].register = wait_results
[2].block[13].ignore_errors = yes
[2].block[14].assert.that[0] = wait_results is failed
[2].block[14].assert.that[1] = wait_results.status == "canceled"
[2].block[14].assert.that[2] = 'Unable to find job with id' not in result.msg
[2].block[15].name = Generate a random string for test
[2].block[15].set_fact.test_id1 = {{ lookup('password', '/dev/null chars=ascii_letters length=16') }}
[2].block[15].when = test_id1 is not defined
[2].block[16].name = Generate names
[2].block[16].set_fact.wfjt_name2 = AWX-Collection-tests-workflow_launch--wfjt1-{{ test_id1 }}
[2].block[17].name = Create our workflow
[2].block[17].workflow_job_template.name = {{ wfjt_name2 }}
[2].block[17].workflow_job_template.state = present
[2].block[18].name = Add a node
[2].block[18].workflow_job_template_node.workflow_job_template = {{ wfjt_name2 }}
[2].block[18].workflow_job_template_node.unified_job_template = Demo Job Template
[2].block[18].workflow_job_template_node.identifier = leaf
[2].block[18].register = new_node
[2].block[19].name = Kick off a workflow
[2].block[19].workflow_launch.workflow_template = {{ wfjt_name2 }}
[2].block[19].ignore_errors = yes
[2].block[19].register = workflow
[2].block[20].name = Wait for the Workflow Job to finish
[2].block[20].job_wait.job_id = {{ workflow.job_info.id }}
[2].block[20].job_wait.job_type = workflow_jobs
[2].block[20].register = wait_workflow_results
[2].block[21].assert.that[0] = wait_workflow_results is successful
[2].block[21].assert.that[1] = 'elapsed' in wait_workflow_results
[2].block[21].assert.that[2] = 'id' in wait_workflow_results
[2].always[0].name = Clean up test workflow
[2].always[0].workflow_job_template.name = {{ wfjt_name2 }}
[2].always[0].workflow_job_template.state = absent
[2].always[1].name = Get all jobs for the template
[2].always[1]["awx.awx.job_list"].query.job_template = {{ jt_name }}
[2].always[1].register = job_list
[2].always[2].name = Delete the job template
[2].always[2].job_template.name = {{ jt_name }}
[2].always[2].job_template.playbook = sleep.yml
[2].always[2].job_template.job_type = run
[2].always[2].job_template.project = {{ proj_name }}
[2].always[2].job_template.inventory = Demo Inventory
[2].always[2].job_template.state = absent
[2].always[2].register = del_res
[2].always[2].until = del_res is succeeded
[2].always[2].retries = 5
[2].always[2].delay = 3
[2].always[3].name = Delete the project
[2].always[3].project.name = {{ proj_name }}
[2].always[3].project.organization = Default
[2].always[3].project.state = absent
[2].always[3].register = del_res
[2].always[3].until = del_res is succeeded
[2].always[3].retries = 5
[2].always[3].delay = 3
