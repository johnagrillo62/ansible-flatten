[0].name = Check if secret for encrypting data at rest already exist
[0].stat.path = {{ kube_cert_dir }}/secrets_encryption.yaml
[0].stat.get_attributes = false
[0].stat.get_checksum = false
[0].stat.get_mime = false
[0].register = secrets_encryption_file
[1].name = Slurp secrets_encryption file if it exists
[1].slurp.src = {{ kube_cert_dir }}/secrets_encryption.yaml
[1].register = secret_file_encoded
[1].when = secrets_encryption_file.stat.exists
[2].name = Base 64 Decode slurped secrets_encryption.yaml file
[2].set_fact.secret_file_decoded = {{ secret_file_encoded['content'] | b64decode | from_yaml }}
[2].when = secrets_encryption_file.stat.exists
[3].name = Extract secret value from secrets_encryption.yaml
[3].set_fact.kube_encrypt_token_extracted = {{ secret_file_decoded | json_query(secrets_encryption_query) | first | b64decode }}
[3].when = secrets_encryption_file.stat.exists
[4].name = Set kube_encrypt_token across control plane nodes
[4].set_fact.kube_encrypt_token = {{ kube_encrypt_token_extracted }}
[4].delegate_to = {{ item }}
[4].delegate_facts = true
[4].with_inventory_hostnames = kube_control_plane
[4].when = kube_encrypt_token_extracted is defined
[5].name = Write secrets for encrypting secret data at rest
[5].template.src = secrets_encryption.yaml.j2
[5].template.dest = {{ kube_cert_dir }}/secrets_encryption.yaml
[5].template.owner = root
[5].template.group = {{ kube_cert_group }}
[5].template.mode = 0640
