~d0.name = Import custom Ansible plugins
~d1.ansible.builtin.import_role = 
~d2.name = 'ansible_plugins'
~d0.name = Import DebOps global handlers
~d1.ansible.builtin.import_role = 
~d2.name = 'global_handlers'
~d0.name = Import DebOps secret role
~d1.ansible.builtin.import_role = 
~d2.name = 'secret'
~d0.name = Install Kibana packages
~d1.ansible.builtin.package = 
~d2.name = '{{ q("flattened", (kibana__base_packages
~d2.state = 'present'
~d1.notify = [ 'Refresh host facts' ]
~d1.register = kibana__register_packages
~d1.until = kibana__register_packages is succeeded
~d0.name = Add Kibana UNIX account to selected groups
~d1.ansible.builtin.user = 
~d2.name = '{{ kibana__user }}'
~d2.groups = '{{ kibana__additional_groups }}'
~d2.append = True
~d1.when = kibana__additional_groups | d()
~d0.name = Make sure that Ansible local facts directory exists
~d1.ansible.builtin.file = 
~d2.path = '/etc/ansible/facts.d'
~d2.state = 'directory'
~d2.owner = 'root'
~d2.group = 'root'
~d2.mode = '0755'
~d0.name = Save Kibana local facts
~d1.ansible.builtin.template = 
~d2.src = 'etc/ansible/facts.d/kibana.fact.j2'
~d2.dest = '/etc/ansible/facts.d/kibana.fact'
~d2.owner = 'root'
~d2.group = 'root'
~d2.mode = '0755'
~d1.notify = [ 'Refresh host facts' ]
~d1.tags = [ 'meta::facts' ]
~d0.name = Update Ansible facts if they were modified
~d1.ansible.builtin.meta = 'flush_handlers'
~d0.name = Check if the dependent config file exists
~d1.ansible.builtin.stat = 
~d2.path = '{{ secret + "/kibana/dependent_config/" + inventory_hostname + "/config.json" }}'
~d1.register = kibana__register_dependent_config_file
~d1.become = False
~d1.delegate_to = 'localhost'
~d1.when = (ansible_local.kibana.installed | d())
~d1.tags = [ 'role::kibana:config' ]
~d0.name = Load the dependent configuration from Ansible Controller
~d1.ansible.builtin.slurp = 
~d2.src = '{{ secret + "/kibana/dependent_config/" + inventory_hostname + "/config.json" }}'
~d1.register = kibana__register_dependent_config
~d1.become = False
~d1.delegate_to = 'localhost'
~d1.when = (ansible_local.kibana.installed | d() and
~d1.tags = [ 'role::kibana:config' ]
~d0.name = Divert original configuration files
~d1.debops.debops.dpkg_divert = 
~d2.path = '/etc/kibana/kibana.yml'
~d1.notify = [ 'Start kibana' ]
~d1.tags = [ 'role::kibana:config' ]
~d0.name = Generate Kibana configuration
~d1.ansible.builtin.template = 
~d2.src = 'etc/kibana/kibana.yml.j2'
~d2.dest = '/etc/kibana/kibana.yml'
~d2.owner = 'root'
~d2.group = '{{ kibana__group }}'
~d2.mode = '0660'
~d1.notify = [ 'Restart kibana' ]
~d1.tags = [ 'role::kibana:config' ]
~d0.name = Check state of installed Kibana plugins
~d1.ansible.builtin.shell = set -o nounset -o pipefail -o errexit &&
~d1.args = 
~d2.executable = 'bash'
~d2.chdir = '/usr/share/kibana'
~d1.register = kibana__register_plugins
~d1.become = True
~d1.become_user = '{{ kibana__user }}'
~d1.changed_when = False
~d1.check_mode = False
~d0.name = Install Kibana plugins
~d1.ansible.builtin.command = bin/kibana-plugin install {{ item.url | d(item.name) }}
~d1.args = 
~d2.chdir = '/usr/share/kibana'
~d1.notify = [ 'Restart kibana' ]
~d1.become = True
~d1.become_user = '{{ item.user | d(kibana__user) }}'
~d1.loop = '{{ q("flattened", kibana__combined_plugins) }}'
~d1.register = kibana__register_plugin_install
~d1.changed_when = kibana__register_plugin_install.changed | bool
~d1.when = (item.name | d() and item.state | d('present') != 'absent' and
~d4.(item.name if ' = ' not in item.name else item.name.split(':')[1]) not in kibana__register_plugins.stdout_lines)
~d0.name = Remove Kibana plugins
~d1.ansible.builtin.command = bin/kibana-plugin remove {{ item.name }}
~d1.args = 
~d2.chdir = '/usr/share/kibana'
~d1.notify = [ 'Restart kibana' ]
~d1.become = True
~d1.become_user = '{{ item.user | d(kibana__user) }}'
~d1.loop = '{{ q("flattened", kibana__combined_plugins) }}'
~d1.register = kibana__register_plugin_remove
~d1.changed_when = kibana__register_plugin_remove.changed | bool
~d1.when = (item.name | d() and item.state | d('present') == 'absent' and
~d4.(item.name if ' = ' not in item.name else item.name.split(':')[1]) in kibana__register_plugins.stdout_lines)
~d0.name = Check if the Kibana keystore exists
~d1.ansible.builtin.stat = 
~d2.path = '{{ kibana__keystore_path }}'
~d1.register = kibana__register_keystore
~d0.name = Create Kibana keystore if not present
~d1.ansible.builtin.command = 'bin/kibana-keystore create'
~d1.args = 
~d2.chdir = '/usr/share/kibana'
~d1.register = kibana__register_keystore_create
~d1.changed_when = kibana__register_keystore_create.changed | bool
~d1.when = not kibana__register_keystore.stat.exists
~d0.name = Get the list of keystore contents
~d1.ansible.builtin.command = 'bin/kibana-keystore list'
~d1.args = 
~d2.chdir = '/usr/share/kibana'
~d1.register = kibana__register_keys
~d1.changed_when = False
~d1.check_mode = '{{ False if ansible_local.kibana.installed | d() else omit }}'
~d0.name = Remove key from Kibana keystore when requested
~d1.ansible.builtin.command = 'bin/kibana-keystore remove {{ item.name }}'
~d1.args = 
~d2.chdir = '/usr/share/kibana'
~d1.loop = '{{ kibana__combined_keys | debops.debops.parse_kv_config }}'
~d1.loop_control = 
~d2.label = '{{ {"name": item.name, "state": item.state} }}'
~d1.notify = [ 'Restart kibana' ]
~d1.register = kibana__register_keystore_remove
~d1.changed_when = kibana__register_keystore_remove.changed | bool
~d1.when = (item.state | d('present') == 'absent' and
~d1.no_log = '{{ debops__no_log | d(True) }}'
~d0.name = Set or update key in Kibana keystore
~d1.environment = 
~d2.DEBOPS_KIBANA_KEY = '{{ item.value }}'
~d1.ansible.builtin.shell = |
~d1.args = 
~d2.chdir = '/usr/share/kibana'
~d2.executable = 'bash'
~d1.loop = '{{ kibana__combined_keys | debops.debops.parse_kv_config }}'
~d1.loop_control = 
~d2.label = '{{ {"name": item.name, "state": item.state} }}'
~d1.notify = [ 'Restart kibana' ]
~d1.register = kibana__register_keystore_add
~d1.changed_when = kibana__register_keystore_add.changed | bool
~d1.when = (item.state | d('present') not in ['absent', 'ignore', 'init'] and
~d1.no_log = '{{ debops__no_log | d(True) }}'
~d0.name = Save Kibana dependent configuration on Ansible Controller
~d1.ansible.builtin.template = 
~d2.src = 'secret/kibana/dependent_config/config.json.j2'
~d2.dest = '{{ secret + "/kibana/dependent_config/" + inventory_hostname + "/config.json" }}'
~d2.mode = '0644'
~d1.become = False
~d1.delegate_to = 'localhost'
~d1.tags = [ 'role::kibana:config' ]
