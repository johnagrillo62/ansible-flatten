[0].name = Generate a random string for test
[0].set_fact.test_id = {{ lookup('password', '/dev/null chars=ascii_letters length=16') }}
[0].when = test_id is not defined
[1].name = Generate names
[1].set_fact.inv_name = AWX-Collection-tests-ad_hoc_command_wait-inventory-{{ test_id }}
[1].set_fact.ssh_cred_name = AWX-Collection-tests-ad_hoc_command_wait-ssh-cred-{{ test_id }}
[1].set_fact.org_name = AWX-Collection-tests-ad_hoc_command_wait-org-{{ test_id }}
[2].name = Create a New Organization
[2].organization.name = {{ org_name }}
[3].name = Create an Inventory
[3].inventory.name = {{ inv_name }}
[3].inventory.organization = {{ org_name }}
[3].inventory.state = present
[4].name = Add localhost to the Inventory
[4].host.name = localhost
[4].host.inventory = {{ inv_name }}
[4].host.variables.ansible_connection = local
[5].name = Create a Credential
[5].credential.name = {{ ssh_cred_name }}
[5].credential.organization = {{ org_name }}
[5].credential.credential_type = Machine
[5].credential.state = present
[6].name = Check module fails with correct msg
[6].ad_hoc_command_wait.command_id = 99999999
[6].register = result
[6].ignore_errors = yes
[7].assert.that[0] = result is failed
[7].assert.that[1] = result.msg == 'Unable to wait on ad hoc command 99999999; that ID does not exist.'
[8].name = Launch command module with sleep 10
[8].ad_hoc_command.inventory = {{ inv_name }}
[8].ad_hoc_command.credential = {{ ssh_cred_name }}
[8].ad_hoc_command.module_name = command
[8].ad_hoc_command.module_args = sleep 5
[8].register = command
[9].assert.that[0] = command is changed
[10].name = Wait for the Job to finish
[10].ad_hoc_command_wait.command_id = {{ command.id }}
[10].register = wait_results
[11].assert.that[0] = wait_results is successful
[11].assert.that[1] = 'elapsed' in wait_results
[11].assert.that[2] = 'id' in wait_results
[12].name = Launch a long running command
[12].ad_hoc_command.inventory = {{ inv_name }}
[12].ad_hoc_command.credential = {{ ssh_cred_name }}
[12].ad_hoc_command.module_name = command
[12].ad_hoc_command.module_args = sleep 10000
[12].register = command
[13].assert.that[0] = command is changed
[14].name = Timeout waiting for the command to complete
[14].ad_hoc_command_wait.command_id = {{ command.id }}
[14].ad_hoc_command_wait.timeout = 1
[14].ignore_errors = yes
[14].register = wait_results
[15].assert.that[0] = ('Monitoring of ad hoc command -' in wait_results.msg and 'aborted due to timeout' in wait_results.msg) or ('Timeout waiting for command to finish.' in wait_results.msg)
[15].assert.that[1] = 'id' in wait_results
[16].name = Async cancel the long-running command
[16].ad_hoc_command_cancel.command_id = {{ command.id }}
[16].async = 3600
[16].poll = 0
[17].name = Wait for the command to exit on cancel
[17].ad_hoc_command_wait.command_id = {{ command.id }}
[17].register = wait_results
[17].ignore_errors = yes
[18].assert.that[0] = wait_results.status in ["successful", "canceled"]
[18].assert.fail_msg = Ad hoc command stdout: {{ lookup('awx.awx.controller_api', 'ad_hoc_commands/' + command.id | string + '/stdout/?format=json') }}
[18].assert.success_msg = Ad hoc command finished with status {{ wait_results.status }}
[19].name = Delete the Credential
[19].credential.name = {{ ssh_cred_name }}
[19].credential.organization = {{ org_name }}
[19].credential.credential_type = Machine
[19].credential.state = absent
[20].name = Delete the Inventory
[20].inventory.name = {{ inv_name }}
[20].inventory.organization = {{ org_name }}
[20].inventory.state = absent
[21].name = Remove the Organization
[21].organization.name = {{ org_name }}
[21].organization.state = absent
