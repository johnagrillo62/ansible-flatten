[0].name = Import custom Ansible plugins
[0]["ansible.builtin.import_role"].name = ansible_plugins
[1].name = Import DebOps global handlers
[1]["ansible.builtin.import_role"].name = global_handlers
[2].name = Import DebOps secret role
[2]["ansible.builtin.import_role"].name = secret
[3].name = Install Elasticsearch packages
[3]["ansible.builtin.package"].name = {{ q("flattened", (elasticsearch__base_packages
                              + elasticsearch__packages)) }} 
[3]["ansible.builtin.package"].state = present
[3].notify[0] = Refresh host facts
[3].register = elasticsearch__register_packages
[3].until = elasticsearch__register_packages is succeeded
[4].name = Add Elasticsearch UNIX account to selected groups
[4]["ansible.builtin.user"].name = {{ elasticsearch__user }}
[4]["ansible.builtin.user"].groups = {{ elasticsearch__additional_groups }}
[4]["ansible.builtin.user"].append = True
[4].when = elasticsearch__additional_groups | d()
[5].name = Make sure that Ansible local facts directory exists
[5]["ansible.builtin.file"].path = /etc/ansible/facts.d
[5]["ansible.builtin.file"].state = directory
[5]["ansible.builtin.file"].owner = root
[5]["ansible.builtin.file"].group = root
[5]["ansible.builtin.file"].mode = 0755
[6].name = Save Elasticsearch local facts
[6]["ansible.builtin.template"].src = etc/ansible/facts.d/elasticsearch.fact.j2
[6]["ansible.builtin.template"].dest = /etc/ansible/facts.d/elasticsearch.fact
[6]["ansible.builtin.template"].owner = root
[6]["ansible.builtin.template"].group = root
[6]["ansible.builtin.template"].mode = 0755
[6].notify[0] = Refresh host facts
[6].tags[0] = meta::facts
[7].name = Update Ansible facts if they were modified
[7]["ansible.builtin.meta"] = flush_handlers
[8].name = Check if the dependent config file exists
[8]["ansible.builtin.stat"].path = {{ secret + "/elasticsearch/dependent_config/" + inventory_hostname + "/config.json" }}
[8].register = elasticsearch__register_dependent_config_file
[8].become = False
[8].delegate_to = localhost
[8].when = (ansible_local.elasticsearch.installed | d())
[8].tags[0] = role::elasticsearch:config
[9].name = Load the dependent configuration from Ansible Controller
[9]["ansible.builtin.slurp"].src = {{ secret + "/elasticsearch/dependent_config/" + inventory_hostname + "/config.json" }}
[9].register = elasticsearch__register_dependent_config
[9].become = False
[9].delegate_to = localhost
[9].when = (ansible_local.elasticsearch.installed | d() and elasticsearch__register_dependent_config_file.stat.exists | bool)
[9].tags[0] = role::elasticsearch:config
[10].name = Divert original configuration files
[10]["debops.debops.dpkg_divert"].path = {{ item }}
[10].loop[0] = /etc/elasticsearch/elasticsearch.yml
[10].loop[1] = /etc/elasticsearch/jvm.options
[10].loop[2] = /usr/lib/sysctl.d/elasticsearch.conf
[10].loop[3] = /usr/share/elasticsearch/jdk/conf/security/java.policy
[10].notify[0] = Start elasticsearch
[10].tags[0] = role::elasticsearch:config
[11].name = Create systemd configuration directory
[11]["ansible.builtin.file"].path = /etc/systemd/system/elasticsearch.service.d
[11]["ansible.builtin.file"].state = directory
[11]["ansible.builtin.file"].owner = root
[11]["ansible.builtin.file"].group = root
[11]["ansible.builtin.file"].mode = 0755
[12].name = Generate systemd configuration
[12]["ansible.builtin.template"].src = etc/systemd/system/elasticsearch.service.d/ansible.conf.j2
[12]["ansible.builtin.template"].dest = /etc/systemd/system/elasticsearch.service.d/ansible.conf
[12]["ansible.builtin.template"].owner = root
[12]["ansible.builtin.template"].group = root
[12]["ansible.builtin.template"].mode = 0644
[12].notify[0] = Reload service manager
[13].name = Generate Elasticsearch configuration
[13]["ansible.builtin.template"].src = etc/elasticsearch/elasticsearch.yml.j2
[13]["ansible.builtin.template"].dest = /etc/elasticsearch/elasticsearch.yml
[13]["ansible.builtin.template"].owner = root
[13]["ansible.builtin.template"].group = {{ elasticsearch__group }}
[13]["ansible.builtin.template"].mode = 0660
[13].notify[0] = Restart elasticsearch
[13].tags[0] = role::elasticsearch:config
[14].name = Generate Elasticsearch JVM configuration
[14]["ansible.builtin.template"].src = etc/elasticsearch/jvm.options.j2
[14]["ansible.builtin.template"].dest = /etc/elasticsearch/jvm.options
[14]["ansible.builtin.template"].owner = root
[14]["ansible.builtin.template"].group = {{ elasticsearch__group }}
[14]["ansible.builtin.template"].mode = 0660
[14].notify[0] = Restart elasticsearch
[14].when = elasticsearch__version is version("5.0.0", ">=")
[14].tags[0] = role::elasticsearch:config
[15].name = Generate Java Policy configuration file
[15]["ansible.builtin.template"].src = usr/share/elasticsearch/jdk/conf/security/java.policy.j2
[15]["ansible.builtin.template"].dest = /usr/share/elasticsearch/jdk/conf/security/java.policy
[15]["ansible.builtin.template"].mode = 0644
[15].notify[0] = Restart elasticsearch
[15].when = elasticsearch__version is version("7.0.0", ">=")
[16].name = Manage data paths
[16]["ansible.builtin.file"].path = {{ item }}
[16]["ansible.builtin.file"].state = directory
[16]["ansible.builtin.file"].owner = {{ elasticsearch__user }}
[16]["ansible.builtin.file"].group = {{ elasticsearch__group }}
[16]["ansible.builtin.file"].mode = 0750
[16].loop = {{ q("flattened", elasticsearch__path_data) }}
[17].name = Reload systemd daemons
[17]["ansible.builtin.meta"] = flush_handlers
[18].name = Check state of installed Elasticsearch plugins
[18]["ansible.builtin.command"] = bin/elasticsearch-plugin list
[18].args.chdir = /usr/share/elasticsearch
[18].register = elasticsearch__register_plugins
[18].changed_when = False
[18].check_mode = False
[19].name = Install Elasticsearch plugins
[19]["ansible.builtin.command"] = bin/elasticsearch-plugin install {{ item.url | d(item.name) }} --batch
[19].args.chdir = /usr/share/elasticsearch
[19].notify[0] = Restart elasticsearch
[19].loop = {{ q("flattened", elasticsearch__combined_plugins) }}
[19].register = elasticsearch__register_plugin_install
[19].changed_when = elasticsearch__register_plugin_install.changed | bool
[19].when = (item.name | d() and item.state | d('present') != 'absent' and (item.name if ':' not in item.name else item.name.split(':')[1]) not in elasticsearch__register_plugins.stdout_lines)
[20].name = Remove Elasticsearch plugins
[20]["ansible.builtin.command"] = bin/elasticsearch-plugin remove {{ item.name }}
[20].args.chdir = /usr/share/elasticsearch
[20].notify[0] = Restart elasticsearch
[20].loop = {{ q("flattened", elasticsearch__combined_plugins) }}
[20].register = elasticsearch__register_plugin_remove
[20].changed_when = elasticsearch__register_plugin_remove.changed | bool
[20].when = (item.name | d() and item.state | d('present') == 'absent' and (item.name if ':' not in item.name else item.name.split(':')[1]) in elasticsearch__register_plugins.stdout_lines)
[21].name = Save Elasticsearch dependent configuration on Ansible Controller
[21]["ansible.builtin.template"].src = secret/elasticsearch/dependent_config/config.json.j2
[21]["ansible.builtin.template"].dest = {{ secret + "/elasticsearch/dependent_config/" + inventory_hostname + "/config.json" }}
[21]["ansible.builtin.template"].mode = 0644
[21].become = False
[21].delegate_to = localhost
[21].tags[0] = role::elasticsearch:config
[22].name = Ensure that Elasticsearch is restarted
[22]["ansible.builtin.meta"] = flush_handlers
[23].name = Manage Elasticsearch authentication (old)
[23]["ansible.builtin.import_tasks"] = authentication.yml
[23].run_once = True
[23].when = elasticsearch__version is version("8.0", "<") and elasticsearch__xpack_enabled | bool and elasticsearch__pki_enabled | bool
[24].name = Manage Elasticsearch authentication (new)
[24]["ansible.builtin.import_tasks"] = authentication_v8.yml
[24].run_once = True
[24].when = elasticsearch__version is version("8.0", ">=") and elasticsearch__xpack_enabled | bool and elasticsearch__pki_enabled | bool
[25].name = Manage Elasticsearch roles and users
[25]["ansible.builtin.import_tasks"] = roles_users.yml
[25].run_once = True
[25].when = elasticsearch__xpack_enabled | bool and elasticsearch__pki_enabled | bool
