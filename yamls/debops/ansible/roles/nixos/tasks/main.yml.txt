[0].name = Assert role configuration
[0]["ansible.builtin.assert"].that[0] = ansible_distribution == nixos__distribution_string
[0]["ansible.builtin.assert"].that[1] = nixos__config_dir != ""
[0]["ansible.builtin.assert"].that[2] = nixos__config_dir.startswith("/")
[0]["ansible.builtin.assert"].quiet = True
[1].name = Import DebOps secret role
[1]["ansible.builtin.import_role"].name = debops.debops.secret
[2].name = Pre hooks
[2]["ansible.builtin.include_tasks"] = {{ lookup("debops.debops.task_src", "nixos/pre_main.yml") }}
[3].name = Convert NixOS directory to a git repository
[3].when = nixos__repositories | d() or nixos__group_repositories | d() or nixos__host_repositories | d()
[3].block[0].name = Check if NixOS configuration directory is a git repository
[3].block[0]["ansible.builtin.stat"].path = {{ nixos__config_dir + "/.git" }}
[3].block[0].register = nixos__register_nixos_git
[3].block[1].name = Move NixOS configuration to a backup directory
[3].block[1]["ansible.posix.synchronize"].src = {{ nixos__config_dir + "/" }}
[3].block[1]["ansible.posix.synchronize"].dest = {{ nixos__git_backup_dir + "/" }}
[3].block[1]["ansible.posix.synchronize"].rsync_opts = {{ nixos__git_resync_options }}
[3].block[1].delegate_to = {{ inventory_hostname }}
[3].block[1].when = not nixos__register_nixos_git.stat.exists | bool and nixos__git_resync | bool
[3].block[2].name = Clear out NixOS configuration before git clone
[3].block[2]["ansible.builtin.file"].path = {{ nixos__config_dir }}
[3].block[2]["ansible.builtin.file"].state = absent
[3].block[2].when = not nixos__register_nixos_git.stat.exists | bool and nixos__git_resync | bool
[3].block[3].name = Manage NixOS configuration using git repositories
[3].block[3]["ansible.builtin.git"].repo = {{ item.repo }}
[3].block[3]["ansible.builtin.git"].dest = {{ item.dest | d(nixos__config_dir) }}
[3].block[3]["ansible.builtin.git"].accept_hostkey = {{ item.accept_hostkey | d(omit) }}
[3].block[3]["ansible.builtin.git"].bare = {{ item.bare | d(omit) }}
[3].block[3]["ansible.builtin.git"].clone = {{ item.clone | d(omit) }}
[3].block[3]["ansible.builtin.git"].depth = {{ item.depth | d(omit) }}
[3].block[3]["ansible.builtin.git"].executable = {{ item.executable | d(omit) }}
[3].block[3]["ansible.builtin.git"].force = {{ item.force | d(omit) }}
[3].block[3]["ansible.builtin.git"].key_file = {{ item.key_file | d(omit) }}
[3].block[3]["ansible.builtin.git"].recursive = {{ item.recursive | d(omit) }}
[3].block[3]["ansible.builtin.git"].reference = {{ item.reference | d(omit) }}
[3].block[3]["ansible.builtin.git"].refspec = {{ item.refspec | d(omit) }}
[3].block[3]["ansible.builtin.git"].remote = {{ item.remote | d(omit) }}
[3].block[3]["ansible.builtin.git"].ssh_opts = {{ item.ssh_opts | d(omit) }}
[3].block[3]["ansible.builtin.git"].track_submodules = {{ item.track_submodules | d(omit) }}
[3].block[3]["ansible.builtin.git"].umask = {{ item.umask | d(omit) }}
[3].block[3]["ansible.builtin.git"].update = {{ item["_update"] | d(omit) }}
[3].block[3]["ansible.builtin.git"].verify_commit = {{ item.verify_commit | d(omit) }}
[3].block[3]["ansible.builtin.git"].version = {{ item.version | d(omit) }}
[3].block[3].become = True
[3].block[3].become_user = {{ item.owner | d("root") }}
[3].block[3].loop = {{ q("flattened", nixos__repositories
                               + nixos__group_repositories
                               + nixos__host_repositories) }}
[3].block[3].notify[0] = Rebuild NixOS system
[3].block[3].when = item.repo | d() and item.version | d()
[3].block[4].name = Move old NixOS configuration back to main directory
[3].block[4]["ansible.posix.synchronize"].src = {{ nixos__git_backup_dir + "/" }}
[3].block[4]["ansible.posix.synchronize"].dest = {{ nixos__config_dir + "/" }}
[3].block[4]["ansible.posix.synchronize"].delete = False
[3].block[4]["ansible.posix.synchronize"].rsync_opts = {{ nixos__git_resync_options }}
[3].block[4].delegate_to = {{ inventory_hostname }}
[3].block[4].when = not nixos__register_nixos_git.stat.exists | bool and nixos__git_resync | bool
[3].block[5].name = Remove old backup directory
[3].block[5]["ansible.builtin.file"].path = {{ nixos__git_backup_dir }}
[3].block[5]["ansible.builtin.file"].state = absent
[3].block[5].when = not nixos__register_nixos_git.stat.exists | bool and nixos__git_resync | bool
[4].name = Remove NixOS configuration if requested
[4]["ansible.builtin.file"].path = {{ nixos__config_dir + "/" + item.name }}
[4]["ansible.builtin.file"].state = absent
[4].loop = {{ nixos__combined_configuration | flatten | debops.debops.parse_kv_items }}
[4].loop_control.label = {{ {"name": item.name, "state": item.state | d("present")} }}
[4].notify[0] = Rebuild NixOS system
[4].when = item.state | d("present") == 'absent'
[5].name = Create directories for NixOS configuration files
[5]["ansible.builtin.file"].path = {{ nixos__config_dir + "/" + (item.name | dirname) }}
[5]["ansible.builtin.file"].state = directory
[5]["ansible.builtin.file"].mode = 0755
[5].loop = {{ nixos__combined_configuration | flatten | debops.debops.parse_kv_items }}
[5].loop_control.label = {{ {"name": item.name | dirname, "state": item.state | d("present")} }}
[5].when = item.raw | d() and item.state | d("present") not in ['absent', 'ignore', 'init'] and item.name is search('/')
[6].name = Generate NixOS configuration files
[6]["ansible.builtin.template"].src = etc/nixos/template.nix.j2
[6]["ansible.builtin.template"].dest = {{ nixos__config_dir + "/" + item.name }}
[6]["ansible.builtin.template"].mode = {{ item.mode | d("0644") }}
[6].loop = {{ nixos__combined_configuration | flatten | debops.debops.parse_kv_items }}
[6].loop_control.label = {{ {"name": item.name, "state": item.state | d("present")} }}
[6].notify[0] = Rebuild NixOS system
[6].when = item.raw | d() and item.state | d("present") not in ['absent', 'ignore', 'init']
[7].name = Ensure that template directories exist
[7]["ansible.builtin.file"].path = /{{ item.path }}
[7]["ansible.builtin.file"].mode = {{ item.mode }}
[7]["ansible.builtin.file"].state = directory
[7].loop_control.label = {{ {"path": item.path, "state": item.state, "mode": item.mode} }}
[7]["with_community.general.filetree"] = {{ (nixos__host_templates
                                        + nixos__group_templates
                                        + nixos__templates) | flatten }}
[7].notify[0] = Rebuild NixOS system
[7].when = item.state == 'directory'
[8].name = Generate custom templates
[8]["ansible.builtin.template"].src = {{ item.src }}
[8]["ansible.builtin.template"].dest = /{{ item.path }}
[8]["ansible.builtin.template"].mode = {{ item.mode }}
[8].loop_control.label = {{ {"path": item.path, "state": item.state, "mode": item.mode} }}
[8]["with_community.general.filetree"] = {{ (nixos__host_templates
                                        + nixos__group_templates
                                        + nixos__templates) | flatten }}
[8].notify[0] = Rebuild NixOS system
[8].when = item.state == 'file'
[9].name = Recreate custom symlinks
[9]["ansible.builtin.file"].src = {{ item.src }}
[9]["ansible.builtin.file"].dest = /{{ item.path }}
[9]["ansible.builtin.file"].mode = {{ item.mode }}
[9]["ansible.builtin.file"].state = link
[9]["ansible.builtin.file"].force = True
[9].loop_control.label = {{ {"path": item.path, "state": item.state, "mode": item.mode} }}
[9]["with_community.general.filetree"] = {{ (nixos__host_templates
                                        + nixos__group_templates
                                        + nixos__templates) | flatten }}
[9].notify[0] = Rebuild NixOS system
[9].when = item.state == 'link'
[10].name = Flush handlers when needed
[10]["ansible.builtin.meta"] = flush_handlers
[11].name = Post hooks
[11]["ansible.builtin.include_tasks"] = {{ lookup("debops.debops.task_src", "nixos/post_main.yml") }}
