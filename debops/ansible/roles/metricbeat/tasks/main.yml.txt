[0].name = Import custom Ansible plugins
[0]["ansible.builtin.import_role"].name = ansible_plugins
[1].name = Import DebOps global handlers
[1]["ansible.builtin.import_role"].name = global_handlers
[2].name = Import DebOps secret role
[2]["ansible.builtin.import_role"].name = secret
[3].name = Install Metricbeat packages
[3]["ansible.builtin.package"].name = {{ q("flattened", (metricbeat__base_packages
                              + metricbeat__packages)) }} 
[3]["ansible.builtin.package"].state = present
[3].notify[0] = Refresh host facts
[3].register = metricbeat__register_packages
[3].until = metricbeat__register_packages is succeeded
[4].name = Make sure that Ansible local facts directory exists
[4]["ansible.builtin.file"].path = /etc/ansible/facts.d
[4]["ansible.builtin.file"].state = directory
[4]["ansible.builtin.file"].mode = 0755
[5].name = Save Metricbeat local facts
[5]["ansible.builtin.template"].src = etc/ansible/facts.d/metricbeat.fact.j2
[5]["ansible.builtin.template"].dest = /etc/ansible/facts.d/metricbeat.fact
[5]["ansible.builtin.template"].mode = 0755
[5].notify[0] = Refresh host facts
[5].tags[0] = meta::facts
[6].name = Update Ansible facts if they were modified
[6]["ansible.builtin.meta"] = flush_handlers
[7].name = Divert the original Metricbeat configuration
[7]["debops.debops.dpkg_divert"].path = /etc/metricbeat/metricbeat.yml
[7]["debops.debops.dpkg_divert"].state = present
[7].register = metricbeat__register_config_divert
[7].when = ansible_pkg_mgr == 'apt'
[8].name = Generate main Metricbeat configuration
[8]["ansible.builtin.template"].src = etc/metricbeat/metricbeat.yml.j2
[8]["ansible.builtin.template"].dest = /etc/metricbeat/metricbeat.yml
[8]["ansible.builtin.template"].mode = 0600
[8].notify[0] = Test metricbeat configuration and restart
[8].no_log = {{ debops__no_log | d(True) }}
[9].name = Create required configuration directories
[9]["ansible.builtin.file"].path = {{ "/etc/metricbeat/" + (item.name | dirname) }}
[9]["ansible.builtin.file"].state = directory
[9]["ansible.builtin.file"].mode = 0755
[9].loop = {{ metricbeat__combined_snippets | debops.debops.parse_kv_config }}
[9].loop_control.label = {{ {"name": item.name, "state": item.state} }}
[9].when = item.state | d('present') not in ['absent', 'ignore', 'init'] and item.config | d()
[9].no_log = {{ debops__no_log | d(True) }}
[10].name = Manage snippet diversion and reversion
[10]["debops.debops.dpkg_divert"].path = {{ "/etc/metricbeat/" + (item.name | regex_replace(".yml", "") + ".yml") }}
[10]["debops.debops.dpkg_divert"].state = {{ "absent" if item.state | d("present") == "absent" else "present" }}
[10]["debops.debops.dpkg_divert"].delete = True
[10].loop = {{ metricbeat__combined_snippets | debops.debops.parse_kv_config }}
[10].loop_control.label = {{ {"name": item.name, "state": item.state} }}
[10].notify[0] = Test metricbeat configuration and restart
[10].when = ansible_pkg_mgr == 'apt' and item.config | d() and (item.divert | d())
[10].no_log = {{ debops__no_log | d(True) }}
[11].name = Remove snippet configuration if requested
[11]["ansible.builtin.file"].path = {{ "/etc/metricbeat/" + (item.name | regex_replace(".yml", "") + ".yml") }}
[11]["ansible.builtin.file"].state = absent
[11].loop = {{ metricbeat__combined_snippets | debops.debops.parse_kv_config }}
[11].loop_control.label = {{ {"name": item.name, "state": item.state, "config": item.config} }}
[11].notify[0] = Test metricbeat configuration and restart
[11].when = item.state | d('present') == 'absent' and item.config | d()
[11].no_log = {{ debops__no_log | d(True) }}
[12].name = Generate snippet configuration
[12]["ansible.builtin.template"].src = etc/metricbeat/snippets.d/snippet.yml.j2
[12]["ansible.builtin.template"].dest = {{ "/etc/metricbeat/" + (item.name | regex_replace(".yml", "") + ".yml") }}
[12]["ansible.builtin.template"].mode = {{ item.mode | d("0600") }}
[12].loop = {{ metricbeat__combined_snippets | debops.debops.parse_kv_config }}
[12].loop_control.label = {{ {"name": item.name, "state": item.state, "config": item.config} }}
[12].notify[0] = Test metricbeat configuration and restart
[12].when = item.state | d('present') not in ['absent', 'ignore', 'init'] and item.config | d()
[12].no_log = {{ debops__no_log | d(True) }}
[13].name = Check if the Metricbeat keystore exists
[13]["ansible.builtin.stat"].path = /var/lib/metricbeat/metricbeat.keystore
[13].register = metricbeat__register_keystore
[14].name = Create Metricbeat keystore if not present
[14]["ansible.builtin.command"] = metricbeat keystore create
[14].register = metricbeat__register_keystore_create
[14].changed_when = metricbeat__register_keystore_create.changed | bool
[14].when = not metricbeat__register_keystore.stat.exists
[15].name = Get the list of keystore contents
[15]["ansible.builtin.command"] = metricbeat keystore list
[15].register = metricbeat__register_keys
[15].changed_when = False
[15].check_mode = {{ False if ansible_local.metricbeat.installed | d() else omit }}
[16].name = Remove key from Metricbeat keystore when requested
[16]["ansible.builtin.command"] = metricbeat keystore remove {{ item.name }}
[16].loop = {{ metricbeat__combined_keys | debops.debops.parse_kv_config }}
[16].loop_control.label = {{ {"name": item.name, "state": item.state} }}
[16].notify[0] = Test metricbeat configuration and restart
[16].register = metricbeat__register_keystore_remove
[16].changed_when = metricbeat__register_keystore_remove.changed | bool
[16].when = (item.state | d('present') == 'absent' and item.name in metricbeat__register_keys.stdout_lines)
[16].no_log = {{ debops__no_log | d(True) }}
[17].name = Set or update key in Metricbeat keystore
[17].environment.DEBOPS_METRICBEAT_KEY = {{ item.value }}
[17]["ansible.builtin.shell"] = set -o nounset -o pipefail -o errexit &&
{% if item.force | d(False) %}
printf "%s" "${DEBOPS_METRICBEAT_KEY}" | metricbeat keystore add "{{ item.name }}" --stdin --force
{% else %}
printf "%s" "${DEBOPS_METRICBEAT_KEY}" | metricbeat keystore add "{{ item.name }}" --stdin
{% endif %}

[17].args.executable = bash
[17].loop = {{ metricbeat__combined_keys | debops.debops.parse_kv_config }}
[17].loop_control.label = {{ {"name": item.name, "state": item.state} }}
[17].notify[0] = Test metricbeat configuration and restart
[17].register = metricbeat__register_keystore_add
[17].changed_when = metricbeat__register_keystore_add.changed | bool
[17].when = (item.state | d('present') not in ['absent', 'ignore', 'init'] and (item.name not in metricbeat__register_keys.stdout_lines or (item.force | d(False)) | bool))
[17].no_log = {{ debops__no_log | d(True) }}
[18].name = Enable metricbeat service on installation
[18]["ansible.builtin.service"].name = metricbeat
[18]["ansible.builtin.service"].enabled = True
[18].when = ansible_local.metricbeat.installed | d() and metricbeat__register_config_divert is changed
