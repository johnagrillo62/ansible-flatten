[0].name = Import DebOps global handlers
[0]["ansible.builtin.import_role"].name = global_handlers
[1].name = Install pgBadger APT packages
[1]["ansible.builtin.package"].name = {{ q("flattened", pgbadger__base_packages
                             + pgbadger__packages) }}
[1]["ansible.builtin.package"].state = present
[1].register = pgbadger__register_packages
[1].until = pgbadger__register_packages is succeeded
[2].name = Create system UNIX group for pgBadger
[2]["ansible.builtin.group"].name = {{ pgbadger__group }}
[2]["ansible.builtin.group"].state = present
[2]["ansible.builtin.group"].system = True
[3].name = Create system UNIX account for pgBadger
[3]["ansible.builtin.user"].name = {{ pgbadger__user }}
[3]["ansible.builtin.user"].group = {{ pgbadger__group }}
[3]["ansible.builtin.user"].groups = {{ pgbadger__additional_groups }}
[3]["ansible.builtin.user"].home = {{ pgbadger__home }}
[3]["ansible.builtin.user"].comment = {{ pgbadger__comment }}
[3]["ansible.builtin.user"].shell = /bin/bash
[3]["ansible.builtin.user"].state = present
[3]["ansible.builtin.user"].system = True
[3]["ansible.builtin.user"].generate_ssh_key = True
[4].name = Create webroot directory for pgBadger
[4]["ansible.builtin.file"].path = {{ item }}
[4]["ansible.builtin.file"].state = directory
[4]["ansible.builtin.file"].owner = {{ pgbadger__user }}
[4]["ansible.builtin.file"].group = {{ pgbadger__group }}
[4]["ansible.builtin.file"].mode = 0755
[4].loop[0] = {{ pgbadger__www_root }}
[4].loop[1] = {{ pgbadger__scripts_path }}
[5].name = Get pgBadger SSH public key from its account
[5]["ansible.builtin.slurp"].src = {{ pgbadger__ssh_public_key_file }}
[5].register = pgbadger__register_ssh_public_key
[5].when = pgbadger__ssh_accounts_enabled | bool
[5].tags[0] = role::pgbadger:ssh
[6].name = Gather facts from remote hosts
[6]["ansible.builtin.setup"].gather_subset = !all
[6]["ansible.builtin.setup"].fact_path = /dev/null
[6].delegate_to = {{ item }}
[6].delegate_facts = True
[6].loop = {{ groups[pgbadger__ssh_inventory_group] }}
[6].when = pgbadger__ssh_accounts_enabled | bool and pgbadger__ssh_inventory_group in groups
[6].tags[0] = role::pgbadger:ssh
[7].name = Set up remote SSH access for pgBadger
[7]["ansible.builtin.include_tasks"].file = ssh_accounts.yml
[7]["ansible.builtin.include_tasks"].apply.tags[0] = role::pgbadger:ssh
[7].loop = {{ groups[pgbadger__ssh_inventory_group] }}
[7].when = pgbadger__ssh_accounts_enabled | bool and pgbadger__ssh_inventory_group in groups and item != inventory_hostname
[7].tags[0] = role::pgbadger:ssh
[8].name = Verify that all required parameters are present
[8]["ansible.builtin.assert"].that[0] = item.name is defined and item.name is truthy
[8]["ansible.builtin.assert"].that[1] = (item.host is defined and item.host is truthy) or (item.raw is defined)
[8]["ansible.builtin.assert"].that[2] = (item.output is defined and item.output is truthy) or (item.raw is defined)
[8]["ansible.builtin.assert"].quiet = True
[8].loop = {{ pgbadger__combined_instances | debops.debops.parse_kv_items }}
[8].loop_control.label = {{ {"name": item.name, "state": item.state} }}
[9].name = Remove pgBadger instance scripts when requested
[9]["ansible.builtin.file"].path = {{ pgbadger__scripts_path + "/" + item.name }}
[9]["ansible.builtin.file"].state = absent
[9].loop = {{ pgbadger__combined_instances | debops.debops.parse_kv_items }}
[9].loop_control.label = {{ {"name": item.name, "state": item.state} }}
[9].when = (item.state | d('present')) in [ 'absent' ]
[10].name = Generate pgBadger instance scripts
[10]["ansible.builtin.template"].src = home/scripts/instance.j2
[10]["ansible.builtin.template"].dest = {{ pgbadger__scripts_path + "/" + item.name }}
[10]["ansible.builtin.template"].owner = {{ pgbadger__user }}
[10]["ansible.builtin.template"].group = {{ pgbadger__group }}
[10]["ansible.builtin.template"].mode = 0755
[10].loop = {{ pgbadger__combined_instances | debops.debops.parse_kv_items }}
[10].loop_control.label = {{ {"name": item.name, "state": item.state} }}
[10].when = (item.state | d('present')) not in [ 'absent', 'ignore', 'init' ]
[11].name = Manage pgBadger cron entry
[11]["ansible.builtin.cron"].name = Execute pgbadger scripts
[11]["ansible.builtin.cron"].special_time = {{ pgbadger__cron_interval }}
[11]["ansible.builtin.cron"].state = {{ pgbadger__cron_deploy_state }}
[11]["ansible.builtin.cron"].user = {{ pgbadger__user }}
[11]["ansible.builtin.cron"].job = run-parts {{ pgbadger__scripts_path }}
[12].name = Make sure that Ansible local facts directory exists
[12]["ansible.builtin.file"].path = /etc/ansible/facts.d
[12]["ansible.builtin.file"].state = directory
[12]["ansible.builtin.file"].mode = 0755
[13].name = Save pgbadger local facts
[13]["ansible.builtin.template"].src = etc/ansible/facts.d/pgbadger.fact.j2
[13]["ansible.builtin.template"].dest = /etc/ansible/facts.d/pgbadger.fact
[13]["ansible.builtin.template"].mode = 0755
[13].notify[0] = Refresh host facts
[13].tags[0] = meta::facts
[14].name = Update Ansible facts if they were modified
[14]["ansible.builtin.meta"] = flush_handlers
