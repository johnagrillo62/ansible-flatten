[0].name = Import DebOps global handlers
[0]["ansible.builtin.import_role"].name = global_handlers
[1].name = Import DebOps secret role
[1]["ansible.builtin.import_role"].name = secret
[2].name = Check if database server is installed
[2].environment.LC_MESSAGES = C
[2]["ansible.builtin.shell"] = set -o nounset -o pipefail -o errexit && dpkg-query -W -f='${Version}\n' 'mariadb-server' 'mysql-server' 'percona-server-server*' | grep -v '^$'
[2].args.executable = bash
[2].register = mariadb__register_version
[2].changed_when = False
[2].failed_when = False
[2].check_mode = False
[3].name = Check if local database port is open
[3]["ansible.builtin.command"] = nc -z localhost {{ mariadb__port }}
[3].register = mariadb__register_tunnel
[3].when = not mariadb__register_version.stdout
[3].failed_when = False
[3].changed_when = False
[4].name = Override delegation if tunnel is detected
[4]["ansible.builtin.set_fact"].mariadb__delegate_to = {{ mariadb__server | d("undefined") }}
[4].when = (not mariadb__register_version.stdout | d(False) and (mariadb__register_tunnel | d() and mariadb__register_tunnel.rc == 0))
[5].name = Override configuration if local server is detected
[5]["ansible.builtin.set_fact"].mariadb__server = localhost
[5]["ansible.builtin.set_fact"].mariadb__client = localhost
[5].when = (mariadb__register_version.stdout | d(False) or (mariadb__register_tunnel | d() and mariadb__register_tunnel.rc == 0))
[6].name = Install database client packages
[6]["ansible.builtin.package"].name = {{ q("flattened", (mariadb__base_packages
                              + mariadb__packages_map[mariadb__flavor]
                              + mariadb__packages)) }}
[6]["ansible.builtin.package"].state = present
[6].register = mariadb__register_packages
[6].until = mariadb__register_packages is succeeded
[7].name = Check if MariaDB config directory exists
[7]["ansible.builtin.stat"].path = /etc/mysql/mariadb.conf.d
[7].register = mariadb__register_confd
[8].name = Configure database client defaults
[8]["ansible.builtin.template"].src = etc/mysql/conf.d/client.cnf.j2
[8]["ansible.builtin.template"].dest = {{ mariadb__client_cnf_file }}
[8]["ansible.builtin.template"].owner = root
[8]["ansible.builtin.template"].group = root
[8]["ansible.builtin.template"].mode = 0644
[8].when = mariadb__server | d(False)
[9].name = Make sure that local fact directory exists
[9]["ansible.builtin.file"].dest = /etc/ansible/facts.d
[9]["ansible.builtin.file"].state = directory
[9]["ansible.builtin.file"].owner = root
[9]["ansible.builtin.file"].group = root
[9]["ansible.builtin.file"].mode = 0755
[10].name = Save MariaDB local facts
[10]["ansible.builtin.template"].src = etc/ansible/facts.d/mariadb.fact.j2
[10]["ansible.builtin.template"].dest = /etc/ansible/facts.d/mariadb.fact
[10]["ansible.builtin.template"].owner = root
[10]["ansible.builtin.template"].group = root
[10]["ansible.builtin.template"].mode = 0644
[10].notify[0] = Refresh host facts
[10].tags[0] = meta::facts
[11].name = Re-read local facts if they have been modified
[11]["ansible.builtin.meta"] = flush_handlers
[12].name = Manage database contents
[12]["ansible.builtin.include_tasks"] = manage_contents.yml
[12].when = (mariadb__server | d(False) and mariadb__delegate_to)
[12].tags[0] = role::mariadb:contents
