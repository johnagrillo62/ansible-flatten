[0].name = Import DebOps global handlers
[0]["ansible.builtin.import_role"].name = global_handlers
[1].name = Install required packages
[1]["ansible.builtin.package"].name = {{ (apt_mirror__base_packages + apt_mirror__packages) | flatten }}
[1]["ansible.builtin.package"].state = present
[1].register = apt_mirror__register_install
[1].until = apt_mirror__register_install is succeeded
[2].name = Get list of dpkg-stateoverride paths
[2]["ansible.builtin.shell"] = set -o nounset -o pipefail -o errexit && dpkg-statoverride --list | awk '{print $4}'

[2].args.executable = bash
[2].register = apt_mirror__register_statoverride
[2].changed_when = False
[2].check_mode = False
[3].name = Fix permissions for apt-mirror spool directory
[3]["ansible.builtin.command"] = dpkg-statoverride --update --add {{ apt_mirror__user }} {{ apt_mirror__group }} 0750 /var/spool/apt-mirror/var

[3].register = apt_mirror__register_statoverride_set
[3].changed_when = apt_mirror__register_statoverride_set.changed | bool
[3].when = "/var/spool/apt-mirror/var" not in apt_mirror__register_statoverride.stdout_lines
[4].name = Make sure that Ansible local facts directory exists
[4]["ansible.builtin.file"].path = /etc/ansible/facts.d
[4]["ansible.builtin.file"].state = directory
[4]["ansible.builtin.file"].mode = 0755
[5].name = Save apt_mirror local facts
[5]["ansible.builtin.template"].src = etc/ansible/facts.d/apt_mirror.fact.j2
[5]["ansible.builtin.template"].dest = /etc/ansible/facts.d/apt_mirror.fact
[5]["ansible.builtin.template"].mode = 0755
[5].notify[0] = Refresh host facts
[5].tags[0] = meta::facts
[6].name = Update Ansible facts if they were modified
[6]["ansible.builtin.meta"] = flush_handlers
[7].name = Divert the original apt-mirror configuration
[7]["debops.debops.dpkg_divert"].path = {{ item }}
[7]["debops.debops.dpkg_divert"].state = present
[7].loop[0] = /etc/apt/mirror.list
[7].loop[1] = /etc/cron.d/apt-mirror
[7].when = ansible_pkg_mgr == 'apt'
[8].name = Remove apt-mirror configuration if requested
[8]["ansible.builtin.file"].path = {{ "/etc/apt/" + (item.filename | d("mirror." + item.name + ".list")) }}
[8]["ansible.builtin.file"].state = absent
[8].loop = {{ apt_mirror__combined_configuration | flatten
            | debops.debops.parse_kv_items(merge_keys=["sources"]) }}
[8].loop_control.label = {{ {"name": item.name, "state": item.state | d("present")} }}
[8].when = item.state | d('present') == 'absent'
[9].name = Generate apt-mirror configuration files
[9]["ansible.builtin.template"].src = etc/apt/mirror.list.j2
[9]["ansible.builtin.template"].dest = {{ "/etc/apt/" + (item.filename | d("mirror." + item.name + ".list")) }}
[9]["ansible.builtin.template"].owner = {{ apt_mirror__user }}
[9]["ansible.builtin.template"].group = {{ apt_mirror__group }}
[9]["ansible.builtin.template"].mode = 0640
[9].loop = {{ apt_mirror__combined_configuration | flatten
            | debops.debops.parse_kv_items(defaults={"options": (apt_mirror__default_options | debops.debops.parse_kv_config)},
                                           merge_keys=["sources"]) }}
[9].loop_control.label = {{ {"name": item.name, "state": item.state | d("present")} }}
[9].when = item.state | d('present') not in [ 'absent', 'ignore', 'init' ]
[10].name = Create data directories for separate mirror instances
[10]["ansible.builtin.file"].path = {{ "/var/spool/apt-mirror/var/var." + item.name }}
[10]["ansible.builtin.file"].owner = {{ apt_mirror__user }}
[10]["ansible.builtin.file"].group = {{ apt_mirror__group }}
[10]["ansible.builtin.file"].mode = 0750
[10]["ansible.builtin.file"].state = directory
[10].loop = {{ apt_mirror__combined_configuration | flatten
            | debops.debops.parse_kv_items(defaults={"options": (apt_mirror__default_options | debops.debops.parse_kv_config)},
                                           merge_keys=["sources"]) }}
[10].loop_control.label = {{ {"name": item.name, "state": item.state | d("present")} }}
[10].when = item.state | d('present') not in [ 'absent', 'ignore', 'init' ]
[11].name = Create postmirror.sh script for separate mirror instances
[11]["ansible.builtin.file"].path = {{ "/var/spool/apt-mirror/var/var." + item.name + "/postmirror.sh" }}
[11]["ansible.builtin.file"].owner = {{ apt_mirror__user }}
[11]["ansible.builtin.file"].group = {{ apt_mirror__group }}
[11]["ansible.builtin.file"].mode = 0755
[11]["ansible.builtin.file"].state = touch
[11]["ansible.builtin.file"].modification_time = preserve
[11]["ansible.builtin.file"].access_time = preserve
[11].loop = {{ apt_mirror__combined_configuration | flatten
            | debops.debops.parse_kv_items(defaults={"options": (apt_mirror__default_options | debops.debops.parse_kv_config)},
                                           merge_keys=["sources"]) }}
[11].loop_control.label = {{ {"name": item.name, "state": item.state | d("present")} }}
[11].when = item.state | d('present') not in [ 'absent', 'ignore', 'init' ]
[12].name = Generate cron configuration for apt-mirror
[12]["ansible.builtin.template"].src = etc/cron.d/apt-mirror.j2
[12]["ansible.builtin.template"].dest = /etc/cron.d/apt-mirror
[12]["ansible.builtin.template"].mode = 0644
