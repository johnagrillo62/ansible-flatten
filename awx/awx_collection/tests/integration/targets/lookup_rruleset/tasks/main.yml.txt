[0].name = Get our collection package
[0].controller_meta = null
[0].register = controller_meta
[1].name = Generate the name of our plugin
[1].set_fact.ruleset_plugin_name = {{ controller_meta.prefix }}.schedule_rruleset
[1].set_fact.rule_plugin_name = {{ controller_meta.prefix }}.schedule_rrule
[2].name = Call ruleset with no rules
[2].set_fact.complex_rule = {{ lookup(ruleset_plugin_name | string, '2022-04-30 10:30:45') }}
[2].ignore_errors = True
[2].register = results
[3].assert.that[0] = results is failed
[3].assert.that[1] = 'You must include rules to be in the ruleset via the rules parameter' in results.msg
[4].name = call ruleset with a missing frequency
[4].set_fact.complex_rule = {{ lookup(ruleset_plugin_name, '2022-04-30 10:30:45', rules=rrules ) }}
[4].ignore_errors = True
[4].register = results
[4].vars.rrules[0].frequency = day
[4].vars.rrules[0].interval = 1
[4].vars.rrules[1].interval = 1
[4].vars.rrules[1].byweekday = sunday
[5].assert.that[0] = results is failed
[5].assert.that[1] = 'Rule 2 is missing a frequency' in results.msg
[6].name = call ruleset with a missing frequency
[6].set_fact.complex_rule = {{ lookup(ruleset_plugin_name, '2022-04-30 10:30:45', rules=rrules ) }}
[6].ignore_errors = True
[6].register = results
[6].vars.rrules[0].frequency = day
[6].vars.rrules[0].interval = 1
[6].vars.rrules[1].interval = 1
[6].vars.rrules[1].byweekday = sunday
[7].assert.that[0] = results is failed
[7].assert.that[1] = 'Rule 2 is missing a frequency' in results.msg
[8].name = call rruleset with an invalid frequency
[8].set_fact.complex_rule = {{ lookup(ruleset_plugin_name, '2022-04-30 10:30:45', rules=rrules ) }}
[8].ignore_errors = True
[8].register = results
[8].vars.rrules[0].frequency = day
[8].vars.rrules[0].interval = 1
[8].vars.rrules[1].frequency = asdf
[8].vars.rrules[1].interval = 1
[8].vars.rrules[1].byweekday = sunday
[9].assert.that[0] = results is failed
[9].assert.that[1] = 'Frequency of rule 2 is invalid asdf' in results.msg
[10].name = call rruleset with an invalid end_on
[10].set_fact.complex_rule = {{ lookup(ruleset_plugin_name, '2022-04-30 10:30:45', rules=rrules ) }}
[10].ignore_errors = True
[10].register = results
[10].vars.rrules[0].frequency = day
[10].vars.rrules[0].interval = 1
[10].vars.rrules[1].frequency = day
[10].vars.rrules[1].interval = 1
[10].vars.rrules[1].byweekday = sunday
[10].vars.rrules[1].end_on = a
[11].assert.that[0] = results is failed
[11].assert.that[1] = 'In rule 2 end_on must either be an integer or in the format YYYY-MM-DD [HH:MM:SS]' in results.msg
[12].name = Every Mondays
[12].set_fact.complex_rule = {{ lookup(ruleset_plugin_name, '2022-04-30 10:30:45', rules=rrules, timezone='UTC' ) }}
[12].ignore_errors = True
[12].register = results
[12].vars.rrules[0].frequency = day
[12].vars.rrules[0].interval = 1
[12].vars.rrules[0].byweekday = monday
[13].assert.that[0] = results is success
[13].assert.that[1] = 'DTSTART;TZID=UTC:20220430T103045 RRULE:FREQ=DAILY;BYDAY=MO;INTERVAL=1' == complex_rule
[14].name = call rruleset with an invalid byweekday
[14].set_fact.complex_rule = {{ lookup(ruleset_plugin_name, '2022-04-30 10:30:45', rules=rrules ) }}
[14].ignore_errors = True
[14].register = results
[14].vars.rrules[0].frequency = day
[14].vars.rrules[0].interval = 1
[14].vars.rrules[1].frequency = day
[14].vars.rrules[1].interval = 1
[14].vars.rrules[1].byweekday = junk
[15].assert.that[0] = results is failed
[15].assert.that[1] = 'In rule 2 byweekday must only contain values' in results.msg
[16].name = call rruleset with a monthly rule with invalid bymonthday (a)
[16].set_fact.complex_rule = {{ lookup(ruleset_plugin_name, '2022-04-30 10:30:45', rules=rrules ) }}
[16].ignore_errors = True
[16].register = results
[16].vars.rrules[0].frequency = day
[16].vars.rrules[0].interval = 1
[16].vars.rrules[1].frequency = month
[16].vars.rrules[1].interval = 1
[16].vars.rrules[1].bymonthday = a
[17].assert.that[0] = results is failed
[17].assert.that[1] = 'In rule 2 bymonthday must be between 1 and 31' in results.msg
[18].name = call rruleset with a monthly rule with invalid bymonthday (-1)
[18].set_fact.complex_rule = {{ lookup(ruleset_plugin_name, '2022-04-30 10:30:45', rules=rrules ) }}
[18].ignore_errors = True
[18].register = results
[18].vars.rrules[0].frequency = day
[18].vars.rrules[0].interval = 1
[18].vars.rrules[1].frequency = month
[18].vars.rrules[1].interval = 1
[18].vars.rrules[1].bymonthday = -1
[19].assert.that[0] = results is failed
[19].assert.that[1] = 'In rule 2 bymonthday must be between 1 and 31' in results.msg
[20].name = call rruleset with a monthly rule with invalid bymonthday (32)
[20].set_fact.complex_rule = {{ lookup(ruleset_plugin_name, '2022-04-30 10:30:45', rules=rrules ) }}
[20].ignore_errors = True
[20].register = results
[20].vars.rrules[0].frequency = day
[20].vars.rrules[0].interval = 1
[20].vars.rrules[1].frequency = month
[20].vars.rrules[1].interval = 1
[20].vars.rrules[1].bymonthday = 32
[21].assert.that[0] = results is failed
[21].assert.that[1] = 'In rule 2 bymonthday must be between 1 and 31' in results.msg
[22].name = call rruleset with a monthly rule with invalid bysetpos (junk)
[22].set_fact.complex_rule = {{ lookup(ruleset_plugin_name, '2022-04-30 10:30:45', rules=rrules ) }}
[22].ignore_errors = True
[22].register = results
[22].vars.rrules[0].frequency = day
[22].vars.rrules[0].interval = 1
[22].vars.rrules[1].frequency = month
[22].vars.rrules[1].interval = 1
[22].vars.rrules[1].bysetpos = junk
[23].assert.that[0] = results is failed
[23].assert.that[1] = 'In rule 2 bysetpos must only contain values in first, second, third, fourth, last' in results.msg
[24].name = call rruleset with an invalid timezone
[24].set_fact.complex_rule = {{ lookup(ruleset_plugin_name, '2022-04-30 10:30:45', rules=rrules, timezone='junk' ) }}
[24].ignore_errors = True
[24].register = results
[24].vars.rrules[0].frequency = day
[24].vars.rrules[0].interval = 1
[24].vars.rrules[1].frequency = day
[24].vars.rrules[1].interval = 1
[24].vars.rrules[1].byweekday = sunday
[25].assert.that[0] = results is failed
[25].assert.that[1] = 'Timezone parameter is not valid' in results.msg
[26].name = call rruleset with only exclude rules
[26].set_fact.complex_rule = {{ lookup(ruleset_plugin_name, '2022-04-30 10:30:45', rules=rrules ) }}
[26].ignore_errors = True
[26].register = results
[26].vars.rrules[0].frequency = day
[26].vars.rrules[0].interval = 1
[26].vars.rrules[0].include = False
[26].vars.rrules[1].frequency = day
[26].vars.rrules[1].interval = 1
[26].vars.rrules[1].byweekday = sunday
[26].vars.rrules[1].include = False
[27].assert.that[0] = results is failed
[27].assert.that[1] = 'A ruleset must contain at least one RRULE' in results.msg
[28].name = Every day except for Sundays
[28].set_fact.complex_rule = {{ lookup(ruleset_plugin_name, '2022-04-30 10:30:45', rules=rrules, timezone='UTC' ) }}
[28].ignore_errors = True
[28].register = results
[28].vars.rrules[0].frequency = day
[28].vars.rrules[0].interval = 1
[28].vars.rrules[1].frequency = day
[28].vars.rrules[1].interval = 1
[28].vars.rrules[1].byweekday = sunday
[28].vars.rrules[1].include = False
[29].assert.that[0] = results is success
[29].assert.that[1] = 'DTSTART;TZID=UTC:20220430T103045 RRULE:FREQ=DAILY;INTERVAL=1 EXRULE:FREQ=DAILY;BYDAY=SU;INTERVAL=1' == complex_rule
[30].name = Every day except for April 30th
[30].set_fact.complex_rule = {{ lookup(ruleset_plugin_name, '2023-04-28 17:00:00', rules=rrules, timezone='UTC' ) }}
[30].ignore_errors = True
[30].register = results
[30].vars.rrules[0].frequency = day
[30].vars.rrules[0].interval = 1
[30].vars.rrules[1].frequency = day
[30].vars.rrules[1].interval = 1
[30].vars.rrules[1].bymonth = 4
[30].vars.rrules[1].bymonthday = 30
[30].vars.rrules[1].include = False
[31].assert.that[0] = results is success
[31].assert.that[1] = 'DTSTART;TZID=UTC:20230428T170000 RRULE:FREQ=DAILY;INTERVAL=1 EXRULE:FREQ=DAILY;BYMONTH=4;BYMONTHDAY=30;INTERVAL=1' == complex_rule
[32].name = Every 5 minutes but not on Mondays from 5-7pm
[32].set_fact.complex_rule = {{ lookup(ruleset_plugin_name, '2022-04-30 10:30:45', rules=rrules, timezone='UTC' ) }}
[32].ignore_errors = True
[32].register = results
[32].vars.rrules[0].frequency = minute
[32].vars.rrules[0].interval = 5
[32].vars.rrules[1].frequency = minute
[32].vars.rrules[1].interval = 5
[32].vars.rrules[1].byweekday = monday
[32].vars.rrules[1].byhour[0] = 17
[32].vars.rrules[1].byhour[1] = 18
[32].vars.rrules[1].include = False
[33].assert.that[0] = results is success
[33].assert.that[1] = 'DTSTART;TZID=UTC:20220430T103045 RRULE:FREQ=MINUTELY;INTERVAL=5 EXRULE:FREQ=MINUTELY;INTERVAL=5;BYDAY=MO;BYHOUR=17,18' == complex_rule
[34].name = Every 15 minutes Monday to Friday from 10:01am to 6:02pm (inclusive)
[34].set_fact.complex_rule = {{ lookup(ruleset_plugin_name, '2022-04-30 10:30:45', rules=rrules, timezone='UTC' ) }}
[34].ignore_errors = True
[34].register = results
[34].vars.rrules[0].frequency = minute
[34].vars.rrules[0].byweekday[0] = monday
[34].vars.rrules[0].byweekday[1] = tuesday
[34].vars.rrules[0].byweekday[2] = wednesday
[34].vars.rrules[0].byweekday[3] = thursday
[34].vars.rrules[0].byweekday[4] = friday
[34].vars.rrules[0].interval = 15
[34].vars.rrules[0].byhour[0] = 10
[34].vars.rrules[0].byhour[1] = 11
[34].vars.rrules[0].byhour[2] = 12
[34].vars.rrules[0].byhour[3] = 13
[34].vars.rrules[0].byhour[4] = 14
[34].vars.rrules[0].byhour[5] = 15
[34].vars.rrules[0].byhour[6] = 16
[34].vars.rrules[0].byhour[7] = 17
[34].vars.rrules[0].byhour[8] = 18
[34].vars.rrules[1].frequency = minute
[34].vars.rrules[1].interval = 1
[34].vars.rrules[1].byweekday = monday,tuesday,wednesday, thursday,friday
[34].vars.rrules[1].byhour = 18
[34].vars.rrules[1].byminute = {{ range(3, 60) | list }}
[34].vars.rrules[1].include = False
[35].assert.that[0] = results is success
[35].assert.that[1] = 'DTSTART;TZID=UTC:20220430T103045 RRULE:FREQ=MINUTELY;INTERVAL=15;BYDAY=MO,TU,WE,TH,FR;BYHOUR=10,11,12,13,14,15,16,17,18 EXRULE:FREQ=MINUTELY;BYDAY=MO,TU,WE,TH,FR;BYHOUR=18;BYMINUTE=3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59;INTERVAL=1' == complex_rule
[36].name = Any Saturday whose month day is between 12 and 18
[36].set_fact.complex_rule = {{ lookup(ruleset_plugin_name, '2022-04-30 10:30:45', rules=rrules, timezone='UTC' ) }}
[36].ignore_errors = True
[36].register = results
[36].vars.rrules[0].frequency = month
[36].vars.rrules[0].interval = 1
[36].vars.rrules[0].byweekday = saturday
[36].vars.rrules[0].bymonthday = {{ range(12,19) | list }}
[37].assert.that[0] = results is success
[37].assert.that[1] = 'DTSTART;TZID=UTC:20220430T103045 RRULE:FREQ=MONTHLY;BYMONTHDAY=12,13,14,15,16,17,18;BYDAY=SA;INTERVAL=1' == complex_rule
[38].name = mondays, Tuesdays, and WEDNESDAY with case-insensitivity
[38].set_fact.complex_rule = {{ lookup(ruleset_plugin_name, '2022-04-30 10:30:45', rules=rrules, timezone='UTC' ) }}
[38].ignore_errors = True
[38].register = results
[38].vars.rrules[0].frequency = day
[38].vars.rrules[0].interval = 1
[38].vars.rrules[0].byweekday = monday, Tuesday, WEDNESDAY
[39].assert.that[0] = results is success
[39].assert.that[1] = 'DTSTART;TZID=UTC:20220430T103045 RRULE:FREQ=DAILY;BYDAY=MO,TU,WE;INTERVAL=1' == complex_rule
