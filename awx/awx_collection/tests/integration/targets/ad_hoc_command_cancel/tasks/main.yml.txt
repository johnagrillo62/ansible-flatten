[0].name = Generate a random string for test
[0]["ansible.builtin.set_fact"].test_id = {{ lookup('password', '/dev/null chars=ascii_letters length=16') }}
[0].when = test_id is not defined
[1].name = Generate names
[1]["ansible.builtin.set_fact"].inv_name = AWX-Collection-tests-ad_hoc_command_cancel-inventory-{{ test_id }}
[1]["ansible.builtin.set_fact"].ssh_cred_name = AWX-Collection-tests-ad_hoc_command_cancel-ssh-cred-{{ test_id }}
[1]["ansible.builtin.set_fact"].org_name = AWX-Collection-tests-ad_hoc_command_cancel-org-{{ test_id }}
[2].name = Create a New Organization
[2]["awx.awx.organization"].name = {{ org_name }}
[3].name = Create an Inventory
[3]["awx.awx.inventory"].name = {{ inv_name }}
[3]["awx.awx.inventory"].organization = {{ org_name }}
[3]["awx.awx.inventory"].state = present
[4].name = Add localhost to the Inventory
[4]["awx.awx.host"].name = localhost
[4]["awx.awx.host"].inventory = {{ inv_name }}
[4]["awx.awx.host"].variables.ansible_connection = local
[5].name = Create a Credential
[5]["awx.awx.credential"].name = {{ ssh_cred_name }}
[5]["awx.awx.credential"].organization = {{ org_name }}
[5]["awx.awx.credential"].credential_type = Machine
[5]["awx.awx.credential"].state = present
[6].name = Launch an Ad Hoc Command
[6]["awx.awx.ad_hoc_command"].inventory = {{ inv_name }}
[6]["awx.awx.ad_hoc_command"].credential = {{ ssh_cred_name }}
[6]["awx.awx.ad_hoc_command"].module_name = command
[6]["awx.awx.ad_hoc_command"].module_args = sleep 100
[6].register = command
[7]["ansible.builtin.assert"].that[0] = command is changed
[8].name = Cancel the command
[8]["awx.awx.ad_hoc_command_cancel"].command_id = {{ command.id }}
[8]["awx.awx.ad_hoc_command_cancel"].request_timeout = 60
[8].register = results
[9]["ansible.builtin.assert"].that[0] = results is changed
[10].name = Wait for up to a minute until the job enters the can_cancel: False state
[10]["ansible.builtin.debug"].msg = The job can_cancel status has transitioned into False, we can proceed with testing
[10].until = not job_status
[10].retries = 6
[10].delay = 10
[10].vars.job_status = {{ lookup('awx.awx.controller_api', 'ad_hoc_commands/'+ command.id | string +'/cancel')['can_cancel'] }}
[11].name = Cancel the command with hard error if it's not running
[11]["awx.awx.ad_hoc_command_cancel"].command_id = {{ command.id }}
[11]["awx.awx.ad_hoc_command_cancel"].fail_if_not_running = true
[11].register = results
[11].ignore_errors = yes
[12]["ansible.builtin.assert"].that[0] = results is failed
[13].name = Cancel an already canceled command (assert failure)
[13]["awx.awx.ad_hoc_command_cancel"].command_id = {{ command.id }}
[13]["awx.awx.ad_hoc_command_cancel"].fail_if_not_running = true
[13].register = results
[13].ignore_errors = yes
[14]["ansible.builtin.assert"].that[0] = results is failed
[15].name = Check module fails with correct msg
[15]["awx.awx.ad_hoc_command_cancel"].command_id = 9999999999
[15].register = result
[15].ignore_errors = yes
[16]["ansible.builtin.assert"].that[0] = result.msg == 'Unable to find command with id 9999999999'
[17].name = Delete the Credential
[17]["awx.awx.credential"].name = {{ ssh_cred_name }}
[17]["awx.awx.credential"].organization = {{ org_name }}
[17]["awx.awx.credential"].credential_type = Machine
[17]["awx.awx.credential"].state = absent
[18].name = Delete the Inventory
[18]["awx.awx.inventory"].name = {{ inv_name }}
[18]["awx.awx.inventory"].organization = {{ org_name }}
[18]["awx.awx.inventory"].state = absent
[19].name = Remove the Organization
[19]["awx.awx.organization"].name = {{ org_name }}
[19]["awx.awx.organization"].state = absent
