[0].name = Set dns server for docker
[0].set_fact.docker_dns_servers = {{ dns_servers }}
[1].name = Show docker_dns_servers
[1].debug.msg = {{ docker_dns_servers }}
[2].name = Add upstream dns servers
[2].set_fact.docker_dns_servers = {{ docker_dns_servers + upstream_dns_servers }}
[2].when = dns_mode in ['coredns', 'coredns_dual']
[3].name = Add global searchdomains
[3].set_fact.docker_dns_search_domains = {{ docker_dns_search_domains + searchdomains }}
[4].name = Check system nameservers
[4].shell = set -o pipefail && grep "^nameserver" /etc/resolv.conf | sed -r 's/^nameserver\s*([^#\s]+)\s*(#.*)?/\1/'
[4].args.executable = /bin/bash
[4].changed_when = false
[4].register = system_nameservers
[4].check_mode = false
[5].name = Check system search domains
[5].shell = grep "^search" /etc/resolv.conf | sed -r 's/^search\s*([^#]+)\s*(#.*)?/\1/'
[5].args.executable = /bin/bash
[5].changed_when = false
[5].register = system_search_domains
[5].check_mode = false
[6].name = Add system nameservers to docker options
[6].set_fact.docker_dns_servers = {{ docker_dns_servers | union(system_nameservers.stdout_lines) | unique }}
[6].when = system_nameservers.stdout
[7].name = Add system search domains to docker options
[7].set_fact.docker_dns_search_domains = {{ docker_dns_search_domains | union(system_search_domains.stdout.split() | default([])) | unique }}
[7].when = system_search_domains.stdout
[8].name = Check number of nameservers
[8].fail.msg = Too many nameservers. You can relax this check by set docker_dns_servers_strict=false in docker.yml and we will only use the first 3.
[8].when = docker_dns_servers | length > 3 and docker_dns_servers_strict | bool
[9].name = Rtrim number of nameservers to 3
[9].set_fact.docker_dns_servers = {{ docker_dns_servers[0:3] }}
[9].when = docker_dns_servers | length > 3 and not docker_dns_servers_strict | bool
[10].name = Check number of search domains
[10].fail.msg = Too many search domains
[10].when = docker_dns_search_domains | length > 6
[11].name = Check length of search domains
[11].fail.msg = Search domains exceeded limit of 256 characters
[11].when = docker_dns_search_domains | join(' ') | length > 256
