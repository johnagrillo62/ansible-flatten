[0].name = Generate a random string for test
[0]["ansible.builtin.set_fact"].test_id = {{ lookup('password', '/dev/null chars=ascii_letters length=16') }}
[0].when = test_id is not defined
[1].name = Generate names
[1]["ansible.builtin.set_fact"].wfjt_name1 = AWX-Collection-tests-workflow_launch--wfjt1-{{ test_id }}
[1]["ansible.builtin.set_fact"].wfjt_name2 = AWX-Collection-tests-workflow_launch--wfjt1-{{ test_id }}-2
[1]["ansible.builtin.set_fact"].approval_node_name = AWX-Collection-tests-workflow_launch_approval_node-{{ test_id }}
[2].name = Create workflows
[2].block[0].name = Create our workflow
[2].block[0].workflow_job_template.name = {{ wfjt_name1 }}
[2].block[0].workflow_job_template.state = present
[2].block[1].name = Add a node
[2].block[1].workflow_job_template_node.workflow_job_template = {{ wfjt_name1 }}
[2].block[1].workflow_job_template_node.unified_job_template = Demo Job Template
[2].block[1].workflow_job_template_node.identifier = leaf
[2].block[1].register = new_node
[2].block[2].name = Connect to controller server but request an invalid workflow
[2].block[2].workflow_launch.workflow_template = Does Not Exist
[2].block[2].ignore_errors = true
[2].block[2].register = result
[2].block[3].name = Assert that workflow launch failed with expected error
[2].block[3]["ansible.builtin.assert"].that[0] = result.failed | default(false)
[2].block[3]["ansible.builtin.assert"].that[1] = 'Unable to find workflow job template' in result.msg
[2].block[4].name = Run the workflow without waiting (this should just give us back a job ID)
[2].block[4].workflow_launch.workflow_template = {{ wfjt_name1 }}
[2].block[4].workflow_launch.wait = false
[2].block[4].ignore_errors = true
[2].block[4].register = result
[2].block[5].name = Assert result not failed
[2].block[5]["ansible.builtin.assert"].that[0] = result is not failed
[2].block[5]["ansible.builtin.assert"].that[1] = 'id' in result['job_info']
[2].block[6].name = Kick off a workflow and wait for it, but only for a second
[2].block[6].workflow_launch.workflow_template = {{ wfjt_name1 }}
[2].block[6].workflow_launch.timeout = 1
[2].block[6].ignore_errors = true
[2].block[6].register = result
[2].block[7].name = Assert result failed
[2].block[7]["ansible.builtin.assert"].that[0] = result.failed | default(false)
[2].block[7]["ansible.builtin.assert"].that[1] = 'Monitoring of Workflow Job - '~ wfjt_name1 ~ ' aborted due to timeout' in result.msg
[2].block[8].name = Kick off a workflow and wait for it
[2].block[8].workflow_launch.workflow_template = {{ wfjt_name1 }}
[2].block[8].ignore_errors = true
[2].block[8].register = result
[2].block[9].name = Assert result did not fail
[2].block[9]["ansible.builtin.assert"].that[0] = not (result.failed | default(false))
[2].block[9]["ansible.builtin.assert"].that[1] = 'id' in result['job_info']
[2].block[10].name = Kick off a workflow with extra_vars but not enabled
[2].block[10].workflow_launch.workflow_template = {{ wfjt_name1 }}
[2].block[10].workflow_launch.extra_vars.var1 = My First Variable
[2].block[10].workflow_launch.extra_vars.var2 = My Second Variable
[2].block[10].ignore_errors = true
[2].block[10].register = result
[2].block[11].name = Assert result failed
[2].block[11]["ansible.builtin.assert"].that[0] = result.failed | default(false)
[2].block[11]["ansible.builtin.assert"].that[1] = 'The field extra_vars was specified but the workflow job template does not allow for it to be overridden' in result.errors
[2].block[12].name = Prompt the workflow's with survey
[2].block[12].workflow_job_template.name = {{ wfjt_name1 }}
[2].block[12].workflow_job_template.state = present
[2].block[12].workflow_job_template.survey_enabled = true
[2].block[12].workflow_job_template.ask_variables_on_launch = false
[2].block[12].workflow_job_template.survey.name = 
[2].block[12].workflow_job_template.survey.description = 
[2].block[12].workflow_job_template.survey.spec[0].question_name = Basic Name
[2].block[12].workflow_job_template.survey.spec[0].question_description = Name
[2].block[12].workflow_job_template.survey.spec[0].required = true
[2].block[12].workflow_job_template.survey.spec[0].type = text
[2].block[12].workflow_job_template.survey.spec[0].variable = basic_name
[2].block[12].workflow_job_template.survey.spec[0].min = 0
[2].block[12].workflow_job_template.survey.spec[0].max = 1024
[2].block[12].workflow_job_template.survey.spec[0].default = 
[2].block[12].workflow_job_template.survey.spec[0].choices = 
[2].block[12].workflow_job_template.survey.spec[0].new_question = true
[2].block[12].workflow_job_template.survey.spec[1].question_name = Choose yes or no?
[2].block[12].workflow_job_template.survey.spec[1].question_description = Choosing yes or no.
[2].block[12].workflow_job_template.survey.spec[1].required = false
[2].block[12].workflow_job_template.survey.spec[1].type = multiplechoice
[2].block[12].workflow_job_template.survey.spec[1].variable = option_true_false
[2].block[12].workflow_job_template.survey.spec[1].min = null
[2].block[12].workflow_job_template.survey.spec[1].max = null
[2].block[12].workflow_job_template.survey.spec[1].default = yes
[2].block[12].workflow_job_template.survey.spec[1].choices = yes
no
[2].block[12].workflow_job_template.survey.spec[1].new_question = true
[2].block[13].name = Kick off a workflow with survey
[2].block[13].workflow_launch.workflow_template = {{ wfjt_name1 }}
[2].block[13].workflow_launch.extra_vars.basic_name = My First Variable
[2].block[13].workflow_launch.extra_vars.option_true_false = no
[2].block[13].ignore_errors = true
[2].block[13].register = result
[2].block[14].name = Assert result did not fail
[2].block[14]["ansible.builtin.assert"].that[0] = not (result.failed | default(false))
[2].block[15].name = Prompt the workflow's extra_vars on launch
[2].block[15].workflow_job_template.name = {{ wfjt_name1 }}
[2].block[15].workflow_job_template.state = present
[2].block[15].workflow_job_template.ask_variables_on_launch = true
[2].block[16].name = Kick off a workflow with extra_vars
[2].block[16].workflow_launch.workflow_template = {{ wfjt_name1 }}
[2].block[16].workflow_launch.extra_vars.basic_name = My First Variable
[2].block[16].workflow_launch.extra_vars.var1 = My First Variable
[2].block[16].workflow_launch.extra_vars.var2 = My Second Variable
[2].block[16].ignore_errors = true
[2].block[16].register = result
[2].block[17].name = Assert did not fail
[2].block[17]["ansible.builtin.assert"].that[0] = not (result.failed | default(false))
[2].block[18].name = Test waiting for an approval node that doesn't exit on the last workflow for failure.
[2].block[18].workflow_approval.workflow_job_id = {{ result.id }}
[2].block[18].workflow_approval.name = Test workflow approval
[2].block[18].workflow_approval.interval = 1
[2].block[18].workflow_approval.timeout = 2
[2].block[18].workflow_approval.action = deny
[2].block[18].register = result
[2].block[18].ignore_errors = true
[2].block[19].name = Assert result failed
[2].block[19]["ansible.builtin.assert"].that[0] = result.failed | default(false)
[2].block[19]["ansible.builtin.assert"].that[1] = 'Monitoring of Workflow Approval - Test workflow approval aborted due to timeout' in result.msg
[2].block[20].name = Create new Workflow
[2].block[20].workflow_job_template.name = {{ wfjt_name2 }}
[2].block[20].workflow_job_template.state = present
[2].block[21].name = Add a job node
[2].block[21].workflow_job_template_node.workflow_job_template = {{ wfjt_name2 }}
[2].block[21].workflow_job_template_node.unified_job_template = Demo Job Template
[2].block[21].workflow_job_template_node.identifier = leaf
[2].block[22].name = Create approval node
[2].block[22].workflow_job_template_node.identifier = approval_test
[2].block[22].workflow_job_template_node.approval_node.name = {{ approval_node_name }}
[2].block[22].workflow_job_template_node.approval_node.timeout = 900
[2].block[22].workflow_job_template_node.workflow = {{ wfjt_name2 }}
[2].block[23].name = Create link for approval node
[2].block[23].workflow_job_template_node.identifier = approval_test
[2].block[23].workflow_job_template_node.workflow = {{ wfjt_name2 }}
[2].block[23].workflow_job_template_node.always_nodes[0] = leaf
[2].block[24].name = Run the workflow without waiting This should pause waiting for approval
[2].block[24].workflow_launch.workflow_template = {{ wfjt_name2 }}
[2].block[24].workflow_launch.wait = false
[2].block[24].ignore_errors = true
[2].block[24].register = wfjt_info
[2].block[25].name = Wait for Job node wait to fail as it is waiting on approval
[2].block[25]["awx.awx.workflow_node_wait"].workflow_job_id = {{ wfjt_info.id }}
[2].block[25]["awx.awx.workflow_node_wait"].name = Demo Job Template
[2].block[25]["awx.awx.workflow_node_wait"].interval = 1
[2].block[25]["awx.awx.workflow_node_wait"].timeout = 5
[2].block[25].register = result
[2].block[25].ignore_errors = true
[2].block[26].name = Assert result didn't fail
[2].block[26]["ansible.builtin.assert"].that[0] = result.failed | default(false)
[2].block[26]["ansible.builtin.assert"].that[1] = 'Monitoring of Workflow Node - Demo Job Template aborted due to timeout' in result.msg
[2].block[27].name = Wait for approval node to activate and approve
[2].block[27]["awx.awx.workflow_approval"].workflow_job_id = {{ wfjt_info.id }}
[2].block[27]["awx.awx.workflow_approval"].name = {{ approval_node_name }}
[2].block[27]["awx.awx.workflow_approval"].interval = 1
[2].block[27]["awx.awx.workflow_approval"].timeout = 10
[2].block[27]["awx.awx.workflow_approval"].action = deny
[2].block[27].register = result
[2].block[28].name = Assert did not fail
[2].block[28]["ansible.builtin.assert"].that[0] = not (result.failed | default(false))
[2].block[28]["ansible.builtin.assert"].that[1] = result.changed | default(false)
[2].block[29].name = Wait for workflow job to finish max 120s
[2].block[29].job_wait.job_id = {{ wfjt_info.id }}
[2].block[29].job_wait.timeout = 120
[2].block[29].job_wait.job_type = workflow_jobs
[2].always[0].name = Clean up test workflow
[2].always[0].workflow_job_template.name = {{ item }}
[2].always[0].workflow_job_template.state = absent
[2].always[0].with_items[0] = {{ wfjt_name1 }}
[2].always[0].with_items[1] = {{ wfjt_name2 }}
