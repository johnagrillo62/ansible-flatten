~d0.name = Create global webroot directories if allowed
~d1.ansible.builtin.file = 
~d2.path = '{{ item.root | d("{}/sites/{}/{}".format(nginx_www + ("/" + item.owner if item.owner | d() else ""),
~d2.state = 'directory'
~d2.owner = '{{ item.owner | d(nginx_webroot_owner) }}'
~d2.group = '{{ item.group | d(item.owner | d(nginx_webroot_group)) }}'
~d2.mode = '{{ item.mode | d(nginx_webroot_mode) }}'
~d1.loop = '{{ q("flattened", nginx__servers
~d1.when = ((item.webroot_create | d(nginx_webroot_create) | bool) and
~d1.tags = [ 'role::nginx:servers' ]
~d0.name = Create default welcome page if enabled
~d1.ansible.builtin.template = 
~d2.src = '{{ lookup("debops.debops.template_src", (item.welcome_template | d(nginx_welcome_template))) }}'
~d2.dest = '{{ item.root + "/index.html"
~d2.owner = '{{ item.owner | d(nginx_webroot_owner) }}'
~d2.group = '{{ item.group | d(item.owner | d(nginx_webroot_group)) }}'
~d2.mode = '0644'
~d2.force = '{{ item.welcome_force | d() | bool }}'
~d1.loop = '{{ q("flattened", nginx__servers
~d1.when = ((item.webroot_create | d(nginx_webroot_create) | bool) and
~d1.tags = [ 'role::nginx:servers' ]
~d0.name = Copy 'normalize.css' CSS file for welcome page
~d1.ansible.builtin.template = 
~d2.src = '{{ lookup("debops.debops.template_src", "srv/www/sites/welcome/public/normalize.css") }}'
~d2.dest = '{{ item.root + "/normalize.css"
~d2.owner = '{{ item.owner | d(nginx_webroot_owner) }}'
~d2.group = '{{ item.group | d(item.owner | d(nginx_webroot_group)) }}'
~d2.mode = '0644'
~d2.force = '{{ item.welcome_force | d() | bool }}'
~d1.loop = '{{ q("flattened", nginx__servers
~d1.when = ((item.webroot_create | d(nginx_webroot_create) | bool) and
~d1.tags = [ 'role::nginx:servers' ]
~d0.name = Remove nginx server configuration if requested
~d1.ansible.builtin.file = 
~d2.path = '/etc/nginx/sites-available/{{ item.filename | d(item.name
~d2.state = 'absent'
~d1.loop = '{{ q("flattened", nginx__servers
~d1.when = (item.name is defined and
~d1.tags = [ 'role::nginx:servers' ]
~d0.name = Get last used HTTP default_server for default_server roulette
~d1.ansible.builtin.set_fact = 
~d2.nginx_register_default_server_saved = '{{ ansible_local.nginx.default_server }}'
~d1.when = (ansible_local is defined and ansible_local.nginx is defined and
~d1.tags = [ 'role::nginx:servers' ]
~d0.name = Get last used HTTPS default_server for default_server roulette
~d1.ansible.builtin.set_fact = 
~d2.nginx_register_default_server_ssl_saved = '{{ ansible_local.nginx.default_server_ssl }}'
~d1.when = (ansible_local is defined and ansible_local.nginx is defined and
~d1.tags = [ 'role::nginx:servers' ]
~d0.name = Get HTTP server from nginx defaults for default_server roulette
~d1.ansible.builtin.set_fact = 
~d2.nginx_register_default_server_name = '{{ nginx_default_name }}'
~d1.when = nginx_default_name is defined and nginx_default_name
~d1.tags = [ 'role::nginx:servers' ]
~d0.name = Get HTTPS server from nginx defaults for default_server roulette
~d1.ansible.builtin.set_fact = 
~d2.nginx_register_default_server_ssl_name = '{{ nginx_default_ssl_name }}'
~d1.when = nginx_default_ssl_name is defined and nginx_default_ssl_name
~d1.tags = [ 'role::nginx:servers' ]
~d0.name = Get first server that listens on http port for default_server roulette
~d1.ansible.builtin.set_fact = 
~d2.nginx_register_default_server_http = '{{ item.name if item.name is string else item.name[0] | d("default") }}'
~d1.loop = '{{ q("flattened", (nginx__servers + nginx__default_servers + nginx__internal_servers + nginx__dependent_servers
~d14.+ nginx_internal_servers | d([]) + nginx_dependent_servers | d([]))[ = :-1]) }}'
~d1.when = (item.state | d('present') != 'absent' and
~d1.tags = [ 'role::nginx:servers' ]
~d0.name = Get first server that listens on https port for default_server roulette
~d1.ansible.builtin.set_fact = 
~d2.nginx_register_default_server_https = '{{ item.name if item.name is string else item.name[0] | d("default") }}'
~d1.loop = '{{ q("flattened", (nginx__servers + nginx__default_servers + nginx__internal_servers + nginx__dependent_servers
~d14.+ nginx_internal_servers | d([]) + nginx_dependent_servers | d([]))[ = :-1]) }}'
~d1.when = (item.state | d('present') != 'absent' and (item.enabled is undefined or item.enabled | bool) and
~d1.tags = [ 'role::nginx:servers' ]
~d0.name = Spin the HTTP default_server roulette!
~d1.ansible.builtin.set_fact = 
~d2.nginx_register_default_server = '{{ nginx_register_default_server_saved |
~d1.tags = [ 'role::nginx:servers' ]
~d0.name = Spin the HTTPS default_server roulette!
~d1.ansible.builtin.set_fact = 
~d2.nginx_register_default_server_ssl = '{{ nginx_register_default_server_ssl_saved |
~d1.tags = [ 'role::nginx:servers' ]
~d0.name = Generate nginx server configuration
~d1.ansible.builtin.template = 
~d2.src = '{{ lookup("debops.debops.template_src", "etc/nginx/sites-available/" + (item.type | d(nginx_default_type)) + ".conf.j2") }}'
~d2.dest = '/etc/nginx/sites-available/{{ item.filename | d(item.name
~d2.owner = 'root'
~d2.group = 'root'
~d2.mode = '0644'
~d1.loop = '{{ q("flattened", nginx__servers
~d1.notify = [ 'Test nginx and reload' ]
~d1.when = (item.state | d('present') != 'absent' and
~d1.tags = [ 'role::nginx:servers' ]
~d0.name = Disable nginx server configuration
~d1.ansible.builtin.file = 
~d2.path = '/etc/nginx/sites-enabled/{{ item.filename
~d2.state = 'absent'
~d1.loop = '{{ q("flattened", nginx__servers
~d1.notify = [ 'Test nginx and restart' ]
~d1.when = (item.name is defined and
~d1.tags = [ 'role::nginx:servers' ]
~d0.name = Test if Ansible is running in check mode
~d1.ansible.builtin.command = /bin/true
~d1.changed_when = False
~d1.register = nginx__register_check_mode
~d1.tags = [ 'role::nginx:servers' ]
~d0.name = Save fact if Ansible is running in check mode in variable
~d1.ansible.builtin.set_fact = 
~d2.nginx__fact_check_mode = '{{ nginx__register_check_mode is skipped }}'
~d1.tags = [ 'role::nginx:servers' ]
~d0.name = Enable nginx server configuration
~d1.ansible.builtin.file = 
~d2.path = '/etc/nginx/sites-enabled/{{ item.filename
~d2.src = '/etc/nginx/sites-available/{{ item.filename
~d2.state = 'link'
~d2.owner = 'root'
~d2.group = 'root'
~d2.mode = '0644'
~d1.loop = '{{ q("flattened", nginx__servers
~d1.notify = [ 'Test nginx and restart' ]
~d1.when = (item.state | d('present') != 'absent' and
~d1.tags = [ 'role::nginx:servers' ]
