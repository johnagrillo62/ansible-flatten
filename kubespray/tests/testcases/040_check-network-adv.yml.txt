[0].name = Test tunl0 routes
[0].command = /sbin/ip route
[0].register = routes
[0].failed_when = routes.stdout_lines | select('contains', '/' ~ calico_pool_blocksize|d(26)) | select('contains', 'tunl0') | length == 0
[0].when[0] = ('kube_node' in group_names)
[0].when[1] = (calico_ipip_mode is defined and calico_ipip_mode != 'Never')
[0].when[2] = kube_network_plugin | default('calico') == 'calico'
[1].import_role.name = cluster-dump
[2].name = Wait for netchecker server
[2].command = {{ bin_dir }}/kubectl get pods --field-selector=status.phase==Running -o jsonpath-as-json={.items[*].metadata.name} --namespace {{ netcheck_namespace }}
[2].register = pods_json
[2].until[0] = pods_json.stdout | from_json | select('match', 'netchecker-server.*') | length == 1
[2].until[1] = (pods_json.stdout | from_json | select('match', 'netchecker-agent.*') | length) >= (groups['k8s_cluster'] | intersect(ansible_play_hosts) | length * 2)
[2].retries = 3
[2].delay = 10
[2].when = inventory_hostname == groups['kube_control_plane'][0]
[3].name = Get netchecker pods
[3].command = {{ bin_dir }}/kubectl -n {{ netcheck_namespace }} describe pod -l app={{ item }}
[3].run_once = true
[3].delegate_to = {{ groups['kube_control_plane'][0] }}
[3].with_items[0] = netchecker-agent
[3].with_items[1] = netchecker-agent-hostnet
[3].when = not pods_json is success
[4].name = Perform netchecker tests
[4].run_once = true
[4].delegate_to = {{ groups['kube_control_plane'][0] }}
[4].block[0].name = Get netchecker agents
[4].block[0].uri.url = http://{{ (ansible_default_ipv6.address if not (ipv4_stack | default(true)) else ansible_default_ipv4.address) | ansible.utils.ipwrap }}:{{ netchecker_port }}/api/v1/agents/
[4].block[0].uri.return_content = true
[4].block[0].uri.headers.Accept = application/json
[4].block[0].register = agents
[4].block[0].retries = 18
[4].block[0].delay = {{ agent_report_interval }}
[4].block[0].until[0] = agents is success
[4].block[0].until[1] = (agents.content | from_json | length) == (groups['k8s_cluster'] | length * 2)
[4].block[1].name = Check netchecker status
[4].block[1].uri.url = http://{{ (ansible_default_ipv6.address if not (ipv4_stack | default(true)) else ansible_default_ipv4.address) | ansible.utils.ipwrap }}:{{ netchecker_port }}/api/v1/connectivity_check
[4].block[1].uri.return_content = true
[4].block[1].uri.headers.Accept = application/json
[4].block[1].register = connectivity_check
[4].block[1].retries = 3
[4].block[1].delay = {{ agent_report_interval }}
[4].block[1].until[0] = connectivity_check is success
[4].block[1].until[1] = connectivity_check.content | from_json
[4].rescue[0].name = Get kube-proxy logs
[4].rescue[0].command = {{ bin_dir }}/kubectl -n kube-system logs -l k8s-app=kube-proxy
[4].rescue[1].name = Get logs from other apps
[4].rescue[1].command = {{ bin_dir }}/kubectl -n kube-system logs -l k8s-app={{ item }} --all-containers
[4].rescue[1].with_items[0] = kube-router
[4].rescue[1].with_items[1] = flannel
[4].rescue[1].with_items[2] = canal-node
[4].rescue[1].with_items[3] = calico-node
[4].rescue[1].with_items[4] = cilium
[4].rescue[2].name = Netchecker tests failed
[4].rescue[2].fail.msg = netchecker tests failed
[5].name = Check connectivity with all netchecker agents
[5].vars.connectivity_check_result = {{ connectivity_check.content | from_json }}
[5].vars.agents_check_result = {{ agents.content | from_json }}
[5].assert.that[0] = agents_check_result is defined
[5].assert.that[1] = connectivity_check_result is defined
[5].assert.that[2] = agents_check_result.keys() | length > 0
[5].assert.that[3] = not connectivity_check_result.Absent
[5].assert.that[4] = not connectivity_check_result.Outdated
[5].assert.msg = Connectivity check to netchecker agents failed
[5].delegate_to = {{ groups['kube_control_plane'][0] }}
[5].run_once = true
[6].name = Create macvlan network conf
[6].command.cmd = {{ bin_dir }}/kubectl create -f -
[6].command.stdin = apiVersion: "k8s.cni.cncf.io/v1"
kind: NetworkAttachmentDefinition
metadata:
  name: macvlan-conf
spec:
  config: '{
    "cniVersion": "0.4.0",
    "type": "macvlan",
    "master": "eth0",
    "mode": "bridge",
    "ipam": {
      "type": "host-local",
      "subnet": "192.168.1.0/24",
      "rangeStart": "192.168.1.200",
      "rangeEnd": "192.168.1.216",
      "routes": [
        { "dst": "0.0.0.0/0" }
      ],
    "gateway": "192.168.1.1"
  }
}'
---
apiVersion: v1
kind: Pod
metadata:
  name: samplepod
  annotations:
    k8s.v1.cni.cncf.io/networks: macvlan-conf
spec:
  containers:
  - name: samplepod
    command: ["/bin/bash", "-c", "sleep 2000000000000"]
    image: dougbtv/centos-network

[6].delegate_to = groups['kube_control_plane'][0]
[6].run_once = true
[6].when[0] = kube_network_plugin_multus | default(false) | bool
[7].name = Check secondary macvlan interface
[7].command = {{ bin_dir }}/kubectl exec samplepod -- ip addr show dev net1
[7].register = output
[7].until = output.rc == 0
[7].retries = 90
[7].changed_when = false
[7].delegate_to = groups['kube_control_plane'][0]
[7].run_once = true
[7].when[0] = kube_network_plugin_multus | default(false) | bool
