[0].name = Import custom Ansible plugins
[0]["ansible.builtin.import_role"].name = ansible_plugins
[1].name = Import DebOps global handlers
[1]["ansible.builtin.import_role"].name = global_handlers
[2].name = Import DebOps secret role
[2]["ansible.builtin.import_role"].name = secret
[3].name = Install Zabbix agent packages
[3]["ansible.builtin.apt"].name = {{ (zabbix_agent__base_packages
             + zabbix_agent__packages) | flatten }}
[3]["ansible.builtin.apt"].state = {{ zabbix_agent__deploy_state }}
[3]["ansible.builtin.apt"].purge = True
[3].register = zabbix_agent__register_packages
[3].until = zabbix_agent__register_packages is succeeded
[4].name = Add Zabbix UNIX account to required groups
[4]["ansible.builtin.user"].name = {{ zabbix_agent__user }}
[4]["ansible.builtin.user"].groups = {{ zabbix_agent__additional_groups | flatten | join(",") }}
[4]["ansible.builtin.user"].state = present
[4]["ansible.builtin.user"].append = True
[4].notify[0] = Check zabbix-agent and restart
[4].notify[1] = Check zabbix-agent2 and restart
[4].when = zabbix_agent__deploy_state != 'absent'
[5].name = Divert Zabbix agent configuration file
[5]["debops.debops.dpkg_divert"].path = {{ zabbix_agent__conf_file_path }}
[5]["debops.debops.dpkg_divert"].state = present
[5].notify[0] = Check zabbix-agent and restart
[5].notify[1] = Check zabbix-agent2 and restart
[5].when = zabbix_agent__deploy_state != 'absent'
[6].name = Generate Zabbix agent configuration file
[6]["ansible.builtin.template"].src = etc/zabbix/zabbix_agentd.conf.j2
[6]["ansible.builtin.template"].dest = {{ zabbix_agent__conf_file_path }}
[6]["ansible.builtin.template"].owner = root
[6]["ansible.builtin.template"].group = {{ zabbix_agent__group }}
[6]["ansible.builtin.template"].mode = 0640
[6]["ansible.builtin.template"].unsafe_writes = {{ True if (core__unsafe_writes | d(ansible_local.core.unsafe_writes | d()) | bool) else omit }}
[6].notify[0] = Check zabbix-agent and restart
[6].notify[1] = Check zabbix-agent2 and restart
[6].when = zabbix_agent__deploy_state != 'absent'
[7].name = Install secret key
[7]["ansible.builtin.copy"].content = {{ zabbix_agent__tls_psk_secret }}
[7]["ansible.builtin.copy"].dest = /etc/zabbix/secret.key
[7]["ansible.builtin.copy"].owner = root
[7]["ansible.builtin.copy"].group = {{ zabbix_agent__group }}
[7]["ansible.builtin.copy"].mode = 0640
[7].no_log = {{ debops__no_log | d(True) }}
[7].notify[0] = Check zabbix-agent and restart
[7].notify[1] = Check zabbix-agent2 and restart
[7].when = zabbix_agent__deploy_state != 'absent'
[8].name = Ensure configuration folder exists
[8]["ansible.builtin.file"].path = /etc/zabbix/zabbix_agentd.conf.d
[8]["ansible.builtin.file"].state = directory
[8]["ansible.builtin.file"].owner = root
[8]["ansible.builtin.file"].group = root
[8]["ansible.builtin.file"].mode = 0755
[8].when = zabbix_agent__deploy_state != 'absent' and zabbix_agent__flavor == 'C'
[9].name = Ensure log folder exists
[9]["ansible.builtin.file"].path = /var/log/zabbix-agent
[9]["ansible.builtin.file"].state = directory
[9]["ansible.builtin.file"].owner = {{ zabbix_agent__user }}
[9]["ansible.builtin.file"].group = {{ zabbix_agent__group }}
[9]["ansible.builtin.file"].mode = 0755
[9].when = zabbix_agent__deploy_state != 'absent' and zabbix_agent__flavor == 'C'
[10].name = Make sure that Ansible local fact directory exists
[10]["ansible.builtin.file"].path = /etc/ansible/facts.d
[10]["ansible.builtin.file"].state = directory
[10]["ansible.builtin.file"].owner = root
[10]["ansible.builtin.file"].group = root
[10]["ansible.builtin.file"].mode = 0755
[10].when = zabbix_agent__deploy_state != 'absent'
[11].name = Create local facts of Zabbix agent
[11]["ansible.builtin.template"].src = etc/ansible/facts.d/zabbix_agent.fact.j2
[11]["ansible.builtin.template"].dest = /etc/ansible/facts.d/zabbix_agent.fact
[11]["ansible.builtin.template"].owner = root
[11]["ansible.builtin.template"].group = root
[11]["ansible.builtin.template"].mode = 0755
[11]["ansible.builtin.template"].unsafe_writes = {{ True if (core__unsafe_writes | d(ansible_local.core.unsafe_writes | d()) | bool) else omit }}
[11].notify[0] = Refresh host facts
[11].when = zabbix_agent__deploy_state != 'absent'
[11].tags[0] = meta::facts
[12].name = Prepare cleanup during package removal
[12]["ansible.builtin.import_role"].name = dpkg_cleanup
[12].vars.dpkg_cleanup__dependent_packages[0] = {{ zabbix_agent__dpkg_cleanup__dependent_packages }}
[12].when = zabbix_agent__deploy_state != 'absent'
[12].tags[0] = role::dpkg_cleanup
[12].tags[1] = skip::dpkg_cleanup
[12].tags[2] = role::zabbix_agent:dpkg_cleanup
[13].name = Reload facts if they were modified
[13]["ansible.builtin.meta"] = flush_handlers
