phpipam__mode[0] = webui
phpipam__mode[1] = scripts
phpipam__fqdn = ipam.{{ ansible_domain }}
phpipam__nginx_auth_realm = IPAM access is restricted
phpipam__nginx_access_policy = 
phpipam__webserver_user = {{ ansible_local.nginx.user
                             if (ansible_local is defined and
                                 ansible_local.nginx is defined and
                                 ansible_local.nginx.user is defined)
                             else "www-data" }}

phpipam__user = phpipam
phpipam__group = phpipam
phpipam__home = {{ (ansible_local.fhs.home | d("/var/local"))
                   + "/" + phpipam__user }} 
phpipam__database_user = phpipam
phpipam__database_host = {{ ansible_local.mariadb.server }}
phpipam__database_name = phpipam
phpipam__database_password = {{ lookup('password', secret + '/mariadb/' +
                                ansible_local.mariadb.delegate_to +
                                '/credentials/' + phpipam__database_user +
                                '/password length=48') }}

phpipam__database_schema = {{ phpipam__git_checkout + "/db/SCHEMA.sql" }}
phpipam__src = {{ (ansible_local.fhs.src | d("/usr/local/src"))
                  + "/" + phpipam__user }} 
phpipam__www = {{ (ansible_local.nginx.www
                  if (ansible_local is defined and
                      ansible_local.nginx is defined and
                      ansible_local.nginx.www is defined)
                  else "/srv/www") + "/" + phpipam__user }}

phpipam__git_repo = https://github.com/phpipam/phpipam.git
phpipam__git_dest = {{ phpipam__src + "/" + phpipam__git_repo.split("://")[1] }}
phpipam__git_version = v1.4.1
phpipam__git_checkout = {{ phpipam__www + "/sites/" + phpipam__fqdn + "/public" }}
phpipam__php_session_name = {{ lookup('password', secret + '/credentials/'
                               + inventory_hostname + '/phpipam/php_session_name
                               chars=hexdigits length=30') }}

phpipam__scripts_git_repo = https://github.com/debops/phpipam-scripts
phpipam__scripts_git_dest = {{ "/usr/local/src/phpipam/" + phpipam__scripts_git_repo.split("://")[1] }}
phpipam__scripts_git_version = master
phpipam__scripts_database_user = {{ phpipam__database_user }}
phpipam__scripts_database_host = {{ phpipam__database_host }}
phpipam__scripts_database_name = {{ phpipam__database_name }}
phpipam__scripts_database_password = {{ phpipam__database_password }}
phpipam__scripts_config_output = /etc/dhcp/dhcpd-hosts.conf
phpipam__scripts_config_restart_command = /etc/init.d/isc-dhcp-server restart
phpipam__scripts_config_groups.hosts.sections = {{ phpipam__scripts_config_sections }}
phpipam__scripts_config_groups.hosts.subnets = {{ phpipam__scripts_config_subnets }}
phpipam__scripts_config_groups.hosts.active = true
phpipam__scripts_config_groups.hosts.reserved = false
phpipam__scripts_config_groups.hosts.offline = false
phpipam__scripts_config_groups.hosts.dhcp = false
phpipam__scripts_config_groups.hosts.output = {{ phpipam__scripts_config_output }}
phpipam__scripts_config_groups.hosts.restart_command = {{ phpipam__scripts_config_restart_command }}
phpipam__scripts_config_groups.hosts.restart = true
phpipam__scripts_cron_period = */5
phpipam__php__dependent_packages[0] = mysql
phpipam__php__dependent_packages[1] = gmp
phpipam__php__dependent_packages[2] = gd
phpipam__php__dependent_packages[3] = curl
phpipam__php__dependent_packages[4] = mcrypt
phpipam__php__dependent_packages[5] = ldap
phpipam__php__dependent_packages[6] = php-pear
phpipam__php__dependent_pools[0].name = phpipam
phpipam__php__dependent_pools[0].enabled = True
phpipam__php__dependent_pools[0].user = {{ phpipam__user }}
phpipam__php__dependent_pools[0].group = {{ phpipam__group }}
phpipam__php__dependent_pools[0].owner = {{ phpipam__user }}
phpipam__php__dependent_pools[0].home = {{ phpipam__home }}
phpipam__nginx__dependent_upstreams[0].name = php_phpipam
phpipam__nginx__dependent_upstreams[0].by_role = debops.phpipam
phpipam__nginx__dependent_upstreams[0].enabled = True
phpipam__nginx__dependent_upstreams[0].type = php
phpipam__nginx__dependent_upstreams[0].php_pool = phpipam
phpipam__nginx__dependent_servers[0].name = {{ phpipam__fqdn }}
phpipam__nginx__dependent_servers[0].by_role = debops.phpipam
phpipam__nginx__dependent_servers[0].enabled = True
phpipam__nginx__dependent_servers[0].type = php
phpipam__nginx__dependent_servers[0].root = {{ phpipam__git_checkout }}
phpipam__nginx__dependent_servers[0].webroot_create = False
phpipam__nginx__dependent_servers[0].access_policy = {{ phpipam__nginx_access_policy }}
phpipam__nginx__dependent_servers[0].auth_basic_realm = {{ phpipam__nginx_auth_realm }}
phpipam__nginx__dependent_servers[0].php_upstream = php_phpipam
phpipam__nginx__dependent_servers[0].error_pages.400 = /index.php?page=error&section=400
phpipam__nginx__dependent_servers[0].error_pages.401 = /index.php?page=error&section=401
phpipam__nginx__dependent_servers[0].error_pages.403 = /index.php?page=error&section=403
phpipam__nginx__dependent_servers[0].error_pages.404 = /index.php?page=error&section=404
phpipam__nginx__dependent_servers[0].error_pages.500 = /index.php?page=error&section=500
phpipam__nginx__dependent_servers[0].location./api = try_files $uri $uri/ /api/index.php?$args =404;

phpipam__nginx__dependent_servers[0].location./ = rewrite ^/login/dashboard/$                 /dashboard/ redirect;
rewrite ^/logout/dashboard/$                /dashboard/ redirect;
rewrite ^/tools/search/(.*)/(.*)/(.*)/(.*)$ /index.php?page=tools&section=search&addresses=$1&subnets=$2&vlans=$3&ip=$4 last;
rewrite ^/(.*)/(.*)/(.*)/(.*)/(.*)/$        /index.php?page=$1&section=$2&subnetId=$3&sPage=$4&ipaddrid=$5 last;
rewrite ^/(.*)/(.*)/(.*)/(.*)/$             /index.php?page=$1&section=$2&subnetId=$3&sPage=$4 last;
rewrite ^/(.*)/(.*)/(.*)/$                  /index.php?page=$1&section=$2&subnetId=$3 last;
rewrite ^/(.*)/(.*)/$                       /index.php?page=$1&section=$2 last;
rewrite ^/(.*)/$                            /index.php?page=$1 last;
try_files $uri $uri/ $uri.html $uri.htm /index.html /index.htm =404;

phpipam__mariadb__dependent_users[0].database = {{ phpipam__database_name }}
phpipam__mariadb__dependent_users[0].user = {{ phpipam__database_user }}
phpipam__mariadb__dependent_users[0].owner = {{ phpipam__user }}
phpipam__mariadb__dependent_users[0].group = {{ phpipam__group }}
phpipam__mariadb__dependent_users[0].home = {{ phpipam__home }}
phpipam__mariadb__dependent_users[0].system = True
