[0].name = Import custom Ansible plugins
[0]["ansible.builtin.import_role"].name = ansible_plugins
[1].name = Import DebOps global handlers
[1]["ansible.builtin.import_role"].name = global_handlers
[2].name = Import DebOps secret role
[2]["ansible.builtin.import_role"].name = secret
[3].name = Install required packages
[3]["ansible.builtin.package"].name = {{ q("flattened", (sysfs__base_packages
                              + sysfs__packages)) }}
[3]["ansible.builtin.package"].state = present
[3].register = sysfs__register_packages
[3].until = sysfs__register_packages is succeeded
[3].when = sysfs__enabled | bool
[4].name = Check if the dependent configuration exists
[4]["ansible.builtin.stat"].path = {{ secret + "/sysfs/dependent_config/" + inventory_hostname + "/attributes.json" }}
[4].register = sysfs__register_dependent_attributes_file
[4].become = False
[4].delegate_to = localhost
[4].when = (sysfs__enabled | bool and ansible_local | d() and ansible_local.sysfs | d() and (ansible_local.sysfs.configured | d()) | bool)
[5].name = Load the dependent configuration from Ansible Controller
[5]["ansible.builtin.slurp"].src = {{ secret + "/sysfs/dependent_config/" + inventory_hostname + "/attributes.json" }}
[5].register = sysfs__register_dependent_attributes
[5].become = False
[5].delegate_to = localhost
[5].when = (sysfs__enabled | bool and ansible_local | d() and ansible_local.sysfs | d() and (ansible_local.sysfs.configured | d()) | bool and sysfs__register_dependent_attributes_file.stat.exists | bool)
[6].name = Remove sysfs configuration files if requested
[6]["ansible.builtin.file"].path = /etc/sysfs.d/{{ item.filename | d(item.name | replace("/", "_")) }}.conf
[6]["ansible.builtin.file"].state = absent
[6].with_items = {{ sysfs__combined_attributes | debops.debops.parse_kv_items }}
[6].notify[0] = Restart sysfsutils
[6].when = (sysfs__enabled | bool and item.name | d() and item.state | d('present') == 'absent')
[7].name = Generate sysfs configuration files
[7]["ansible.builtin.template"].src = etc/sysfs.d/attribute.conf.j2
[7]["ansible.builtin.template"].dest = /etc/sysfs.d/{{ item.filename | d(item.name | replace("/", "_")) }}.conf
[7]["ansible.builtin.template"].owner = root
[7]["ansible.builtin.template"].group = root
[7]["ansible.builtin.template"].mode = 0644
[7].with_items = {{ sysfs__combined_attributes | debops.debops.parse_kv_items }}
[7].notify[0] = Restart sysfsutils
[7].when = (sysfs__enabled | bool and item.name | d() and item.state | d('present') not in ['defined', 'absent'])
[8].name = Make sure that Ansible local facts directory exists
[8]["ansible.builtin.file"].path = /etc/ansible/facts.d
[8]["ansible.builtin.file"].state = directory
[8]["ansible.builtin.file"].owner = root
[8]["ansible.builtin.file"].group = root
[8]["ansible.builtin.file"].mode = 0755
[9].name = Save sysfs local facts
[9]["ansible.builtin.template"].src = etc/ansible/facts.d/sysfs.fact.j2
[9]["ansible.builtin.template"].dest = /etc/ansible/facts.d/sysfs.fact
[9]["ansible.builtin.template"].owner = root
[9]["ansible.builtin.template"].group = root
[9]["ansible.builtin.template"].mode = 0755
[9].notify[0] = Refresh host facts
[9].tags[0] = meta::facts
[10].name = Update Ansible facts if they were modified
[10]["ansible.builtin.meta"] = flush_handlers
[11].name = Save dependent configuration on Ansible Controller
[11]["ansible.builtin.template"].src = secret/sysfs/dependent_config/inventory_hostname/attributes.json.j2
[11]["ansible.builtin.template"].dest = {{ secret + "/sysfs/dependent_config/" + inventory_hostname + "/attributes.json" }}
[11]["ansible.builtin.template"].mode = 0644
[11].become = False
[11].delegate_to = localhost
[11].when = sysfs__enabled | bool
