kibana__base_packages[0] = kibana
kibana__version = {{ ansible_local.kibana.version | d("0.0.0") }}
kibana__user = kibana
kibana__group = kibana
kibana__additional_groups = {{ ["ssl-cert"]
                               if kibana__pki_enabled | bool
                               else [] }}

kibana__keystore_path = {{ "/var/lib/kibana/kibana.keystore"
                           if (kibana__version is version("7.0.0", "<"))
                           else "/etc/kibana/kibana.keystore" }}

kibana__fqdn = kibana.{{ kibana__domain }}
kibana__domain = {{ ansible_domain }}
kibana__webserver_access_policy = 
kibana__webserver_auth_basic_realm = Access to Kibana is restricted
kibana__webserver_auth_basic_filename = 
kibana__server_host = localhost
kibana__server_port = 5601
kibana__server_name = {{ kibana__fqdn }}
kibana__elasticsearch_url = http://localhost:9200
kibana__elasticsearch_hosts[0] = http://localhost:9200
kibana__elasticsearch_cluster_name = {{ kibana__domain | replace(".", "-") }}
kibana__elasticsearch_username = {{ ""
                                    if (kibana__elasticsearch_hosts[0].startswith("http://"))
                                    else ("kibana"
                                          if (kibana__version is version("7.0.0", "<"))
                                          else "kibana_system") }}

kibana__elasticsearch_secret_path = {{ "elasticsearch/credentials/"
                                       + kibana__elasticsearch_cluster_name
                                       + "/built-in" }}

kibana__elasticsearch_password = {{ ""
                                    if (kibana__elasticsearch_hosts[0].startswith("http://"))
                                    else (lookup("password", secret + "/"
                                          + kibana__elasticsearch_secret_path + "/"
                                          + kibana__elasticsearch_username
                                          + "/password")) }}

kibana__index = .kibana
kibana__default_app_id = discover
kibana__security_encryption_key = {{ lookup("password", secret
                                            + "/kibana/security_encryption_key length=32") }} 
kibana__reporting_encryption_key = {{ lookup("password", secret
                                             + "/kibana/reporting_encryption_key length=32") }} 
kibana__secure_connection = {{ True
                               if (kibana__elasticsearch_username | d() and
                                   kibana__elasticsearch_password | d())
                               else False }}

kibana__pki_enabled = {{ (ansible_local.pki.enabled | d()) | bool }}
kibana__pki_base_path = {{ ansible_local.pki.base_path | d("/etc/pki/realms") }}
kibana__pki_realm = {{ ansible_local.pki.realm | d("domain") }}
kibana__pki_ca_file = {{ ansible_local.pki.ca | d("CA.crt") }}
kibana__pki_key_file = {{ ansible_local.pki.key | d("default.key") }}
kibana__pki_crt_file = public/cert_intermediate.pem
kibana__tls_ca_certificate = {{ kibana__pki_base_path + "/"
                                + kibana__pki_realm + "/"
                                + kibana__pki_ca_file }}

kibana__tls_private_key = {{ kibana__pki_base_path + "/"
                             + kibana__pki_realm + "/"
                             + kibana__pki_key_file }}

kibana__tls_certificate = {{ kibana__pki_base_path + "/"
                             + kibana__pki_realm + "/"
                             + kibana__pki_crt_file }}

kibana__default_configuration[0].name = server.port
kibana__default_configuration[0].value = {{ kibana__server_port }}
kibana__default_configuration[0].comment = Kibana is served by a back end server. This setting specifies the port to use
kibana__default_configuration[1].name = server.host
kibana__default_configuration[1].value = {{ kibana__server_host }}
kibana__default_configuration[1].comment = Specifies the address to which the Kibana server will bind. IP addresses and host names are both valid values.
The default is 'localhost', which usually means remote machines will not be able to connect.
To allow connections from remote users, set this parameter to a non-loopback address.

kibana__default_configuration[2].name = server.name
kibana__default_configuration[2].value = {{ kibana__server_name }}
kibana__default_configuration[2].comment = The Kibana server's name. This is used for display purposes
kibana__default_configuration[3].name = server.basePath
kibana__default_configuration[3].value = 
kibana__default_configuration[3].state = comment
kibana__default_configuration[3].comment = Enables you to specify a path to mount Kibana at if you are running behind a proxy. This only affects
the URLs generated by Kibana, your proxy is expected to remove the basePath value before forwarding requests
to Kibana. This setting cannot end in a slash.

kibana__default_configuration[4].name = server.publicBaseUrl
kibana__default_configuration[4].value = {{ "https://" + ansible_fqdn }}
kibana__default_configuration[4].comment = Specifies the public URL at which Kibana is available for end users. If
`server.basePath` is configured this URL should end with the same basePath.

kibana__default_configuration[4].state = {{ "present"
               if (kibana__version is version("7.0.0", ">="))
               else "absent" }}

kibana__default_configuration[5].name = server.maxPayloadBytes
kibana__default_configuration[5].value = 1048576
kibana__default_configuration[5].state = comment
kibana__default_configuration[5].comment = The maximum payload size in bytes for incoming server requests
kibana__default_configuration[6].name = kibana.index
kibana__default_configuration[6].value = {{ kibana__index }}
kibana__default_configuration[6].comment = Kibana uses an index in Elasticsearch to store saved searches, visualizations and
dashboards. Kibana creates a new index if the index doesn't already exist.

kibana__default_configuration[6].state = {{ "present"
               if (kibana__version is version("7.11.0", "<"))
               else "absent" }}

kibana__default_configuration[7].name = kibana.defaultAppId
kibana__default_configuration[7].value = {{ kibana__default_app_id }}
kibana__default_configuration[7].comment = The default application to load
kibana__default_configuration[7].state = {{ "present"
               if (kibana__version is version("7.9.0", "<"))
               else "absent" }}

kibana__default_configuration[8].name = elasticsearch.url
kibana__default_configuration[8].value = {{ kibana__elasticsearch_url }}
kibana__default_configuration[8].comment = The URL of the Elasticsearch instance to use for all your queries
kibana__default_configuration[8].state = {{ "present"
               if (kibana__version is version("7.0.0", "<"))
               else "absent" }}

kibana__default_configuration[9].name = elasticsearch.hosts
kibana__default_configuration[9].value = {{ kibana__elasticsearch_hosts }}
kibana__default_configuration[9].comment = The URLs of the Elasticsearch instances to use for all your queries
kibana__default_configuration[9].state = {{ "absent"
               if (kibana__version is version("7.0.0", "<"))
               else "present" }}

kibana__default_configuration[10].name = elasticsearch.preserveHost
kibana__default_configuration[10].value = True
kibana__default_configuration[10].state = comment
kibana__default_configuration[10].comment = When value of this option is true Kibana uses the hostname specified in the server.host
setting. When the value of this setting is false, Kibana uses the hostname of the host
that connects to this Kibana instance.

kibana__default_configuration[11].name = elasticsearch.username
kibana__default_configuration[11].value = {{ kibana__elasticsearch_username }}
kibana__default_configuration[11].state = {{ "present"
               if (kibana__elasticsearch_username | d() and
                   kibana__elasticsearch_password | d())
               else "comment" }}

kibana__default_configuration[11].comment = If your Elasticsearch is protected with basic authentication, these settings provide
the username and password that the Kibana server uses to perform maintenance on the Kibana
index at startup. Your Kibana users still need to authenticate with Elasticsearch, which
is proxied through the Kibana server.

kibana__default_configuration[12].name = elasticsearch.password
kibana__default_configuration[12].value = {{ kibana__elasticsearch_password }}
kibana__default_configuration[12].state = {{ "present"
               if (kibana__elasticsearch_username | d() and
                   kibana__elasticsearch_password | d())
               else "comment" }}

kibana__default_configuration[13].name = server.ssl.enabled
kibana__default_configuration[13].value = False
kibana__default_configuration[13].state = comment
kibana__default_configuration[13].comment = Enables SSL and paths to the PEM-format SSL certificate and SSL key files, respectively.
These settings enable SSL for outgoing requests from the Kibana server to the browser.

kibana__default_configuration[14].name = server.ssl.certificate
kibana__default_configuration[14].value = /path/to/your/server.crt
kibana__default_configuration[14].state = comment
kibana__default_configuration[15].name = server.ssl.key
kibana__default_configuration[15].value = /path/to/your/server.key
kibana__default_configuration[15].state = comment
kibana__default_configuration[16].name = elasticsearch.ssl.certificate
kibana__default_configuration[16].value = /path/to/your/client.crt
kibana__default_configuration[16].state = comment
kibana__default_configuration[16].comment = Optional settings that provide the paths to the PEM-format SSL certificate and key files.
These files validate that your Elasticsearch backend uses the same key files.

kibana__default_configuration[17].name = elasticsearch.ssl.key
kibana__default_configuration[17].value = /path/to/your/client.key
kibana__default_configuration[17].state = comment
kibana__default_configuration[18].name = elasticsearch.ssl.certificateAuthorities
kibana__default_configuration[18].value[0] = /path/to/your/CA.pem
kibana__default_configuration[18].state = comment
kibana__default_configuration[18].comment = Optional setting that enables you to specify a path to the PEM file for the certificate
authority for your Elasticsearch instance.

kibana__default_configuration[19].name = elasticsearch.ssl.certificateAuthorities
kibana__default_configuration[19].value = 
kibana__default_configuration[19].state = {{ "present" if (kibana__secure_connection | bool and
                             kibana__pki_enabled | bool)
                         else "ignore" }}

kibana__default_configuration[20].name = elasticsearch.ssl.certificateAuthorities
kibana__default_configuration[20].value[0] = {{ kibana__tls_ca_certificate }}
kibana__default_configuration[20].state = {{ "present" if (kibana__secure_connection | bool and
                             kibana__pki_enabled | bool)
                         else "ignore" }}

kibana__default_configuration[21].name = elasticsearch.ssl.certificate
kibana__default_configuration[21].value = {{ kibana__tls_certificate }}
kibana__default_configuration[21].state = {{ "present" if (kibana__secure_connection | bool and
                             kibana__pki_enabled | bool)
                         else "ignore" }}

kibana__default_configuration[22].name = elasticsearch.ssl.key
kibana__default_configuration[22].value = {{ kibana__tls_private_key }}
kibana__default_configuration[22].state = {{ "present" if (kibana__secure_connection | bool and
                             kibana__pki_enabled | bool)
                         else "ignore" }}

kibana__default_configuration[23].name = elasticsearch.ssl.verificationMode
kibana__default_configuration[23].value = full
kibana__default_configuration[23].state = comment
kibana__default_configuration[23].comment = To disregard the validity of SSL certificates, change this setting's value to 'none'
kibana__default_configuration[24].name = elasticsearch.pingTimeout
kibana__default_configuration[24].value = 1500
kibana__default_configuration[24].state = comment
kibana__default_configuration[24].comment = Time in milliseconds to wait for Elasticsearch to respond to pings. Defaults to the value of
the elasticsearch.requestTimeout setting.

kibana__default_configuration[25].name = elasticsearch.requestTimeout
kibana__default_configuration[25].value = 30000
kibana__default_configuration[25].state = comment
kibana__default_configuration[25].comment = Time in milliseconds to wait for responses from the back end or Elasticsearch. This value
must be a positive integer.

kibana__default_configuration[26].name = elasticsearch.requestHeadersWhitelist
kibana__default_configuration[26].value[0] = authorization
kibana__default_configuration[26].state = comment
kibana__default_configuration[26].comment = List of Kibana client-side headers to send to Elasticsearch. To send *no* client-side
headers, set this value to [] (an empty list).

kibana__default_configuration[27].name = elasticsearch.customHeaders
kibana__default_configuration[27].state = comment
kibana__default_configuration[27].comment = Header names and values that are sent to Elasticsearch. Any custom headers cannot be overwritten
by client-side headers, regardless of the elasticsearch.requestHeadersWhitelist configuration.

kibana__default_configuration[28].name = elasticsearch.shardTimeout
kibana__default_configuration[28].value = 0
kibana__default_configuration[28].state = comment
kibana__default_configuration[28].comment = Time in milliseconds for Elasticsearch to wait for responses from shards. Set to 0 to disable
kibana__default_configuration[29].name = elasticsearch.startupTimeout
kibana__default_configuration[29].value = 5000
kibana__default_configuration[29].state = comment
kibana__default_configuration[29].comment = Time in milliseconds to wait for Elasticsearch at Kibana startup before retrying
kibana__default_configuration[30].name = pid.file
kibana__default_configuration[30].value = /var/run/kibana.pid
kibana__default_configuration[30].state = comment
kibana__default_configuration[30].comment = Specifies the path where Kibana creates the process ID file
kibana__default_configuration[31].name = logging.dest
kibana__default_configuration[31].value = stdout
kibana__default_configuration[31].state = comment
kibana__default_configuration[31].comment = Enables you specify a file where Kibana stores log output
kibana__default_configuration[32].name = logging.silent
kibana__default_configuration[32].value = False
kibana__default_configuration[32].state = comment
kibana__default_configuration[32].comment = Set the value of this setting to true to suppress all logging output
kibana__default_configuration[33].name = logging.quiet
kibana__default_configuration[33].value = False
kibana__default_configuration[33].state = comment
kibana__default_configuration[33].comment = Set the value of this setting to true to suppress all logging output other than error messages
kibana__default_configuration[34].name = logging.verbose
kibana__default_configuration[34].value = False
kibana__default_configuration[34].state = comment
kibana__default_configuration[34].comment = Set the value of this setting to true to log all events, including system usage information
and all requests.

kibana__default_configuration[35].name = ops.interval
kibana__default_configuration[35].value = 5000
kibana__default_configuration[35].state = comment
kibana__default_configuration[35].comment = Set the interval in milliseconds to sample system and process performance
metrics. Minimum is 100ms. Defaults to 5000.

kibana__default_configuration[36].name = i18n.defaultLocale
kibana__default_configuration[36].state = comment
kibana__default_configuration[36].comment = The default locale. This locale can be used in certain circumstances to substitute any missing
translations.

kibana__default_configuration[36].value = en
kibana__default_configuration[37].name = xpack.security.encryptionKey
kibana__default_configuration[37].comment = An arbitrary string of 32 characters or more that is used to encrypt session information.

kibana__default_configuration[37].value = {{ kibana__security_encryption_key }}
kibana__default_configuration[38].name = xpack.reporting.encryptionKey
kibana__default_configuration[38].comment = The static encryption key for reporting. Use an alphanumeric text string that is at least 32 characters.

kibana__default_configuration[38].value = {{ kibana__reporting_encryption_key }}
kibana__plugin_configuration = {{ lookup("template",
                                  "lookup/kibana__plugin_configuration.j2")
                                  | from_yaml }}

kibana__dependent_role = 
kibana__dependent_state = present
kibana__dependent_configuration_filter = {{ lookup("template",
                                            "lookup/kibana__dependent_configuration_filter.j2")
                                            | from_yaml }}

kibana__combined_configuration = {{ lookup("flattened", (kibana__default_configuration
                                    + kibana__plugin_configuration
                                    + kibana__dependent_configuration_filter
                                    + kibana__configuration
                                    + kibana__group_configuration
                                    + kibana__host_configuration)) }}

kibana__configuration_sections[0].name = Server
kibana__configuration_sections[0].part[0] = server
kibana__configuration_sections[0].part[1] = kibana
kibana__configuration_sections[1].name = Elasticsearch
kibana__configuration_sections[1].part = elasticsearch
kibana__configuration_sections[2].name = Map tiles
kibana__configuration_sections[2].part = tilemap
kibana__configuration_sections[3].name = Logging
kibana__configuration_sections[3].part = logging
kibana__configuration_sections[4].name = X-Pack
kibana__configuration_sections[4].part = xpack
kibana__configuration_sections[5].name = Search Guard
kibana__configuration_sections[5].part = searchguard
kibana__combined_plugins = {{ lookup("flattened", (kibana__plugins
                              + kibana__group_plugins
                              + kibana__host_plugins)) }}

kibana__combined_keys = {{ kibana__keys
                           + kibana__group_keys
                           + kibana__host_keys }}

kibana__etc_services__dependent_list[0].name = kibana
kibana__etc_services__dependent_list[0].port = {{ kibana__server_port }}
kibana__extrepo__dependent_sources[0] = elastic
kibana__nginx__dependent_servers[0].name = {{ kibana__fqdn }}
kibana__nginx__dependent_servers[0].by_role = debops.kibana
kibana__nginx__dependent_servers[0].filename = debops.kibana
kibana__nginx__dependent_servers[0].deny_hidden = False
kibana__nginx__dependent_servers[0].type = proxy
kibana__nginx__dependent_servers[0].proxy_options = proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection "upgrade";
proxy_cache_bypass $http_upgrade;

kibana__nginx__dependent_servers[0].proxy_pass = http://kibana
kibana__nginx__dependent_servers[0].proxy_redirect = default
kibana__nginx__dependent_servers[0].allow = {{ kibana__webserver_allow }}
kibana__nginx__dependent_servers[0].access_policy = {{ kibana__webserver_access_policy }}
kibana__nginx__dependent_servers[0].auth_basic = {{ True if kibana__webserver_auth_basic_filename | d() else False }}
kibana__nginx__dependent_servers[0].auth_basic_realm = {{ kibana__webserver_auth_basic_realm }}
kibana__nginx__dependent_servers[0].auth_basic_filename = {{ kibana__webserver_auth_basic_filename }}
kibana__nginx__dependent_upstreams[0].name = kibana
kibana__nginx__dependent_upstreams[0].server = {{ kibana__server_host + ":" + kibana__server_port }}
