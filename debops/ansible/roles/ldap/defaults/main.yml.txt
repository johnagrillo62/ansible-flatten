ldap__enabled = {{ ansible_local.ldap.enabled
                   if (ansible_local | d() and ansible_local.ldap | d() and
                       (ansible_local.ldap.enabled | d()) | bool)
                   else False }}

ldap__posix_enabled = {{ ansible_local.ldap.posix_enabled | d(ldap__enabled) }}
ldap__configured = {{ ansible_local.ldap.configured
                      if (ansible_local | d() and ansible_local.ldap | d() and
                          ansible_local.ldap.configured is defined)
                      else False }}

ldap__dependent_play = {{ True
                          if (ldap__configured | bool and
                              ldap__dependent_tasks | d())
                          else False }}

ldap__base_packages[0] = libldap-common
ldap__base_packages[1] = ldap-utils
ldap__base_packages[2] = libsasl2-modules
ldap__domain = {{ ansible_domain }}
ldap__servers_srv_rr = {{ q("debops.debops.dig_srv", "_ldap._tcp." + ldap__domain,
                            "ldap." + ldap__domain, 389) }} 
ldap__servers = {{ ldap__servers_srv_rr | map(attribute="target") }}
ldap__servers_protocol = {{ "ldap" if ldap__start_tls | bool else "ldaps" }}
ldap__servers_uri = {{ ldap__servers
                       | map("regex_replace", "^(.*)$",
                             ldap__servers_protocol + "://\1/")
                       | list }}

ldap__start_tls = {{ True
                     if (ansible_local | d() and ansible_local.pki | d() and
                         (ansible_local.pki.enabled | d()) | bool)
                     else False }}

ldap__base_dn = {{ ldap__domain.split(".")
                   | map("regex_replace", "^(.*)$", "dc=\1")
                   | list }}

ldap__basedn = {{ ldap__base_dn | join(",") }}
ldap__people_rdn = ou=People
ldap__system_groups_rdn = ou=System Groups
ldap__groups_rdn = ou=Groups
ldap__hosts_rdn = ou=Hosts
ldap__machines_rdn = ou=Machines
ldap__roles_rdn = ou=Roles
ldap__services_rdn = ou=Services
ldap__device_enabled = True
ldap__device_separate_domains = True
ldap__device_domain = {{ ldap__domain }}
ldap__device_fqdn = {{ ansible_fqdn }}
ldap__device_aliases[0] = {{ ansible_hostname }}
ldap__device_ip_addresses = {{ lookup("template", "lookup/ldap__device_ip_addresses.j2",
                                      convert_data=False) | from_yaml }} 
ldap__device_ip_iface_regex = ^(bond|en|eth|vlan|mv-|host)
ldap__device_mac_addresses = {{ lookup("template", "lookup/ldap__device_mac_addresses.j2",
                                       convert_data=False) | from_yaml }} 
ldap__device_mac_iface_regex = ^(en|eth|mv-)
ldap__device_self_rdn = cn={{ ldap__device_fqdn }}
ldap__device_domain_rdn = dc={{ ldap__device_domain }}
ldap__device_branch_rdn = {{ ldap__hosts_rdn }}
ldap__device_dn = {{ q("flattened", [ldap__device_self_rdn]
                                    + ([ldap__device_domain_rdn]
                                       if ldap__device_separate_domains | bool
                                       else [])
                                    + [ldap__device_branch_rdn]
                                    + ldap__base_dn) }}

ldap__device_managers[0] = {{ ldap__admin_dn | join(",") }}
ldap__device_domain_object_classes[0] = domain
ldap__device_domain_attributes.dc = {{ ldap__device_domain_rdn.split("=")[1] }}
ldap__device_object_classes = {{ ["device", "ieee802Device", "ipHost"]
                                 + ([]
                                    if (ansible_virtualization_role == "guest" and
                                        ansible_virtualization_type in ["lxc", "docker", "openvz"])
                                    else ["bootableDevice"]) }}

ldap__device_attributes.cn = {{ ([ldap__device_self_rdn.split("=")[1]] + ldap__device_aliases) | unique }}
ldap__device_attributes.ipHostNumber = {{ ldap__device_ip_addresses }}
ldap__device_attributes.macAddress = {{ ldap__device_mac_addresses }}
ldap__device_attributes.manager = {{ ldap__device_managers }}
ldap__uid_gid_min = 2000000000
ldap__groupid_min = {{ ldap__uid_gid_min }}
ldap__groupid_max = {{ ldap__uid_gid_min | int + 1999999 }}
ldap__uid_gid_max = {{ ldap__uid_gid_min | int + 99999999 }}
ldap__home = /home
ldap__shell = /bin/bash
ldap__default_urn_patterns[0] = {{ ("deploy:" + ansible_local.machine.deployment)
        if (ansible_local.machine.deployment | d())
        else [] }}

ldap__combined_urn_patterns = {{ ldap__default_urn_patterns
                                 + ldap__urn_patterns
                                 + ldap__group_urn_patterns
                                 + ldap__host_urn_patterns }}

ldap__default_configuration[0].name = base
ldap__default_configuration[0].value = {{ ldap__basedn }}
ldap__default_configuration[1].name = uri
ldap__default_configuration[1].value = {{ ldap__servers_uri }}
ldap__default_configuration[2].name = sizelimit
ldap__default_configuration[2].value = 12
ldap__default_configuration[2].state = comment
ldap__default_configuration[2].separator = True
ldap__default_configuration[3].name = timelimit
ldap__default_configuration[3].value = 15
ldap__default_configuration[3].state = comment
ldap__default_configuration[4].name = deref
ldap__default_configuration[4].value = never
ldap__default_configuration[4].state = comment
ldap__default_configuration[5].name = tls_cacert
ldap__default_configuration[5].comment = TLS certificates (needed for GnuTLS)
ldap__default_configuration[5].value = /etc/ssl/certs/ca-certificates.crt
ldap__default_configuration[6].name = tls_reqcert
ldap__default_configuration[6].value = demand
ldap__combined_configuration = {{ ldap__default_configuration
                                  + ldap__configuration
                                  + ldap__group_configuration
                                  + ldap__host_configuration }}

ldap__admin_enabled = {{ True if ldap__fact_admin_bindpw | d() else False }}
ldap__admin_passwordstore_path = debops/ldap/credentials
ldap__admin_rdn = {{ "uid=" + lookup("env", "USER") }}
ldap__admin_dn = {{ [ldap__admin_rdn, ldap__people_rdn] + ldap__base_dn }}
ldap__admin_binddn = {{ lookup("env", "DEBOPS_LDAP_ADMIN_BINDDN")
                        | d(ldap__admin_dn | join(","), True) }} 
ldap__admin_bindpw = {{ (lookup("env", "DEBOPS_LDAP_ADMIN_BINDPW")
                         if lookup("env", "DEBOPS_LDAP_ADMIN_BINDPW") | d()
                         else (lookup("file", secret + "/ldap/credentials/"
                                              + ldap__admin_binddn | to_uuid
                                              + ".password")
                               if lookup("first_found",
                                         [secret + "/ldap/credentials/"
                                          + ldap__admin_binddn | to_uuid
                                          + ".password"],
                                         skip=True, errors="ignore")
                               else lookup("passwordstore",
                                           ldap__admin_passwordstore_path + "/"
                                           + ldap__admin_binddn | to_uuid
                                           + " create=false", errors="ignore")))
                        if ldap__enabled | bool else "" }}

ldap__admin_server_uri = {{ ldap__servers_uri | first }}
ldap__admin_delegate_to = localhost
ldap__admin_become = False
ldap__admin_become_user = root
ldap__default_tasks[0].name = Ensure that {{ ldap__hosts_rdn }} object exists in LDAP directory
ldap__default_tasks[0].dn = {{ [ldap__hosts_rdn] + ldap__base_dn }}
ldap__default_tasks[0].objectClass[0] = organizationalStructure
ldap__default_tasks[0].attributes.ou = {{ ldap__hosts_rdn.split("=")[1] }}
ldap__default_tasks[0].attributes.description = Servers and other data center equipment
ldap__default_tasks[1].name = Create domain object for {{ ldap__device_dn | join(",") }}
ldap__default_tasks[1].dn = {{ [ldap__device_domain_rdn, ldap__device_branch_rdn]
            + ldap__base_dn }} 
ldap__default_tasks[1].objectClass = {{ ldap__device_domain_object_classes }}
ldap__default_tasks[1].attributes = {{ ldap__device_domain_attributes }}
ldap__default_tasks[1].state = {{ "present"
               if (ldap__device_enabled | bool and
                   ldap__device_separate_domains | bool)
               else "ignore" }}

ldap__default_tasks[2].name = Create device object for {{ ldap__device_dn | join(",") }}
ldap__default_tasks[2].dn = {{ ldap__device_dn }}
ldap__default_tasks[2].objectClass = {{ ldap__device_object_classes }}
ldap__default_tasks[2].attributes = {{ ldap__device_attributes }}
ldap__default_tasks[2].state = {{ "present"
               if (ldap__device_enabled | bool)
               else "ignore" }}

ldap__default_tasks[3].name = Update device object for {{ ldap__device_dn | join(",") }}
ldap__default_tasks[3].dn = {{ ldap__device_dn }}
ldap__default_tasks[3].attributes = {{ ldap__device_attributes }}
ldap__default_tasks[3].state = {{ "present"
               if (ldap__fact_configured | bool and
                   ldap__device_enabled | bool)
               else ("exact"
                     if (ldap__device_enabled | bool)
                     else "ignore") }}

ldap__combined_tasks = {{ ldap__dependent_tasks
                          if (ldap__fact_configured | bool and
                              ldap__dependent_tasks | d())
                          else (ldap__default_tasks
                                + ldap__tasks
                                + ldap__group_tasks
                                + ldap__host_tasks
                                + ldap__dependent_tasks) }}

ldap__python__dependent_packages3[0] = {{ ([]
         if (ansible_distribution_release in
             (["stretch", "trusty", "xenial"]))
         else "python3-ldap")
        if ldap__enabled | bool
        else [] }}

ldap__python__dependent_packages2[0] = {{ "python-ldap" if ldap__enabled | bool else [] }}
