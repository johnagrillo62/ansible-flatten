[0].name = Prep_download | Set a few facts
[0].set_fact.download_force_cache = {{ true if download_run_once else download_force_cache }}
[0].tags[0] = facts
[1].name = Prep_download | On localhost, check if passwordless root is possible
[1].command = true
[1].delegate_to = localhost
[1].connection = local
[1].run_once = true
[1].register = test_become
[1].changed_when = false
[1].ignore_errors = true
[1].become = true
[1].when[0] = download_localhost
[1].tags[0] = localhost
[1].tags[1] = asserts
[2].name = Prep_download | On localhost, check if user has access to the container runtime without using sudo
[2].shell = {{ image_info_command_on_localhost }}
[2].delegate_to = localhost
[2].connection = local
[2].run_once = true
[2].register = test_docker
[2].changed_when = false
[2].ignore_errors = true
[2].become = false
[2].when[0] = download_localhost
[2].tags[0] = localhost
[2].tags[1] = asserts
[3].name = Prep_download | Parse the outputs of the previous commands
[3].set_fact.user_in_docker_group = {{ not test_docker.failed }}
[3].set_fact.user_can_become_root = {{ not test_become.failed }}
[3].when[0] = download_localhost
[3].tags[0] = localhost
[3].tags[1] = asserts
[4].name = Prep_download | Check that local user is in group or can become root
[4].assert.that = user_in_docker_group or user_can_become_root
[4].assert.msg = Error: User is not in docker group and cannot become root. When download_localhost is true, at least one of these two conditions must be met.
[4].when[0] = download_localhost
[4].tags[0] = localhost
[4].tags[1] = asserts
[5].name = Prep_download | Register docker images info
[5].shell = {{ image_info_command }}
[5].no_log = {{ not (unsafe_show_logs | bool) }}
[5].register = docker_images
[5].failed_when = false
[5].changed_when = false
[5].check_mode = false
[5].when = download_container
[6].name = Prep_download | Create staging directory on remote node
[6].file.path = {{ local_release_dir }}/images
[6].file.state = directory
[6].file.mode = 0755
[6].file.owner = {{ ansible_ssh_user | default(ansible_user_id) }}
[6].when[0] = ansible_os_family not in ["Flatcar", "Flatcar Container Linux by Kinvolk"]
[7].name = Prep_download | Create local cache for files and images on control node
[7].file.path = {{ download_cache_dir }}/images
[7].file.state = directory
[7].file.mode = 0755
[7].delegate_to = localhost
[7].connection = local
[7].delegate_facts = false
[7].run_once = true
[7].become = false
[7].when = download_force_cache or download_run_once
[7].tags[0] = localhost
