sks_recon_name = sks
sks_recon_port = 11370
sks_hkp_frontend_name = hkp-backend
sks_hkp_frontend_port = 11372
sks_nginx_frontend.by_role = debops.sks
sks_nginx_frontend.enabled = True
sks_nginx_frontend.default = False
sks_nginx_frontend.name = {{ ["default_sks"] + sks_domain }}
sks_nginx_frontend.root = {{ "/srv/www/sites/" + sks_domain[0] + "/public" }}
sks_nginx_frontend.webroot_create = False
sks_nginx_frontend.ssl = False
sks_nginx_frontend.listen[0] = [::]:80
sks_nginx_frontend.listen[1] = [::]:11371
sks_nginx_frontend.location./ = try_files $uri $uri/ =404;
index index.html;

sks_nginx_frontend.location./pks = proxy_pass http://sks_servers/pks;
proxy_pass_header Server;
add_header Via "1.1 {{ ansible_fqdn }} (nginx)";
proxy_ignore_client_abort on;

sks_nginx_ssl_frontend.by_role = debops.sks
sks_nginx_ssl_frontend.enabled = True
sks_nginx_ssl_frontend.default = False
sks_nginx_ssl_frontend.state = {{ "present"
             if (ansible_local | d() and ansible_local.pki | d() and
                 (ansible_local.pki.enabled | d()) | bool)
             else "absent" }}
sks_nginx_ssl_frontend.name = {{ sks_domain }}
sks_nginx_ssl_frontend.listen = False
sks_nginx_ssl_frontend.location./ = try_files $uri $uri/ =404;
index index.html;

sks_nginx_ssl_frontend.location./pks = proxy_pass http://sks_servers/pks;
proxy_pass_header Server;
add_header Via "1.1 {{ ansible_fqdn }} (nginx)";
proxy_ignore_client_abort on;

sks_nginx_upstreams.enabled = True
sks_nginx_upstreams.name = sks_servers
sks_nginx_upstreams.server = localhost:{{ sks_hkp_frontend_port }}
sks_nginx_upstreams.cluster = {{ sks_cluster | difference(sks_frontends) }}
sks_nginx_upstreams.port = 11371
