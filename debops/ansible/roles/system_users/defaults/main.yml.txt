system_users__enabled = True
system_users__acl_enabled = {{ True if ("acl" in system_users__base_packages) else False }}
system_users__default_shell = 
system_users__shell_package_map./bin/bash = bash
system_users__shell_package_map./bin/csh = csh
system_users__shell_package_map./usr/bin/fish = fish
system_users__shell_package_map./bin/ksh = ksh
system_users__shell_package_map./bin/zsh = zsh
system_users__base_packages[0] = acl
system_users__shell_packages = {{ lookup("template", "lookup/system_users__shell_packages.j2") | from_yaml }}
system_users__prefix = {{ ansible_local.system_users.prefix | d("_"
                            if ("debops_service_ldap" in group_names or
                                (ansible_local.ldap.posix_enabled | d() | bool))
                            else "") }}

system_users__home_root = {{ "/var/local"
                             if ("debops_service_ldap" in group_names or
                                 (ansible_local.ldap.posix_enabled | d() | bool))
                             else "/home" }}

system_users__default_home_mode = 0751
system_users__admin_groups = {{ ansible_local.system_groups.access.root | d(["admins"]) }}
system_users__dotfiles_enabled = {{ True
                                    if ansible_local.yadm.dotfiles | d()
                                    else False }}

system_users__dotfiles_repo = {{ ansible_local.yadm.dotfiles | d("") }}
system_users__self = {{ False
                        if (system_users__self_name == "root" or
                            ansible_connection | d("ssh") == "local")
                        else True }}

system_users__self_name = {{ lookup("env", "USER") }}
system_users__self_comment = Ansible Control User
system_users__self_shell = /bin/bash
system_users__default_accounts[0].name = {{ system_users__self_name }}
system_users__default_accounts[0].group = {{ system_users__self_name }}
system_users__default_accounts[0].prefix = {{ "" if ansible_user | d() else system_users__prefix }}
system_users__default_accounts[0].comment = {{ system_users__fact_self_comment
                 | d(system_users__self_comment)
                 | regex_replace(",,,$", "") }}

system_users__default_accounts[0].shell = {{ (system_users__fact_self_shell | d(system_users__self_shell))
               if ((system_users__fact_self_shell | d(system_users__self_shell))
                   in system_users__shell_package_map.keys())
               else omit }}

system_users__default_accounts[0].admin = True
system_users__default_accounts[0].sshkeys = {{ lookup("pipe", "ssh-add -L | grep ^\\\(sk-\\\)\\\?ssh || cat ~/.ssh/*.pub || cat ~/.ssh/authorized_keys || true") }}
system_users__default_accounts[0].state = {{ "present"
               if system_users__self | bool
               else "ignore" }}

system_users__combined_accounts = {{ system_users__groups
                                     + system_users__group_groups
                                     + system_users__host_groups
                                     + (system_users__dependent_groups | flatten)
                                     + system_users__default_accounts
                                     + system_users__accounts
                                     + system_users__group_accounts
                                     + system_users__host_accounts
                                     + (system_users__dependent_accounts | flatten) }}

