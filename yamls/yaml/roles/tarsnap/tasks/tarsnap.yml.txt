[0].name = Check if Tarsnap {{ tarsnap_version }} is installed
[0].shell = tarsnap --version | grep {{ tarsnap_version }} --color=never
[0].register = tarsnap_installed
[0].changed_when = tarsnap_installed.rc != 0
[0].ignore_errors = yes
[0].tags[0] = dependencies
[1].name = Install dependencies for Tarsnap
[1].when = tarsnap_installed is failed
[1].apt = pkg={{ item }} state=present
[1].with_items[0] = e2fslibs-dev
[1].with_items[1] = libssl-dev
[1].with_items[2] = zlib1g-dev
[1].tags[0] = dependencies
[2].name = Download the current tarsnap code signing key
[2].when = tarsnap_installed is failed
[2].get_url = url=https://www.tarsnap.com/tarsnap-signing-key.asc dest=/root/tarsnap-signing-key.asc
[3].name = Add the tarsnap code signing key to your list of keys
[3].when = tarsnap_installed is failed
[3].command = gpg --import tarsnap-signing-key.asc chdir=/root/
[4].name = Download tarsnap SHA file
[4].when = tarsnap_installed is failed
[4].get_url = url="https://www.tarsnap.com/download/tarsnap-sigs-{{ tarsnap_version }}.asc" dest="/root/tarsnap-sigs-{{ tarsnap_version }}.asc"
[5].name = Make the command that gets the current SHA
[5].when = tarsnap_installed is failed
[5].template = src=getSha.sh dest=/root/getSha.sh mode=0755
[6].name = Get the SHA256sum for this tarsnap release
[6].when = tarsnap_installed is failed
[6].command = ./getSha.sh chdir=/root
[6].register = tarsnap_sha
[7].name = Download Tarsnap source
[7].when = tarsnap_installed is failed
[7].get_url = url="https://www.tarsnap.com/download/tarsnap-autoconf-{{ tarsnap_version }}.tgz" dest="/root/tarsnap-autoconf-{{ tarsnap_version }}.tgz" sha256sum={{ tarsnap_sha.stdout_lines[0] }}
[8].name = Decompress Tarsnap source
[8].when = tarsnap_installed is failed
[8].unarchive = src=/root/tarsnap-autoconf-{{ tarsnap_version }}.tgz dest=/root copy=no creates=/root/tarsnap-autoconf-{{ tarsnap_version }}/COPYING
[9].name = Configure Tarsnap for local build
[9].when = tarsnap_installed is failed
[9].command = ./configure chdir=/root/tarsnap-autoconf-{{ tarsnap_version }} creates=/root/tarsnap-autoconf-{{ tarsnap_version }}/Makefile
[10].name = Build and install Tarsnap
[10].when = tarsnap_installed is failed
[10].command = make all install clean chdir=/root/tarsnap-autoconf-{{ tarsnap_version }} creates=/usr/local/bin/tarsnap
[11].name = Copy Tarsnap key file into place
[11].copy = src=decrypted_tarsnap.key dest=/decrypted/tarsnap.key owner=root group=root mode="0600" force=no
[12].name = Create Tarsnap cache directory
[12].file = state=directory path=/usr/tarsnap-cache
[13].name = Install Tarsnap configuration file
[13].copy = src=tarsnaprc dest=/root/.tarsnaprc mode="0644"
[14].name = Install Tarsnap backup handler script
[14].copy = src=tarsnap.sh dest=/root/tarsnap.sh mode="0755"
[15].name = Install nightly Tarsnap-generations cronjob
[15].cron = name="Tarsnap backup" hour="3" minute="0" job="sh /root/tarsnap.sh >> /var/log/tarsnap.log"
