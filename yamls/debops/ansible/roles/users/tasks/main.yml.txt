[0].name = Import custom Ansible plugins
[0]["ansible.builtin.import_role"].name = ansible_plugins
[1].name = Import DebOps global handlers
[1]["ansible.builtin.import_role"].name = global_handlers
[2].name = Import DebOps secret role
[2]["ansible.builtin.import_role"].name = secret
[3].name = Install required packages
[3]["ansible.builtin.package"].name = {{ q("flattened", (users__base_packages
                              + users__shell_packages
                              + users__packages)) }}
[3]["ansible.builtin.package"].state = present
[3].register = users__register_packages
[3].until = users__register_packages is succeeded
[3].when = users__enabled | bool
[4].name = DebOps pre_tasks hook
[4]["ansible.builtin.include_tasks"] = {{ lookup('debops.debops.task_src', 'users/pre_main.yml') }}
[5].name = Create user groups
[5]["ansible.builtin.group"].name = {{ item.group | d(item.name) }}
[5]["ansible.builtin.group"].system = {{ item.system | d(False if (item.user | d(True)) | bool else True) }}
[5]["ansible.builtin.group"].gid = {{ item.gid | d(omit) }}
[5]["ansible.builtin.group"].state = present
[5]["ansible.builtin.group"].local = {{ item.local | d(True if (item.user | d(True)) | bool else False) }}
[5].loop = {{ users__combined_accounts | debops.debops.parse_kv_items }}
[5].loop_control.label = {{ {"name": (item.group | d(item.name)),
                "state": item.state | d("present")} }}
[5].when = (users__enabled | bool and item.name | d() and item.name != 'root' and item.state | d('present') != 'absent' and (item.private_group | d(True)) | bool)
[5].no_log = {{ debops__no_log | d(item.no_log) | d(True if item.password | d() else False) }}
[6].name = Gather information about existing remote users
[6]["ansible.builtin.getent"].database = passwd
[7].name = Manage user accounts
[7]["ansible.builtin.user"].name = {{ item.name }}
[7]["ansible.builtin.user"].group = {{ item.group | d(item.name) }}
[7]["ansible.builtin.user"].home = {{ item.home
                            | d((getent_passwd[item.name][4])
                                if (getent_passwd[item.name] | d())
                                else omit) }}
[7]["ansible.builtin.user"].uid = {{ item.uid | d(omit) }}
[7]["ansible.builtin.user"].state = {{ item.state | d("present") }}
[7]["ansible.builtin.user"].comment = {{ item.comment | d(omit) }}
[7]["ansible.builtin.user"].password = {{ item.password | d("*") }}
[7]["ansible.builtin.user"].update_password = {{ item.update_password | d("on_create") }}
[7]["ansible.builtin.user"].system = {{ item.system | d(omit) }}
[7]["ansible.builtin.user"].shell = {{ item.shell | d(users__chroot_shell
                                           if (item.chroot | d()) | bool
                                           else (users__default_shell
                                                 if users__default_shell | d()
                                                 else omit)) }}
[7]["ansible.builtin.user"].create_home = {{ item.create_home | d(omit) }}
[7]["ansible.builtin.user"].move_home = {{ item.move_home | d(omit) }}
[7]["ansible.builtin.user"].skeleton = {{ item.skeleton | d(omit) }}
[7]["ansible.builtin.user"].expires = {{ item.expires | d(omit) }}
[7]["ansible.builtin.user"].remove = {{ item.remove | d(omit) }}
[7]["ansible.builtin.user"].force = {{ item.force | d(omit) }}
[7]["ansible.builtin.user"].non_unique = {{ item.non_unique | d(omit) }}
[7]["ansible.builtin.user"].generate_ssh_key = {{ item.generate_ssh_key | d(omit) }}
[7]["ansible.builtin.user"].ssh_key_bits = {{ item.ssh_key_bits | d(omit) }}
[7]["ansible.builtin.user"].ssh_key_comment = {{ item.ssh_key_comment | d(omit) }}
[7]["ansible.builtin.user"].ssh_key_file = {{ item.ssh_key_file | d(omit) }}
[7]["ansible.builtin.user"].ssh_key_passphrase = {{ item.ssh_key_passphrase | d(omit) }}
[7]["ansible.builtin.user"].ssh_key_type = {{ item.ssh_key_type | d(omit) }}
[7]["ansible.builtin.user"].local = {{ item.local | d(True) }}
[7].loop = {{ users__combined_accounts | debops.debops.parse_kv_items }}
[7].loop_control.label = {{ {"name": item.name,
                "state": item.state | d("present"), "gecos": item.comment | d()} }}
[7].when = (users__enabled | bool and item.name | d() and item.name != 'root' and item.state | d('present') not in ['ignore'] and (item.user | d(True)) | bool)
[7].no_log = {{ debops__no_log | d(item.no_log) | d(True if item.password | d() else False) }}
[8].name = Gather information about existing remote groups
[8]["ansible.builtin.getent"].database = group
[9].name = Manage additional UNIX groups for UNIX accounts
[9]["ansible.builtin.user"].name = {{ item.name }}
[9]["ansible.builtin.user"].groups = {{ (((([item.groups]
                          if (item.groups is string)
                          else item.groups)
                         if (item.groups is defined)
                         else [])
                        + (users__chroot_groups
                           if ((item.chroot | d()) | bool)
                           else []))
                       | intersect(getent_group.keys()))
                      if (item.groups is defined or (item.chroot | d()) | bool)
                      else omit }}
[9]["ansible.builtin.user"].append = {{ item.append | d(True) }}
[9]["ansible.builtin.user"].state = {{ item.state | d("present") }}
[9]["ansible.builtin.user"].create_home = {{ item.create_home | d(omit) }}
[9].loop = {{ users__combined_accounts | debops.debops.parse_kv_items }}
[9].loop_control.label = {{ {"name": item.name,
                "state": item.state | d("present"), "gecos": item.comment | d(),
                "groups": item.groups | d()} }}
[9].when = (users__enabled | bool and item.name | d() and item.name != 'root' and item.state | d('present') not in ['ignore'] and (item.groups | d() or (item.chroot | d()) | bool) and (item.user | d(True)) | bool)
[9].no_log = {{ debops__no_log | d(item.no_log) | d(True if item.password | d() else False) }}
[10].name = Manage user home directories
[10]["ansible.builtin.file"].path = {{ item.home
              | d(((getent_passwd[item.name][4])
                   if (getent_passwd[item.name] | d())
                   else ("~" + item.name))
                  if ((item.create_home | d(True)) | bool)
                  else omit) }}
[10]["ansible.builtin.file"].state = directory
[10]["ansible.builtin.file"].owner = {{ item.home_owner | d("root" if ((item.chroot | d()) | bool) else omit) }}
[10]["ansible.builtin.file"].group = {{ item.home_group | d(omit) }}
[10]["ansible.builtin.file"].mode = {{ item.home_mode | d(users__default_home_mode if (item.local | d(True)) | bool else omit) }}
[10].loop = {{ users__combined_accounts | debops.debops.parse_kv_items }}
[10].loop_control.label = {{ {"name": item.name,
                "state": item.state | d("present"),
                "home": (item.home | d(((getent_passwd[item.name][4])
                                        if (getent_passwd[item.name] | d())
                                        else ("~" + item.name))
                                       if ((item.create_home | d(True)) | bool)
                                       else ""))} }}
[10].when = (users__enabled | bool and item.name | d() and item.name != 'root' and item.state | d('present') not in ['absent', 'ignore'] and item.create_home | d(True) and (item.home_owner | d() or item.home_group | d() or item.home_mode | d() or (item.local | d(True)) | bool) and (item.user | d(True)) | bool)
[10].no_log = {{ debops__no_log | d(item.no_log) | d(True if item.password | d() else False) }}
[11].name = Manage home directory ACLs
[11]["ansible.posix.acl"].path = {{ item.0.home
                     | d(((getent_passwd[item.0.name][4])
                          if (getent_passwd[item.0.name] | d())
                          else ("~" + item.0.name))
                         if ((item.0.create_home | d(True)) | bool)
                         else omit) }}
[11]["ansible.posix.acl"].default = {{ item.1.default | d(omit) }}
[11]["ansible.posix.acl"].entity = {{ item.1.entity | d(omit) }}
[11]["ansible.posix.acl"].entry = {{ item.1.entry | d(omit) }}
[11]["ansible.posix.acl"].etype = {{ item.1.etype | d(omit) }}
[11]["ansible.posix.acl"].permissions = {{ item.1.permissions | d(omit) }}
[11]["ansible.posix.acl"].follow = {{ item.1.follow | d(omit) }}
[11]["ansible.posix.acl"].recursive = {{ item.1.recursive | d(omit) }}
[11]["ansible.posix.acl"].state = {{ item.1.state | d("present") }}
[11].loop = {{ users__combined_accounts | debops.debops.parse_kv_items
            | selectattr("home_acl", "defined") | list
            | subelements("home_acl") }}
[11].loop_control.label = {{ {"name": item.0.name,
                "state": item.0.state | d("present"), "home_acl": item.1} }}
[11].when = (users__enabled | bool and users__acl_enabled | bool and item.0.name | d() and item.0.name != 'root' and item.0.state | d('present') not in ['absent', 'ignore'] and item.0.create_home | d(True) and item.0.home_acl | d() and (item.0.user | d(True)) | bool)
[11].no_log = {{ debops__no_log | d(item.no_log) | d(True if item.password | d() else False) }}
[11].tags[0] = role::users:home_acl
[11].tags[1] = skip::users:home_acl
[11].tags[2] = skip::check
[12].name = Allow specified UNIX accounts to linger when not logged in
[12]["ansible.builtin.command"] = loginctl enable-linger {{ item.name }}
[12].args.creates = /var/lib/systemd/linger/{{ item.name }}
[12].loop = {{ users__combined_accounts | debops.debops.parse_kv_items }}
[12].loop_control.label = {{ {"name": item.name,
                "state": item.state | d("present"), "linger": item.linger | d(False)} }}
[12].when = (users__enabled | bool and ansible_service_mgr == 'systemd' and item.name | d() and item.name != 'root' and item.state | d('present') not in ['absent', 'ignore'] and item.linger is defined and item.linger | bool and (item.user | d(True)) | bool)
[12].no_log = {{ debops__no_log | d(item.no_log) | d(True if item.password | d() else False) }}
[13].name = Disallow specified UNIX accounts to linger when not logged in
[13]["ansible.builtin.command"] = loginctl disable-linger {{ item.name }}
[13].args.removes = /var/lib/systemd/linger/{{ item.name }}
[13].loop = {{ users__combined_accounts | debops.debops.parse_kv_items }}
[13].loop_control.label = {{ {"name": item.name,
                "state": item.state | d("present"), "linger": item.linger | d(False)} }}
[13].when = (users__enabled | bool and ansible_service_mgr == 'systemd' and item.name | d() and item.name != 'root' and item.state | d('present') not in ['absent', 'ignore'] and item.linger is defined and not item.linger | bool and (item.user | d(True)) | bool)
[13].no_log = {{ debops__no_log | d(item.no_log) | d(True if item.password | d() else False) }}
[14].name = Configure ~/.ssh/authorized_keys for users
[14]["ansible.posix.authorized_key"].key = {{ (item.sshkeys if item.sshkeys is string else '\n'.join(item.sshkeys)) | string }}
[14]["ansible.posix.authorized_key"].state = present
[14]["ansible.posix.authorized_key"].user = {{ item.name }}
[14]["ansible.posix.authorized_key"].exclusive = {{ item.sshkeys_exclusive | d(omit) }}
[14]["ansible.posix.authorized_key"].follow = {{ item.sshkeys_follow | d(omit) }}
[14].loop = {{ users__combined_accounts | debops.debops.parse_kv_items }}
[14].loop_control.label = {{ {"name": item.name,
                "state": item.state | d("present"), "sshkeys": item.sshkeys | d()} }}
[14].when = (users__enabled | bool and item.name | d() and item.name != 'root' and item.state | d('present') not in ['absent', 'ignore'] and item.create_home | d(True) and item.sshkeys | d() and item.sshkeys_state | d('present') != 'absent' and (item.user | d(True)) | bool)
[14].no_log = {{ debops__no_log | d(item.no_log) | d(True if item.password | d() else False) }}
[14].tags[0] = role::users:authorized_keys
[14].tags[1] = skip::users:authorized_keys
[14].tags[2] = skip::check
[15].name = Remove ~/.ssh/authorized_keys from user account if disabled
[15]["ansible.builtin.file"].path = ~{{ item.name }}/.ssh/authorized_keys
[15]["ansible.builtin.file"].state = absent
[15].loop = {{ users__combined_accounts | debops.debops.parse_kv_items }}
[15].loop_control.label = {{ {"name": item.name,
                "state": item.state | d("present"),
                "sshkeys_state": item.sshkeys_state | d("present")} }}
[15].when = (users__enabled | bool and item.name | d() and item.name != 'root' and item.state | d('present') not in ['absent', 'ignore'] and item.create_home | d(True) and item.sshkeys_state | d('present') == 'absent' and (item.user | d(True)) | bool)
[15].no_log = {{ debops__no_log | d(item.no_log) | d(True if item.password | d() else False) }}
[16].name = Configure user mail forwarding
[16]["ansible.builtin.lineinfile"].dest = {{ "~" + item.name + "/.forward" }}
[16]["ansible.builtin.lineinfile"].regexp = {{ '^' + (item.forward if item.forward is string else item.forward[0]) }}
[16]["ansible.builtin.lineinfile"].line = {{ item.forward if item.forward is string else item.forward | join(", ") }}
[16]["ansible.builtin.lineinfile"].state = {{ item.forward_state | d("present") }}
[16]["ansible.builtin.lineinfile"].create = True
[16]["ansible.builtin.lineinfile"].owner = {{ item.name if ((item.chroot | d()) | bool) else omit }}
[16]["ansible.builtin.lineinfile"].group = {{ (item.group | d(item.name)) if ((item.chroot | d()) | bool) else omit }}
[16]["ansible.builtin.lineinfile"].mode = 0644
[16].become = True
[16].become_user = {{ "root" if ((item.chroot | d()) | bool) else item.name }}
[16].loop = {{ users__combined_accounts | debops.debops.parse_kv_items }}
[16].loop_control.label = {{ {"name": item.name,
                "state": item.state | d("present"),
                "forward": item.forward | d()} }}
[16].when = (users__enabled | bool and item.name | d() and item.name != 'root' and item.state | d('present') not in ['absent', 'ignore'] and item.create_home | d(True) and item.forward | d() and (item.user | d(True)) | bool)
[16].no_log = {{ debops__no_log | d(item.no_log) | d(True if item.password | d() else False) }}
[16].tags[0] = role::users:forward
[16].tags[1] = skip::users:forward
[16].tags[2] = skip::check
[17].name = Manage users dotfiles
[17].environment.LC_MESSAGES = C
[17]["ansible.builtin.shell"] = if ! yadm status > /dev/null ; then
    yadm clone --bootstrap "{{ item.dotfiles_repo | d(users__dotfiles_repo) }}"
else
    yadm pull
fi

[17].loop = {{ users__combined_accounts | debops.debops.parse_kv_items }}
[17].loop_control.label = {{ {"name": item.name,
                "state": item.state | d("present"),
                "dotfiles": (item.dotfiles | d(item.dotfiles_enabled | d(users__dotfiles_enabled))),
                "dotfiles_repo": ((item.dotfiles_repo | d(users__dotfiles_repo))
                                  if ((item.dotfiles | d(item.dotfiles_enabled | d(users__dotfiles_enabled))) | bool)
                                  else "")} }}
[17].become = True
[17].become_user = {{ item.name }}
[17].check_mode = False
[17].register = users__register_dotfiles
[17].changed_when = ('Already up to date.' not in users__register_dotfiles.stdout_lines | regex_replace('-', ' '))
[17].when = (users__enabled | bool and item.name | d() and item.name != 'root' and item.state | d('present') not in ['absent', 'ignore'] and item.create_home | d(True) and (ansible_local | d() and ansible_local.yadm | d() and (ansible_local.yadm.installed | d()) | bool) and (item.dotfiles | d(item.dotfiles_enabled | d(users__dotfiles_enabled))) | bool and (item.dotfiles_repo | d(users__dotfiles_repo)) and (item.user | d(True)) | bool and not (item.chroot | d()) | bool)
[17].no_log = {{ debops__no_log | d(item.no_log) | d(True if item.password | d() else False) }}
[17].tags[0] = role::users:dotfiles
[17].tags[1] = skip::users:dotfiles
[17].tags[2] = skip::check
[18].name = Manage user resource directories
[18]["ansible.builtin.file"].path = {{ "~" + item.0.name + "/" + (item.1.path | d(item.1.dest | d(item.1))) }}
[18]["ansible.builtin.file"].src = {{ item.1.src | d(omit) }}
[18]["ansible.builtin.file"].state = {{ item.1.state | d("directory") }}
[18]["ansible.builtin.file"].owner = {{ item.1.owner | d(item.0.name) }}
[18]["ansible.builtin.file"].group = {{ item.1.group | d(item.0.group | d(item.0.name)) }}
[18]["ansible.builtin.file"].mode = {{ item.1.mode | d(omit) }}
[18]["ansible.builtin.file"].force = {{ item.1.force | d(omit) }}
[18]["ansible.builtin.file"].recurse = {{ item.1.recurse | d(omit) }}
[18].loop = {{ users__combined_accounts | debops.debops.parse_kv_items
            | selectattr("resources", "defined") | list
            | subelements("resources") }}
[18].loop_control.label = {{ {"name": item.0.name,
                "state": item.0.state | d("present"), "resources": item.1} }}
[18].when = (users__enabled | bool and item.0.name | d() and item.0.name != 'root' and item.0.state | d('present') not in ['absent', 'ignore'] and item.0.create_home | d(True) and item.0.resources | d() and (item.0.user | d(True)) | bool and item.1.state | d('directory') in ['directory', 'link', 'touch'] and item.1.content is undefined)
[18].no_log = {{ debops__no_log | d(item.0.no_log) | d(True if item.0.password | d() else False) }}
[19].name = Manage user resource parent directories
[19]["ansible.builtin.file"].path = {{ ("~" + item.0.name + "/" + (item.1.path | d(item.1.dest))) | dirname }}
[19]["ansible.builtin.file"].state = directory
[19]["ansible.builtin.file"].owner = {{ item.1.parent_owner | d(item.0.name) }}
[19]["ansible.builtin.file"].group = {{ item.1.parent_group | d(item.0.group | d(item.0.name)) }}
[19]["ansible.builtin.file"].mode = {{ item.1.parent_mode | d(omit) }}
[19]["ansible.builtin.file"].force = {{ item.1.force | d(omit) }}
[19]["ansible.builtin.file"].recurse = {{ item.1.parent_recurse | d(omit) }}
[19].loop = {{ users__combined_accounts | debops.debops.parse_kv_items
            | selectattr("resources", "defined") | list
            | subelements("resources") }}
[19].loop_control.label = {{ {"name": item.0.name,
                "state": item.0.state | d("present"), "resources": item.1} }}
[19].when = (users__enabled | bool and item.0.name | d() and item.0.name != 'root' and item.0.state | d('present') not in ['absent', 'ignore'] and item.0.create_home | d(True) and item.0.resources | d() and (item.0.user | d(True)) | bool and item.1.state | d('directory') in ['present', 'file'])
[19].no_log = {{ debops__no_log | d(item.0.no_log) | d(True if item.0.password | d() else False) }}
[20].name = Manage user resource files
[20]["ansible.builtin.copy"].dest = {{ "~" + item.0.name + "/" + (item.1.path | d(item.1.dest)) }}
[20]["ansible.builtin.copy"].src = {{ item.1.src | d(omit) }}
[20]["ansible.builtin.copy"].content = {{ item.1.content | d(omit) }}
[20]["ansible.builtin.copy"].owner = {{ item.1.owner | d(item.0.name) }}
[20]["ansible.builtin.copy"].group = {{ item.1.group | d(item.0.group | d(item.0.name)) }}
[20]["ansible.builtin.copy"].mode = {{ item.1.mode | d(omit) }}
[20]["ansible.builtin.copy"].force = {{ item.1.force | d(omit) }}
[20].loop = {{ users__combined_accounts | debops.debops.parse_kv_items
            | selectattr("resources", "defined") | list
            | subelements("resources") }}
[20].loop_control.label = {{ {"name": item.0.name,
                "state": item.0.state | d("present"), "resources": item.1} }}
[20].when = (users__enabled | bool and item.0.name | d() and item.0.name != 'root' and item.0.state | d('present') not in ['absent', 'ignore'] and item.0.create_home | d(True) and item.0.resources | d() and (item.0.user | d(True)) | bool and item.1.state | d('directory') in ['present', 'file'] and (item.1.dest | d() or item.1.path | d()) and (item.1.src | d() or item.1.content | d()))
[20].no_log = {{ debops__no_log | d(item.0.no_log) | d(True if item.0.password | d() else False) }}
[21].name = Remove user resources if requested
[21]["ansible.builtin.file"].path = {{ "~" + item.0.name + "/" + (item.1.path | d(item.1.dest | d(item.1))) }}
[21]["ansible.builtin.file"].state = absent
[21].loop = {{ users__combined_accounts | debops.debops.parse_kv_items
            | selectattr("resources", "defined") | list
            | subelements("resources") }}
[21].loop_control.label = {{ {"name": item.0.name,
                "state": item.0.state | d("present"), "resources": item.1} }}
[21].when = (users__enabled | bool and item.0.name | d() and item.0.name != 'root' and item.0.state | d('present') not in ['absent', 'ignore'] and item.0.create_home | d(True) and item.0.resources | d() and (item.0.user | d(True)) | bool and item.1.state | d('directory') == 'absent')
[21].no_log = {{ debops__no_log | d(item.0.no_log) | d(True if item.0.password | d() else False) }}
[22].name = Remove user groups if requested
[22]["ansible.builtin.group"].name = {{ item.group | d(item.name) }}
[22]["ansible.builtin.group"].state = absent
[22]["ansible.builtin.group"].local = {{ item.local | d(True if (item.user | d(True)) | bool else False) }}
[22].loop = {{ users__combined_accounts | debops.debops.parse_kv_items }}
[22].loop_control.label = {{ {"name": (item.group | d(item.name)),
                "state": item.state | d("present")} }}
[22].when = (users__enabled | bool and item.name | d() and item.name != 'root' and item.state | d('present') == 'absent' and (item.private_group | d(True)) | bool)
[22].no_log = {{ debops__no_log | d(item.no_log) | d(True if item.password | d() else False) }}
[23].name = Make sure that Ansible local facts directory exists
[23]["ansible.builtin.file"].path = /etc/ansible/facts.d
[23]["ansible.builtin.file"].state = directory
[23]["ansible.builtin.file"].mode = 0755
[24].name = Save users local facts
[24]["ansible.builtin.template"].src = etc/ansible/facts.d/users.fact.j2
[24]["ansible.builtin.template"].dest = /etc/ansible/facts.d/users.fact
[24]["ansible.builtin.template"].mode = 0755
[24].notify[0] = Refresh host facts
[24].tags[0] = meta::facts
[25].name = Update Ansible facts if they were modified
[25]["ansible.builtin.meta"] = flush_handlers
[26].name = DebOps post_tasks hook
[26]["ansible.builtin.include_tasks"] = {{ lookup('debops.debops.task_src', 'users/post_main.yml') }}
