[0].name = Generate a test ID
[0]["ansible.builtin.set_fact"].test_id = {{ lookup('password', '/dev/null chars=ascii_letters length=16') }}
[0].when = test_id is not defined
[1].name = Generate hostnames
[1]["ansible.builtin.set_fact"].hostname1 = AWX-Collection-tests-instance1.{{ test_id }}.example.com
[1]["ansible.builtin.set_fact"].hostname2 = AWX-Collection-tests-instance2.{{ test_id }}.example.com
[1]["ansible.builtin.set_fact"].hostname3 = AWX-Collection-tests-instance3.{{ test_id }}.example.com
[1].register = facts
[2].name = Get the k8s setting
[2]["ansible.builtin.set_fact"].IS_K8S = {{ controller_settings['IS_K8S'] | default(False) }}
[2].vars.controller_settings = {{ lookup('awx.awx.controller_api', 'settings/all') }}
[3]["ansible.builtin.debug"].msg = Skipping instance test since this is instance is not running on a K8s platform
[3].when = not IS_K8S
[4].block[0].name = Create an instance
[4].block[0]["awx.awx.instance"].hostname = {{ item }}
[4].block[0]["awx.awx.instance"].node_type = execution
[4].block[0]["awx.awx.instance"].node_state = installed
[4].block[0].with_items[0] = {{ hostname1 }}
[4].block[0].with_items[1] = {{ hostname2 }}
[4].block[0].register = result
[4].block[1]["ansible.builtin.assert"].that[0] = result is changed
[4].block[2].name = Create an instance with non-default config
[4].block[2]["awx.awx.instance"].hostname = {{ hostname3 }}
[4].block[2]["awx.awx.instance"].node_type = execution
[4].block[2]["awx.awx.instance"].node_state = installed
[4].block[2]["awx.awx.instance"].capacity_adjustment = 0.4
[4].block[2].register = result
[4].block[3]["ansible.builtin.assert"].that[0] = result is changed
[4].block[4].name = Update an instance
[4].block[4]["awx.awx.instance"].hostname = {{ hostname1 }}
[4].block[4]["awx.awx.instance"].capacity_adjustment = 0.7
[4].block[4].register = result
[4].block[5]["ansible.builtin.assert"].that[0] = result is changed
[4].always[0].name = Deprovision the instances
[4].always[0]["awx.awx.instance"].hostname = {{ item }}
[4].always[0]["awx.awx.instance"].node_state = deprovisioning
[4].always[0].with_items[0] = {{ hostname1 }}
[4].always[0].with_items[1] = {{ hostname2 }}
[4].always[0].with_items[2] = {{ hostname3 }}
[4].when = IS_K8S
[5].block[0].name = Create hop node 1
[5].block[0]["awx.awx.instance"].hostname = {{ hostname1 }}
[5].block[0]["awx.awx.instance"].node_type = hop
[5].block[0]["awx.awx.instance"].node_state = installed
[5].block[0].register = result
[5].block[1]["ansible.builtin.assert"].that[0] = result is changed
[5].block[2].name = Create hop node 2
[5].block[2]["awx.awx.instance"].hostname = {{ hostname2 }}
[5].block[2]["awx.awx.instance"].node_type = hop
[5].block[2]["awx.awx.instance"].node_state = installed
[5].block[2].register = result
[5].block[3]["ansible.builtin.assert"].that[0] = result is changed
[5].block[4].name = Create execution node
[5].block[4]["awx.awx.instance"].hostname = {{ hostname3 }}
[5].block[4]["awx.awx.instance"].node_type = execution
[5].block[4]["awx.awx.instance"].node_state = installed
[5].block[4]["awx.awx.instance"].peers[0] = {{ hostname1 }}
[5].block[4]["awx.awx.instance"].peers[1] = {{ hostname2 }}
[5].block[4].register = result
[5].block[5]["ansible.builtin.assert"].that[0] = result is changed
[5].block[6].name = Remove execution node peers
[5].block[6]["awx.awx.instance"].hostname = {{ hostname3 }}
[5].block[6]["awx.awx.instance"].node_type = execution
[5].block[6]["awx.awx.instance"].node_state = installed
[5].block[6].register = result
[5].block[7]["ansible.builtin.assert"].that[0] = result is changed
[5].always[0].name = Deprovision the instances
[5].always[0]["awx.awx.instance"].hostname = {{ item }}
[5].always[0]["awx.awx.instance"].node_state = deprovisioning
[5].always[0].with_items[0] = {{ hostname1 }}
[5].always[0].with_items[1] = {{ hostname2 }}
[5].always[0].with_items[2] = {{ hostname3 }}
[5].when = IS_K8S
