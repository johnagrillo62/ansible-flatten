[0].name = Import custom Ansible plugins
[0]["ansible.builtin.import_role"].name = ansible_plugins
[1].name = Import DebOps global handlers
[1]["ansible.builtin.import_role"].name = global_handlers
[2].name = Import DebOps secret role
[2]["ansible.builtin.import_role"].name = secret
[3].name = Prepare OpenLDAP installation to use the rfc2307bis schema
[3]["ansible.builtin.include_tasks"] = prepare_rfc2307bis.yml
[3].when = (slapd__rfc2307bis_enabled | bool and (ansible_local is undefined or ansible_local.slapd is undefined))
[4].name = Initialize BaseDN value in debconf using a DNS domain
[4]["ansible.builtin.debconf"].name = slapd
[4]["ansible.builtin.debconf"].question = {{ item }}
[4]["ansible.builtin.debconf"].vtype = string
[4]["ansible.builtin.debconf"].value = {{ slapd__domain }}
[4].loop[0] = slapd/domain
[4].loop[1] = shared/organization
[5].name = Install OpenLDAP packages
[5]["ansible.builtin.package"].name = {{ q("flattened", (slapd__base_packages
                              + slapd__schema_packages
                              + slapd__packages)) }}
[5]["ansible.builtin.package"].state = present
[5].register = slapd__register_packages
[5].until = slapd__register_packages is succeeded
[6].name = Allow access to additional UNIX groups by the OpenLDAP service
[6]["ansible.builtin.user"].name = {{ slapd__user }}
[6]["ansible.builtin.user"].groups = {{ slapd__additional_groups }}
[6]["ansible.builtin.user"].append = True
[6]["ansible.builtin.user"].state = present
[6].register = slapd__register_unix_groups
[7].name = Divert the OpenLDAP environment file
[7]["debops.debops.dpkg_divert"].path = /etc/default/slapd
[8].name = Generate the OpenLDAP environment file
[8]["ansible.builtin.template"].src = etc/default/slapd.j2
[8]["ansible.builtin.template"].dest = /etc/default/slapd
[8]["ansible.builtin.template"].mode = 0644
[8].register = slapd__register_environment
[9].name = Restart slapd if its configuration was modified
[9]["ansible.builtin.service"].name = slapd
[9]["ansible.builtin.service"].state = restarted
[9].when = slapd__register_unix_groups is changed or slapd__register_environment is changed
[10].name = Ensure that the log directory exists
[10]["ansible.builtin.file"].path = {{ slapd__log_dir }}
[10]["ansible.builtin.file"].state = directory
[10]["ansible.builtin.file"].owner = {{ slapd__user }}
[10]["ansible.builtin.file"].group = {{ slapd__group }}
[10]["ansible.builtin.file"].mode = 0750
[11].name = Install helper scripts
[11]["ansible.builtin.copy"].src = usr/local/sbin/
[11]["ansible.builtin.copy"].dest = /usr/local/sbin/
[11]["ansible.builtin.copy"].mode = 0755
[11].tags[0] = role::slapd:scripts
[12].name = Ensure that DebOps schema directory exists
[12]["ansible.builtin.file"].path = {{ slapd__debops_schema_path }}
[12]["ansible.builtin.file"].state = directory
[12]["ansible.builtin.file"].mode = 0755
[13].name = Copy custom DebOps schemas to the OpenLDAP host
[13]["ansible.builtin.copy"].src = etc/ldap/schema/debops/
[13]["ansible.builtin.copy"].dest = {{ slapd__debops_schema_path + "/" }}
[13]["ansible.builtin.copy"].mode = 0644
[14].name = Load custom LDAP schemas
[14]["ansible.builtin.script"] = script/ldap-load-schema {{ item }}
[14].loop = {{ q("flattened", slapd__combined_schemas) }}
[14].register = slapd__register_load_schemas
[14].changed_when = (slapd__register_load_schemas.stdout | d() and (item | basename | regex_replace('.schema$', '') + ' already exists in the LDAP, skippingâ€¦') not in slapd__register_load_schemas.stdout_lines)
[14].tags[0] = role::slapd:schema
[15].name = Ensure that additional database directories exist
[15]["ansible.builtin.file"].path = {{ item }}
[15]["ansible.builtin.file"].state = directory
[15]["ansible.builtin.file"].owner = {{ slapd__user }}
[15]["ansible.builtin.file"].group = {{ slapd__group }}
[15]["ansible.builtin.file"].mode = 0755
[15].loop = {{ slapd__additional_database_dirs }}
[16].name = Configure backup snapshots as cron jobs
[16]["ansible.builtin.cron"].name = Create {{ item }} backup snapshots of OpenLDAP databases
[16]["ansible.builtin.cron"].special_time = {{ item }}
[16]["ansible.builtin.cron"].cron_file = slapd-snapshot
[16]["ansible.builtin.cron"].user = root
[16]["ansible.builtin.cron"].state = {{ slapd__snapshot_deploy_state
               if (item in slapd__snapshot_cron_jobs)
               else "absent" }}
[16]["ansible.builtin.cron"].job = /usr/local/sbin/slapd-snapshot {{ item }}
[16].loop[0] = daily
[16].loop[1] = weekly
[16].loop[2] = monthly
[16].loop_control.label = {{ {"state": (slapd__snapshot_deploy_state
                          if (item in slapd__snapshot_cron_jobs)
                          else "absent"),
                "cron_job": item} }}
[17].name = Make sure that Ansible local facts directory exists
[17]["ansible.builtin.file"].path = /etc/ansible/facts.d
[17]["ansible.builtin.file"].state = directory
[17]["ansible.builtin.file"].mode = 0755
[18].name = Save OpenLDAP server local facts
[18]["ansible.builtin.template"].src = etc/ansible/facts.d/slapd.fact.j2
[18]["ansible.builtin.template"].dest = /etc/ansible/facts.d/slapd.fact
[18]["ansible.builtin.template"].mode = 0755
[18].notify[0] = Refresh host facts
[18].tags[0] = meta::facts
[19].name = Update Ansible facts if they were modified
[19]["ansible.builtin.meta"] = flush_handlers
[20].name = Perform OpenLDAP tasks
[20]["ansible.builtin.include_tasks"] = slapd_tasks.yml
[20].loop = {{ q("flattened", slapd__combined_tasks) | debops.debops.parse_kv_items }}
[20].loop_control.label = {{ {"state": item.state,
                "dn": item.dn,
                "attributes": item.attributes | d({})} }}
[20].when = item.name | d() and item.dn | d() and item.state | d('present') not in [ 'init', 'ignore' ]
[20].tags[0] = role::slapd:tasks
[20].no_log = {{ debops__no_log | d(item.no_log)
              | d(True
                  if ("userPassword" in (item.attributes | d({})).keys() or
                      "olcRootPW" in (item.attributes | d({})).keys())
                  else False) }}
[21].name = Remove slapacl test suite if requested
[21]["ansible.builtin.file"].path = {{ slapd__slapacl_script }}
[21]["ansible.builtin.file"].state = absent
[21].when = slapd__slapacl_deploy_state == 'absent'
[21].tags[0] = role::slapd:slapacl
[21].tags[1] = role::slapd:tasks
[22].name = Perform OpenLDAP slapacl tasks
[22]["ansible.builtin.include_tasks"] = slapd_tasks.yml
[22].loop = {{ q("flattened", slapd__slapacl_combined_tasks) | debops.debops.parse_kv_items }}
[22].loop_control.label = {{ {"state": item.state,
                "dn": item.dn,
                "attributes": item.attributes | d({})} }}
[22].when = slapd__slapacl_deploy_state == 'present' and item.name | d() and item.dn | d() and item.state | d('present') not in [ 'init', 'ignore' ]
[22].tags[0] = role::slapd:slapacl
[22].tags[1] = role::slapd:tasks
[22].no_log = {{ debops__no_log | d(item.no_log)
              | d(True
                  if ("userPassword" in (item.attributes | d({})).keys() or
                      "olcRootPW" in (item.attributes | d({})).keys())
                  else False) }}
[23].name = Generate slapacl test suite script
[23]["ansible.builtin.template"].src = etc/ldap/slapacl-test-suite.j2
[23]["ansible.builtin.template"].dest = {{ slapd__slapacl_script }}
[23]["ansible.builtin.template"].group = {{ slapd__group }}
[23]["ansible.builtin.template"].mode = 0750
[23].register = slapd__register_slapacl_script
[23].when = slapd__slapacl_deploy_state == 'present'
[23].tags[0] = role::slapd:slapacl
[23].tags[1] = role::slapd:tasks
[24].name = Test ACL rules using slapacl
[24].environment.SLAPACL_STDOUT = false
[24]["ansible.builtin.command"] = {{ slapd__slapacl_script }}
[24].become = True
[24].become_user = {{ slapd__user }}
[24].register = slapd__register_slapacl_test
[24].when = slapd__slapacl_deploy_state == 'present' and slapd__slapacl_run_tests | bool
[24].changed_when = slapd__register_slapacl_test.stderr | d()
[24].tags[0] = role::slapd:slapacl
[24].tags[1] = role::slapd:tasks
