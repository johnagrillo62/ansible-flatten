[0].name = Generate a random string for test
[0].set_fact.test_id = {{ lookup('password', '/dev/null chars=ascii_letters length=16') }}
[0].when = test_id is not defined
[1].name = Generate names
[1].set_fact.src_cred_name = AWX-Collection-tests-credential_input_source-src_cred-{{ test_id }}
[1].set_fact.target_cred_name = AWX-Collection-tests-credential_input_source-target_cred-{{ test_id }}
[2].name = detect credential types
[2]["ansible.builtin.set_fact"].credentials = {{ lookup('awx.awx.controller_api', 'credential_types') }}
[3].name = Register Credentials found
[3].set_fact.cyberark_found = {{ 'CyberArk Central Credential Provider Lookup' in credentials | map(attribute='name') | list }}
[4].name = Test credential lookup workflow
[4].when = cyberark_found
[4].block[0].name = Add credential Lookup
[4].block[0].credential.description = Credential for Testing Source
[4].block[0].credential.name = {{ src_cred_name }}
[4].block[0].credential.credential_type = CyberArk Central Credential Provider Lookup
[4].block[0].credential.inputs.url = https://cyberark.example.com
[4].block[0].credential.inputs.app_id = My-App-ID
[4].block[0].credential.organization = Default
[4].block[0].register = src_cred_result
[4].block[1].assert.that[0] = src_cred_result is changed
[4].block[2].name = Add credential Target
[4].block[2].credential.description = Credential for Testing Target
[4].block[2].credential.name = {{ target_cred_name }}
[4].block[2].credential.credential_type = Machine
[4].block[2].credential.inputs.username = user
[4].block[2].credential.organization = Default
[4].block[2].register = target_cred_result
[4].block[3].assert.that[0] = target_cred_result is changed
[4].block[4].name = Add credential Input Source
[4].block[4].credential_input_source.input_field_name = password
[4].block[4].credential_input_source.target_credential = {{ target_cred_result.id }}
[4].block[4].credential_input_source.source_credential = {{ src_cred_result.id }}
[4].block[4].credential_input_source.metadata.object_query = Safe=MY_SAFE;Object=AWX-user
[4].block[4].credential_input_source.metadata.object_query_format = Exact
[4].block[4].credential_input_source.state = present
[4].block[4].register = result
[4].block[5].assert.that[0] = result is changed
[4].block[6].name = Add credential Input Source with exists
[4].block[6].credential_input_source.input_field_name = password
[4].block[6].credential_input_source.target_credential = {{ target_cred_result.id }}
[4].block[6].credential_input_source.source_credential = {{ src_cred_result.id }}
[4].block[6].credential_input_source.metadata.object_query = Safe=MY_SAFE;Object=AWX-user
[4].block[6].credential_input_source.metadata.object_query_format = Exact
[4].block[6].credential_input_source.state = exists
[4].block[6].register = result
[4].block[7].assert.that[0] = result is not changed
[4].block[8].name = Delete credential Input Source
[4].block[8].credential_input_source.input_field_name = password
[4].block[8].credential_input_source.target_credential = {{ target_cred_result.id }}
[4].block[8].credential_input_source.source_credential = {{ src_cred_result.id }}
[4].block[8].credential_input_source.metadata.object_query = Safe=MY_SAFE;Object=AWX-user
[4].block[8].credential_input_source.metadata.object_query_format = Exact
[4].block[8].credential_input_source.state = absent
[4].block[8].register = result
[4].block[9].assert.that[0] = result is changed
[4].block[10].name = Add credential Input Source with exists
[4].block[10].credential_input_source.input_field_name = password
[4].block[10].credential_input_source.target_credential = {{ target_cred_result.id }}
[4].block[10].credential_input_source.source_credential = {{ src_cred_result.id }}
[4].block[10].credential_input_source.metadata.object_query = Safe=MY_SAFE;Object=AWX-user
[4].block[10].credential_input_source.metadata.object_query_format = Exact
[4].block[10].credential_input_source.state = exists
[4].block[10].register = result
[4].block[11].assert.that[0] = result is changed
[4].block[12].name = Add Second credential Lookup
[4].block[12].credential.description = Credential for Testing Source Change
[4].block[12].credential.name = {{ src_cred_name }}-2
[4].block[12].credential.credential_type = CyberArk Central Credential Provider Lookup
[4].block[12].credential.inputs.url = https://cyberark-prod.example.com
[4].block[12].credential.inputs.app_id = My-App-ID
[4].block[12].credential.organization = Default
[4].block[12].register = result
[4].block[13].name = Change credential Input Source
[4].block[13].credential_input_source.input_field_name = password
[4].block[13].credential_input_source.target_credential = {{ target_cred_name }}
[4].block[13].credential_input_source.source_credential = {{ src_cred_name }}-2
[4].block[13].credential_input_source.state = present
[4].block[14].assert.that[0] = result is changed
[5].name = Clean up if previous block ran
[5].when = cyberark_found
[5].block[0].name = Remove a credential source
[5].block[0].credential_input_source.input_field_name = password
[5].block[0].credential_input_source.target_credential = {{ target_cred_name }}
[5].block[0].credential_input_source.state = absent
[5].block[0].register = result
[5].block[1].assert.that[0] = result is changed
[5].block[2].name = Remove credential Lookup
[5].block[2].credential.name = {{ src_cred_name }}
[5].block[2].credential.organization = Default
[5].block[2].credential.credential_type = CyberArk Central Credential Provider Lookup
[5].block[2].credential.state = absent
[5].block[2].register = result
[5].block[3].name = Remove Alt credential Lookup
[5].block[3].credential.name = {{ src_cred_name }}-2
[5].block[3].credential.organization = Default
[5].block[3].credential.credential_type = CyberArk Central Credential Provider Lookup
[5].block[3].credential.state = absent
[5].block[3].register = result
[5].block[4].name = Remove credential
[5].block[4].credential.name = {{ target_cred_name }}
[5].block[4].credential.organization = Default
[5].block[4].credential.credential_type = Machine
[5].block[4].credential.state = absent
[5].block[4].register = result
