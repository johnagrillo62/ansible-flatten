[0].name = Import DebOps global handlers
[0]["ansible.builtin.import_role"].name = global_handlers
[1].name = Make sure that Ansible local facts directory exists
[1]["ansible.builtin.file"].path = /etc/ansible/facts.d
[1]["ansible.builtin.file"].state = directory
[1]["ansible.builtin.file"].mode = 0755
[2].name = Save systemd local facts
[2]["ansible.builtin.template"].src = etc/ansible/facts.d/systemd.fact.j2
[2]["ansible.builtin.template"].dest = /etc/ansible/facts.d/systemd.fact
[2]["ansible.builtin.template"].mode = 0755
[2].notify[0] = Refresh host facts
[2].tags[0] = meta::facts
[3].name = Update Ansible facts if they were modified
[3]["ansible.builtin.meta"] = flush_handlers
[4].name = Remove systemd configuuration if requested
[4]["ansible.builtin.file"].path = {{ "/etc/systemd/" + item + ".d/ansible.conf" }}
[4]["ansible.builtin.file"].state = absent
[4].loop[0] = system.conf
[4].loop[1] = user.conf
[4].loop[2] = logind.conf
[4].notify[0] = Reload systemd daemon
[4].when = systemd__enabled | bool and systemd__deploy_state == 'absent'
[5].name = Create systemd configuration directories
[5]["ansible.builtin.file"].path = {{ "/etc/systemd/" + item + ".d" }}
[5]["ansible.builtin.file"].state = directory
[5]["ansible.builtin.file"].mode = 0755
[5].loop[0] = system.conf
[5].loop[1] = user.conf
[5].loop[2] = logind.conf
[5].when = systemd__enabled | bool and systemd__deploy_state != 'absent'
[6].name = Generate systemd configuration
[6]["ansible.builtin.template"].src = {{ "etc/systemd/" + item + ".d/ansible.conf.j2" }}
[6]["ansible.builtin.template"].dest = {{ "/etc/systemd/" + item + ".d/ansible.conf" }}
[6]["ansible.builtin.template"].mode = 0644
[6].loop[0] = system.conf
[6].loop[1] = user.conf
[6].loop[2] = logind.conf
[6].notify[0] = Reload systemd daemon
[6].when = systemd__enabled | bool and systemd__deploy_state != 'absent'
[7].name = Remove system units if requested
[7]["ansible.builtin.file"].path = {{ "/etc/systemd/system/" + item.name }}
[7]["ansible.builtin.file"].state = absent
[7].loop = {{ systemd__combined_units | flatten | debops.debops.parse_kv_items }}
[7].loop_control.label = {{ {"name": item.name, "state": item.state | d("present")} }}
[7].register = systemd__register_units_removed
[7].notify[0] = Reload systemd daemon
[7].when = systemd__enabled | bool and item.state | d("present") == 'absent'
[8].name = Remove system unit overrides if requested
[8]["ansible.builtin.file"].path = {{ "/etc/systemd/system/" + item.name + ".d" }}
[8]["ansible.builtin.file"].state = absent
[8].loop = {{ systemd__combined_units | flatten | debops.debops.parse_kv_items }}
[8].loop_control.label = {{ {"name": item.name, "state": item.state | d("present")} }}
[8].notify[0] = Reload systemd daemon
[8].when = systemd__enabled | bool and item.state | d("present") == 'absent'
[9].name = Create directories for system units
[9]["ansible.builtin.file"].path = {{ "/etc/systemd/system/" + (item.name | dirname) }}
[9]["ansible.builtin.file"].state = directory
[9]["ansible.builtin.file"].mode = 0755
[9].loop = {{ systemd__combined_units | flatten | debops.debops.parse_kv_items }}
[9].loop_control.label = {{ {"name": item.name, "state": item.state | d("present")} }}
[9].when = systemd__enabled | bool and item.raw | d() and item.state | d("present") not in ['absent', 'ignore', 'init'] and (item.name | dirname).endswith('.d')
[10].name = Generate system units
[10]["ansible.builtin.template"].src = etc/systemd/system/template.j2
[10]["ansible.builtin.template"].dest = {{ "/etc/systemd/system/" + item.name }}
[10]["ansible.builtin.template"].mode = 0644
[10].loop = {{ systemd__combined_units | flatten | debops.debops.parse_kv_items }}
[10].loop_control.label = {{ {"name": item.name, "state": item.state | d("present")} }}
[10].register = systemd__register_units_created
[10].notify[0] = Reload systemd daemon
[10].when = systemd__enabled | bool and item.raw | d() and item.state | d("present") not in ['absent', 'ignore', 'init']
[11].name = Remove user units if requested
[11]["ansible.builtin.file"].path = {{ "/etc/systemd/user/" + item.name }}
[11]["ansible.builtin.file"].state = absent
[11].loop = {{ systemd__user_combined_units | flatten | debops.debops.parse_kv_items }}
[11].loop_control.label = {{ {"name": item.name, "state": item.state | d("present")} }}
[11].notify[0] = Reload systemd daemon
[11].when = systemd__enabled | bool and item.state | d("present") == 'absent'
[12].name = Remove user unit overrides if requested
[12]["ansible.builtin.file"].path = {{ "/etc/systemd/user/" + item.name + ".d" }}
[12]["ansible.builtin.file"].state = absent
[12].loop = {{ systemd__user_combined_units | flatten | debops.debops.parse_kv_items }}
[12].loop_control.label = {{ {"name": item.name, "state": item.state | d("present")} }}
[12].notify[0] = Reload systemd daemon
[12].when = systemd__enabled | bool and item.state | d("present") == 'absent'
[13].name = Create directories for user units
[13]["ansible.builtin.file"].path = {{ "/etc/systemd/user/" + (item.name | dirname) }}
[13]["ansible.builtin.file"].state = directory
[13]["ansible.builtin.file"].mode = 0755
[13].loop = {{ systemd__user_combined_units | flatten | debops.debops.parse_kv_items }}
[13].loop_control.label = {{ {"name": item.name, "state": item.state | d("present")} }}
[13].when = systemd__enabled | bool and item.raw | d() and item.state | d("present") not in ['absent', 'ignore', 'init'] and (item.name | dirname).endswith('.d')
[14].name = Generate user units
[14]["ansible.builtin.template"].src = etc/systemd/user/template.j2
[14]["ansible.builtin.template"].dest = {{ "/etc/systemd/user/" + item.name }}
[14]["ansible.builtin.template"].mode = 0644
[14].loop = {{ systemd__user_combined_units | flatten | debops.debops.parse_kv_items }}
[14].loop_control.label = {{ {"name": item.name, "state": item.state | d("present")} }}
[14].notify[0] = Reload systemd daemon
[14].when = systemd__enabled | bool and item.raw | d() and item.state | d("present") not in ['absent', 'ignore', 'init']
[15].name = Flush handlers when needed
[15]["ansible.builtin.meta"] = flush_handlers
[16].name = Configure system units
[16]["ansible.builtin.systemd"].name = {{ item.name }}
[16]["ansible.builtin.systemd"].enabled = {{ item.enabled | d(False if (item.masked | d() | bool) else True) }}
[16]["ansible.builtin.systemd"].force = {{ item.force | d(omit) }}
[16]["ansible.builtin.systemd"].masked = {{ item.masked | d(omit) }}
[16]["ansible.builtin.systemd"].state = {{ item.state if (item.state in ["reloaded", "restarted", "started", "stopped"]) else omit }}
[16].loop = {{ systemd__combined_units | flatten | debops.debops.parse_kv_items }}
[16].loop_control.label = {{ {"name": item.name, "state": item.state | d("present")} }}
[16].when = systemd__enabled | bool and item.state | d("present") not in ['absent', 'ignore', 'init'] and not (item.name | dirname).endswith('.d')
[17].name = Restart system units if modified
[17]["ansible.builtin.systemd"].name = {{ item.restart }}
[17]["ansible.builtin.systemd"].state = restarted
[17].loop = {{ systemd__combined_units | flatten | debops.debops.parse_kv_items }}
[17].loop_control.label = {{ {"restart": item.restart | d()} }}
[17].when = systemd__enabled | bool and item.restart | d() and item.state | d("present") not in ['ignore', 'init'] and ((item.name in (systemd__register_units_removed.results | selectattr("changed", "true") | map(attribute="item.name") | list)) or (item.name in (systemd__register_units_created.results | selectattr("changed", "true") | map(attribute="item.name") | list)))
[18].name = Configure user units
[18]["ansible.builtin.systemd"].name = {{ item.name }}
[18]["ansible.builtin.systemd"].enabled = {{ item.enabled | d(False if (item.masked | d() | bool) else True) }}
[18]["ansible.builtin.systemd"].force = {{ item.force | d(omit) }}
[18]["ansible.builtin.systemd"].masked = {{ item.masked | d(omit) }}
[18]["ansible.builtin.systemd"].state = {{ item.state if (item.state in ["reloaded", "restarted", "started", "stopped"]) else omit }}
[18]["ansible.builtin.systemd"].scope = global
[18].loop = {{ systemd__user_combined_units | flatten | debops.debops.parse_kv_items }}
[18].loop_control.label = {{ {"name": item.name, "state": item.state | d("present")} }}
[18].when = systemd__enabled | bool and item.state | d("present") not in ['absent', 'ignore', 'init'] and not (item.name | dirname).endswith('.d')
