~d0.name = Stop if legacy encapsulation variables are detected (ipip)
~d1.assert = 
~d2.that = 
~d2.msg = "'ipip' configuration variable is deprecated, please configure your inventory with 'calico_ipip_mode' set to 'Always' or 'CrossSubnet' according to your specific needs"
~d1.run_once = true
~d1.delegate_to = "{{ groups['kube_control_plane'][0] }}"
~d0.name = Stop if legacy encapsulation variables are detected (ipip_mode)
~d1.assert = 
~d2.that = 
~d2.msg = "'ipip_mode' configuration variable is deprecated, please configure your inventory with 'calico_ipip_mode' set to 'Always' or 'CrossSubnet' according to your specific needs"
~d1.run_once = true
~d1.delegate_to = "{{ groups['kube_control_plane'][0] }}"
~d0.name = Stop if legacy encapsulation variables are detected (calcio_ipam_autoallocateblocks)
~d1.assert = 
~d2.that = 
~d2.msg = "'calcio_ipam_autoallocateblocks' configuration variable is deprecated, it's a typo, please configure your inventory with 'calico_ipam_autoallocateblocks' set to 'true' or 'false' according to your specific needs"
~d1.run_once = true
~d1.delegate_to = "{{ groups['kube_control_plane'][0] }}"
~d0.name = Stop if supported Calico versions
~d1.assert = 
~d2.that = 
~d2.msg = "Calico version not supported {{ calico_version }} not in {{ calico_crds_checksums.no_arch.keys() }}"
~d1.run_once = true
~d1.delegate_to = "{{ groups['kube_control_plane'][0] }}"
~d0.name = Check if calicoctl.sh exists
~d1.stat = 
~d2.path = "{{ bin_dir }}/calicoctl.sh"
~d1.register = calicoctl_sh_exists
~d1.run_once = true
~d1.delegate_to = "{{ groups['kube_control_plane'][0] }}"
~d0.name = Check if calico ready
~d1.command = "{{ bin_dir }}/calicoctl.sh get ClusterInformation default"
~d1.register = calico_ready
~d1.run_once = true
~d1.ignore_errors = true
~d1.retries = 5
~d1.delay = 10
~d1.until = calico_ready.rc == 0
~d1.delegate_to = "{{ groups['kube_control_plane'][0] }}"
~d1.when = calicoctl_sh_exists.stat.exists
~d0.name = Check that current calico version is enough for upgrade
~d1.run_once = true
~d1.delegate_to = "{{ groups['kube_control_plane'][0] }}"
~d1.when = calicoctl_sh_exists.stat.exists and calico_ready.rc == 0
~d1.block = 
~d2.name = Get current calico version
~d3.shell = "set -o pipefail && {{ bin_dir }}/calicoctl.sh version | grep 'Client Version:' | awk '{ print $3}'"
~d3.args = 
~d4.executable = /bin/bash
~d3.register = calico_version_on_server
~d3.changed_when = false
~d3.check_mode = false
~d2.name = Assert that current calico version is enough for upgrade
~d3.assert = 
~d4.that = 
~d4.msg = >
~d0.name = "Check that cluster_id is set and a valid IPv4 address if calico_rr enabled"
~d1.assert = 
~d2.that = 
~d2.msg = "A unique cluster_id is required if using calico_rr, and it must be a valid IPv4 address"
~d1.when = 
~d1.run_once = true
~d1.delegate_to = "{{ groups['kube_control_plane'][0] }}"
~d0.name = "Check that calico_rr nodes are in k8s_cluster group"
~d1.assert = 
~d2.that = 
~d2.msg = "calico_rr must be a child group of k8s_cluster group"
~d1.when = 
~d1.run_once = true
~d1.delegate_to = "{{ groups['kube_control_plane'][0] }}"
~d0.name = "Check vars defined correctly"
~d1.assert = 
~d2.that = 
~d2.msg = "calico_pool_name contains invalid characters"
~d1.run_once = true
~d1.delegate_to = "{{ groups['kube_control_plane'][0] }}"
~d0.name = "Check calico network backend defined correctly"
~d1.assert = 
~d2.that = 
~d2.msg = "calico network backend is not 'bird', 'vxlan' or 'none'"
~d1.run_once = true
~d1.delegate_to = "{{ groups['kube_control_plane'][0] }}"
~d0.name = "Check ipip and vxlan mode defined correctly"
~d1.run_once = true
~d1.delegate_to = "{{ groups['kube_control_plane'][0] }}"
~d1.assert = 
~d2.that = 
~d2.msg = "calico inter host encapsulation mode is not 'Always', 'CrossSubnet' or 'Never'"
~d0.name = "Check ipip and vxlan mode if simultaneously enabled"
~d1.assert = 
~d2.that = 
~d2.msg = "IP in IP and VXLAN mode is mutualy exclusive modes"
~d1.when = 
~d1.run_once = true
~d1.delegate_to = "{{ groups['kube_control_plane'][0] }}"
~d0.name = "Check ipip and vxlan mode if simultaneously enabled"
~d1.assert = 
~d2.that = 
~d2.msg = "IP in IP and VXLAN mode is mutualy exclusive modes"
~d1.when = 
~d1.run_once = true
~d1.delegate_to = "{{ groups['kube_control_plane'][0] }}"
~d0.name = "Get Calico {{ calico_pool_name }} configuration"
~d1.command = "{{ bin_dir }}/calicoctl.sh get ipPool {{ calico_pool_name }} -o json"
~d1.failed_when = false
~d1.changed_when = false
~d1.check_mode = false
~d1.register = calico
~d1.run_once = true
~d1.when = ipv4_stack | bool
~d1.delegate_to = "{{ groups['kube_control_plane'][0] }}"
~d0.name = "Set calico_pool_conf"
~d1.set_fact = 
~d2.calico_pool_conf = '{{ calico.stdout | from_json }}'
~d1.when = 
~d1.run_once = true
~d1.delegate_to = "{{ groups['kube_control_plane'][0] }}"
~d0.name = "Check if inventory match current cluster configuration"
~d1.assert = 
~d2.that = 
~d2.msg = "Your inventory doesn't match the current cluster configuration"
~d1.when = 
~d1.run_once = true
~d1.delegate_to = "{{ groups['kube_control_plane'][0] }}"
~d0.name = "Get Calico {{ calico_pool_name }}-ipv6 configuration"
~d1.command = "{{ bin_dir }}/calicoctl.sh get ipPool {{ calico_pool_name }}-ipv6 -o json"
~d1.failed_when = false
~d1.changed_when = false
~d1.check_mode = false
~d1.register = calico_ipv6
~d1.run_once = true
~d1.when = ipv6_stack | bool
~d1.delegate_to = "{{ groups['kube_control_plane'][0] }}"
~d0.name = "Set calico_pool_ipv6_conf"
~d1.set_fact = 
~d2.calico_pool_conf = '{{ calico_ipv6.stdout | from_json }}'
~d1.when = 
~d1.run_once = true
~d1.delegate_to = "{{ groups['kube_control_plane'][0] }}"
~d0.name = "Check if ipv6 inventory match current cluster configuration"
~d1.assert = 
~d2.that = 
~d2.msg = "Your ipv6 inventory doesn't match the current cluster configuration"
~d1.when = 
~d1.run_once = true
~d1.delegate_to = "{{ groups['kube_control_plane'][0] }}"
~d0.name = "Check kdd calico_datastore if calico_apiserver_enabled"
~d1.assert = 
~d2.that = calico_datastore == "kdd"
~d2.msg = "When using calico apiserver you need to use the kubernetes datastore"
~d1.when = 
~d1.run_once = true
~d1.delegate_to = "{{ groups['kube_control_plane'][0] }}"
~d0.name = "Check kdd calico_datastore if typha_enabled"
~d1.assert = 
~d2.that = calico_datastore == "kdd"
~d2.msg = "When using typha you need to use the kubernetes datastore"
~d1.when = 
~d1.run_once = true
~d1.delegate_to = "{{ groups['kube_control_plane'][0] }}"
~d0.name = "Check ipip mode is Never for calico ipv6"
~d1.assert = 
~d2.that = 
~d2.msg = "Calico doesn't support ipip tunneling for the IPv6"
~d1.when = ipv6_stack | bool
~d1.run_once = true
~d1.delegate_to = "{{ groups['kube_control_plane'][0] }}"
