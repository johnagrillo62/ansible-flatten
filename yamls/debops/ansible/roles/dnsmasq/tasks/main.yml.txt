[0].name = Import custom Ansible plugins
[0]["ansible.builtin.import_role"].name = ansible_plugins
[1].name = Import DebOps global handlers
[1]["ansible.builtin.import_role"].name = global_handlers
[2].name = Install required packages
[2]["ansible.builtin.package"].name = {{ q("flattened", (dnsmasq__base_packages + dnsmasq__packages)) }}
[2]["ansible.builtin.package"].state = present
[2].register = dnsmasq__register_packages
[2].until = dnsmasq__register_packages is succeeded
[3].name = Make sure Ansible fact directory exists
[3]["ansible.builtin.file"].path = /etc/ansible/facts.d
[3]["ansible.builtin.file"].state = directory
[3]["ansible.builtin.file"].owner = root
[3]["ansible.builtin.file"].group = root
[3]["ansible.builtin.file"].mode = 0755
[4].name = Generate dnsmasq Ansible local facts
[4]["ansible.builtin.template"].src = etc/ansible/facts.d/dnsmasq.fact.j2
[4]["ansible.builtin.template"].dest = /etc/ansible/facts.d/dnsmasq.fact
[4]["ansible.builtin.template"].owner = root
[4]["ansible.builtin.template"].group = root
[4]["ansible.builtin.template"].mode = 0755
[4]["ansible.builtin.template"].unsafe_writes = {{ True if (core__unsafe_writes | d(ansible_local.core.unsafe_writes | d()) | bool) else omit }}
[4].notify[0] = Refresh host facts
[4].tags[0] = meta::facts
[5].name = Reload facts if they were modified
[5]["ansible.builtin.meta"] = flush_handlers
[6].name = Make sure TFTP root directory exists
[6]["ansible.builtin.file"].path = {{ dnsmasq__boot_tftp_root }}
[6]["ansible.builtin.file"].state = directory
[6]["ansible.builtin.file"].owner = root
[6]["ansible.builtin.file"].group = root
[6]["ansible.builtin.file"].mode = 0755
[6].when = dnsmasq__boot_enabled | bool
[7].name = Remove dnsmasq configuration if requested
[7]["ansible.builtin.file"].path = /etc/dnsmasq.d/{{ item.filename | d(item.name | regex_replace("\.conf$", "") + ".conf") }}
[7]["ansible.builtin.file"].state = absent
[7].with_items = {{ dnsmasq__combined_configuration | debops.debops.parse_kv_items }}
[7].notify[0] = Test and restart dnsmasq
[7].when = (item.name | d() and item.state | d('present') == 'absent')
[8].name = Generate dnsmasq configuration
[8]["ansible.builtin.template"].src = etc/dnsmasq.d/template.conf.j2
[8]["ansible.builtin.template"].dest = /etc/dnsmasq.d/{{ item.filename | d(item.name | regex_replace(".conf$", "") + ".conf") }}
[8]["ansible.builtin.template"].owner = root
[8]["ansible.builtin.template"].group = root
[8]["ansible.builtin.template"].mode = 0644
[8].with_items = {{ dnsmasq__combined_configuration | debops.debops.parse_kv_items }}
[8].notify[0] = Test and restart dnsmasq
[8].when = (item.name | d() and item.state | d('present') not in ['absent', 'ignore', 'init'])
[9].name = Remove DHCP host configuration and DNS records if requested
[9]["ansible.builtin.file"].path = /etc/dnsmasq.d/{{ dnsmasq__dhcp_dns_filename }}
[9]["ansible.builtin.file"].state = absent
[9].notify[0] = Test and restart dnsmasq
[9].when = not dnsmasq__dhcp_hosts | d() and not dnsmasq__dns_records | d()
[10].name = Generate DHCP host configuration and DNS records
[10]["ansible.builtin.template"].src = etc/dnsmasq.d/dhcp-dns-options.conf.j2
[10]["ansible.builtin.template"].dest = /etc/dnsmasq.d/{{ dnsmasq__dhcp_dns_filename }}
[10]["ansible.builtin.template"].owner = root
[10]["ansible.builtin.template"].group = root
[10]["ansible.builtin.template"].mode = 0644
[10].notify[0] = Test and restart dnsmasq
[10].when = dnsmasq__dhcp_hosts | d() or dnsmasq__dns_records | d()
[11].name = Divert original dnsmasq environment file
[11]["debops.debops.dpkg_divert"].path = /etc/default/dnsmasq
[11].notify[0] = Test and restart dnsmasq
[12].name = Configure dnsmasq environment file
[12]["ansible.builtin.template"].src = etc/default/dnsmasq.j2
[12]["ansible.builtin.template"].dest = /etc/default/dnsmasq
[12]["ansible.builtin.template"].owner = root
[12]["ansible.builtin.template"].group = root
[12]["ansible.builtin.template"].mode = 0644
[12]["ansible.builtin.template"].unsafe_writes = {{ True if (core__unsafe_writes | d(ansible_local.core.unsafe_writes | d()) | bool) else omit }}
[12].notify[0] = Test and restart dnsmasq
[13].name = Configure custom nameservers in resolvconf
[13]["ansible.builtin.template"].src = etc/resolvconf/upstream.conf.j2
[13]["ansible.builtin.template"].dest = /etc/resolvconf/upstream.conf
[13]["ansible.builtin.template"].owner = root
[13]["ansible.builtin.template"].group = root
[13]["ansible.builtin.template"].mode = 0644
[13]["ansible.builtin.template"].unsafe_writes = {{ True if (core__unsafe_writes | d(ansible_local.core.unsafe_writes | d()) | bool) else omit }}
[13].notify[0] = Test and restart dnsmasq
[13].when = dnsmasq__nameservers | d()
