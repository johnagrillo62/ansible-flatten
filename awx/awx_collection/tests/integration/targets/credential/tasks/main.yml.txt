[0].name = Generate a random string for test
[0].set_fact.test_id = {{ lookup('password', '/dev/null chars=ascii_letters length=16') }}
[0].when = test_id is not defined
[1].name = Generate names
[1].set_fact.ssh_cred_name1 = AWX-Collection-tests-credential-ssh-cred1-{{ test_id }}
[1].set_fact.ssh_cred_name2 = AWX-Collection-tests-credential-ssh-cred2-{{ test_id }}
[1].set_fact.ssh_cred_name3 = AWX-Collection-tests-credential-ssh-cred-lookup-source-{{ test_id }}
[1].set_fact.ssh_cred_name4 = AWX-Collection-tests-credential-ssh-cred-file-source-{{ test_id }}
[1].set_fact.vault_cred_name1 = AWX-Collection-tests-credential-vault-cred1-{{ test_id }}
[1].set_fact.vault_cred_name2 = AWX-Collection-tests-credential-vault-ssh-cred1-{{ test_id }}
[1].set_fact.net_cred_name1 = AWX-Collection-tests-credential-net-cred1-{{ test_id }}
[1].set_fact.scm_cred_name1 = AWX-Collection-tests-credential-scm-cred1-{{ test_id }}
[1].set_fact.aws_cred_name1 = AWX-Collection-tests-credential-aws-cred1-{{ test_id }}
[1].set_fact.vmware_cred_name1 = AWX-Collection-tests-credential-vmware-cred1-{{ test_id }}
[1].set_fact.sat6_cred_name1 = AWX-Collection-tests-credential-sat6-cred1-{{ test_id }}
[1].set_fact.gce_cred_name1 = AWX-Collection-tests-credential-gce-cred1-{{ test_id }}
[1].set_fact.azurerm_cred_name1 = AWX-Collection-tests-credential-azurerm-cred1-{{ test_id }}
[1].set_fact.openstack_cred_name1 = AWX-Collection-tests-credential-openstack-cred1-{{ test_id }}
[1].set_fact.rhv_cred_name1 = AWX-Collection-tests-credential-rhv-cred1-{{ test_id }}
[1].set_fact.insights_cred_name1 = AWX-Collection-tests-credential-insights-cred1-{{ test_id }}
[1].set_fact.insights_cred_name2 = AWX-Collection-tests-credential-insights-cred2-{{ test_id }}
[1].set_fact.tower_cred_name1 = AWX-Collection-tests-credential-tower-cred1-{{ test_id }}
[2].name = Get current Credential Types available
[2]["ansible.builtin.set_fact"].credentials = {{ lookup('awx.awx.controller_api', 'credential_types') }}
[3].name = Register Credentials found
[3].set_fact.aws_found = {{ 'Amazon Web Services' in credentials | map(attribute='name') | list }}
[3].set_fact.vmware_found = {{ 'VMware vCenter' in credentials | map(attribute='name') | list }}
[3].set_fact.azure_found = {{ 'Microsoft Azure Resource Manager' in credentials | map(attribute='name') | list }}
[3].set_fact.gce_found = {{ 'Google Compute Engine' in credentials | map(attribute='name') | list }}
[3].set_fact.insights_found = {{ 'Red Hat Insights' in credentials | map(attribute='name') | list }}
[3].set_fact.satellite_found = {{ 'Red Hat Satellite 6' in credentials | map(attribute='name') | list }}
[3].set_fact.openstack_found = {{ 'OpenStack' in credentials | map(attribute='name') | list }}
[3].set_fact.rhv_found = {{ 'Red Hat Virtualization' in credentials | map(attribute='name') | list }}
[4].name = create a tempdir for an SSH key
[4].local_action = shell mktemp -d
[4].register = tempdir
[5].name = Generate a local SSH key
[5].local_action = shell ssh-keygen -b 2048 -t rsa -f {{ tempdir.stdout }}/id_rsa -q -N 'passphrase'
[6].name = Read the generated key
[6].set_fact.ssh_key_data = {{ lookup('file', tempdir.stdout + '/id_rsa') }}
[7].name = Create an Org-specific credential with an ID
[7].credential.name = {{ ssh_cred_name1 }}
[7].credential.organization = Default
[7].credential.credential_type = Machine
[7].credential.state = present
[7].register = result
[8].assert.that[0] = result is changed
[9].name = Create an Org-specific credential with an ID with exists
[9].credential.name = {{ ssh_cred_name1 }}
[9].credential.organization = Default
[9].credential.credential_type = Machine
[9].credential.state = exists
[9].register = result
[10].assert.that[0] = result is not changed
[11].name = Delete an Org-specific credential with an ID
[11].credential.name = {{ ssh_cred_name1 }}
[11].credential.organization = Default
[11].credential.credential_type = Machine
[11].credential.state = absent
[11].register = result
[12].assert.that[0] = result is changed
[13].name = Delete a credential without credential_type
[13].credential.name = {{ ssh_cred_name1 }}
[13].credential.organization = Default
[13].credential.state = absent
[13].register = result
[13].ignore_errors = yes
[14].assert.that[0] = result is failed
[15].name = Create an Org-specific credential with an ID with exists
[15].credential.name = {{ ssh_cred_name1 }}
[15].credential.organization = Default
[15].credential.credential_type = Machine
[15].credential.state = exists
[15].register = result
[16].assert.that[0] = result is changed
[17].name = Delete a Org-specific credential
[17].credential.name = {{ ssh_cred_name1 }}
[17].credential.organization = Default
[17].credential.state = absent
[17].credential.credential_type = Machine
[17].register = result
[18].assert.that[0] = result is changed
[19].name = Create the User-specific credential
[19].credential.name = {{ ssh_cred_name1 }}
[19].credential.user = admin
[19].credential.credential_type = Machine
[19].credential.state = present
[19].register = result
[20].assert.that[0] = result is changed
[21].name = Delete a User-specific credential
[21].credential.name = {{ ssh_cred_name1 }}
[21].credential.user = admin
[21].credential.state = absent
[21].credential.credential_type = Machine
[21].register = result
[22].assert.that[0] = result is changed
[23].name = Create a valid SSH credential
[23].credential.name = {{ ssh_cred_name2 }}
[23].credential.organization = Default
[23].credential.state = present
[23].credential.credential_type = Machine
[23].credential.description = An example SSH credential
[23].credential.inputs.username = joe
[23].credential.inputs.password = secret
[23].credential.inputs.become_method = sudo
[23].credential.inputs.become_username = superuser
[23].credential.inputs.become_password = supersecret
[23].credential.inputs.ssh_key_data = {{ ssh_key_data }}
[23].credential.inputs.ssh_key_unlock = passphrase
[23].register = result
[24].assert.that[0] = result is changed
[25].name = Create a valid SSH credential
[25].credential.name = {{ ssh_cred_name2 }}
[25].credential.organization = Default
[25].credential.state = present
[25].credential.credential_type = Machine
[25].credential.description = An example SSH credential
[25].credential.inputs.username = joe
[25].credential.inputs.become_method = sudo
[25].credential.inputs.become_username = superuser
[25].register = result
[26].assert.that[0] = result is changed
[27].name = Check for inputs idempotency (when "inputs" is blank)
[27].credential.name = {{ ssh_cred_name2 }}
[27].credential.organization = Default
[27].credential.state = present
[27].credential.credential_type = Machine
[27].credential.description = An example SSH credential
[27].register = result
[28].assert.that[0] = result is not changed
[29].name = Copy ssh Credential
[29].credential.name = copy_{{ ssh_cred_name2 }}
[29].credential.copy_from = {{ ssh_cred_name2 }}
[29].credential.credential_type = Machine
[29].register = result
[30].assert.that[0] = result.copied
[31].name = Delete an SSH credential
[31].credential.name = copy_{{ ssh_cred_name2 }}
[31].credential.organization = Default
[31].credential.state = absent
[31].credential.credential_type = Machine
[31].register = result
[32].assert.that[0] = result is changed
[33].name = Create a valid SSH credential from lookup source
[33].credential.name = {{ ssh_cred_name3 }}
[33].credential.organization = Default
[33].credential.state = present
[33].credential.credential_type = Machine
[33].credential.description = An example SSH credential from lookup source
[33].credential.inputs.username = joe
[33].credential.inputs.password = secret
[33].credential.inputs.become_method = sudo
[33].credential.inputs.become_username = superuser
[33].credential.inputs.become_password = supersecret
[33].credential.inputs.ssh_key_data = {{ lookup('file', tempdir.stdout + '/id_rsa') }}
[33].credential.inputs.ssh_key_unlock = passphrase
[33].register = result
[34].assert.that[0] = result is changed
[35].name = Delete an SSH credential
[35].credential.name = {{ ssh_cred_name2 }}
[35].credential.organization = Default
[35].credential.state = absent
[35].credential.credential_type = Machine
[35].register = result
[36].assert.that[0] = result is changed
[37].name = Ensure existence of SSH credential
[37].credential.name = {{ ssh_cred_name2 }}
[37].credential.organization = Default
[37].credential.state = exists
[37].credential.credential_type = Machine
[37].credential.description = An example SSH awx.awx.credential
[37].credential.inputs.username = joe
[37].credential.inputs.password = secret
[37].credential.inputs.become_method = sudo
[37].credential.inputs.become_username = superuser
[37].credential.inputs.become_password = supersecret
[37].credential.inputs.ssh_key_data = {{ ssh_key_data }}
[37].credential.inputs.ssh_key_unlock = passphrase
[37].register = result
[38].assert.that[0] = result is changed
[39].name = Ensure existence of SSH credential, not updating any inputs
[39].credential.name = {{ ssh_cred_name2 }}
[39].credential.organization = Default
[39].credential.state = exists
[39].credential.credential_type = Machine
[39].credential.description = An example SSH awx.awx.credential
[39].credential.inputs.username = joe
[39].credential.inputs.password = no-update-secret
[39].credential.inputs.become_method = sudo
[39].credential.inputs.become_username = some-other-superuser
[39].credential.inputs.become_password = some-other-secret
[39].credential.inputs.ssh_key_data = {{ ssh_key_data }}
[39].credential.inputs.ssh_key_unlock = another-pass-phrase
[39].register = result
[40].assert.that[0] = result is not changed
[41].name = Create an invalid SSH credential (passphrase required)
[41].credential.name = SSH Credential
[41].credential.organization = Default
[41].credential.state = present
[41].credential.credential_type = Machine
[41].credential.inputs.username = joe
[41].credential.inputs.ssh_key_data = {{ ssh_key_data }}
[41].ignore_errors = yes
[41].register = result
[42].assert.that[0] = result is failed
[42].assert.that[1] = 'must be set when SSH key is encrypted' in result.msg
[43].name = Create an invalid SSH credential (Organization not found)
[43].credential.name = SSH Credential
[43].credential.organization = Missing_Organization
[43].credential.state = present
[43].credential.credential_type = Machine
[43].credential.inputs.username = joe
[43].ignore_errors = yes
[43].register = result
[44].assert.that[0] = result is failed
[44].assert.that[1] = result is not changed
[44].assert.that[2] = 'Missing_Organization' in result.msg
[44].assert.that[3] = result.total_results == 0
[45].name = Delete an SSH credential
[45].credential.name = {{ ssh_cred_name2 }}
[45].credential.organization = Default
[45].credential.state = absent
[45].credential.credential_type = Machine
[45].register = result
[46].assert.that[0] = result is changed
[47].name = Delete an SSH credential
[47].credential.name = {{ ssh_cred_name3 }}
[47].credential.organization = Default
[47].credential.state = absent
[47].credential.credential_type = Machine
[47].register = result
[48].assert.that[0] = result is changed
[49].name = Delete an SSH credential
[49].credential.name = {{ ssh_cred_name4 }}
[49].credential.organization = Default
[49].credential.state = absent
[49].credential.credential_type = Machine
[49].register = result
[50].assert.that[0] = result is not changed
[51].name = Create a valid Vault credential
[51].credential.name = {{ vault_cred_name1 }}
[51].credential.organization = Default
[51].credential.state = present
[51].credential.credential_type = Vault
[51].credential.description = An example Vault credential
[51].credential.inputs.vault_id = bar
[51].credential.inputs.vault_password = secret-vault
[51].register = result
[52].assert.that[0] = result is changed
[53].name = Delete a Vault credential
[53].credential.name = {{ vault_cred_name1 }}
[53].credential.organization = Default
[53].credential.state = absent
[53].credential.credential_type = Vault
[53].register = result
[54].assert.that[0] = result is changed
[55].name = Delete a Vault credential
[55].credential.name = {{ vault_cred_name2 }}
[55].credential.organization = Default
[55].credential.state = absent
[55].credential.credential_type = Vault
[55].register = result
[56].assert.that[0] = result is not changed
[57].name = Create a valid Network credential
[57].credential.name = {{ net_cred_name1 }}
[57].credential.organization = Default
[57].credential.state = present
[57].credential.credential_type = Network
[57].credential.inputs.username = joe
[57].credential.inputs.password = secret
[57].credential.inputs.authorize = true
[57].credential.inputs.authorize_password = authorize-me
[57].register = result
[58].assert.that[0] = result is changed
[59].name = Delete a Network credential
[59].credential.name = {{ net_cred_name1 }}
[59].credential.organization = Default
[59].credential.state = absent
[59].credential.credential_type = Network
[59].register = result
[60].assert.that[0] = result is changed
[61].name = Create a valid SCM credential
[61].credential.name = {{ scm_cred_name1 }}
[61].credential.organization = Default
[61].credential.state = present
[61].credential.credential_type = Source Control
[61].credential.inputs.username = joe
[61].credential.inputs.password = secret
[61].credential.inputs.ssh_key_data = {{ ssh_key_data }}
[61].credential.inputs.ssh_key_unlock = passphrase
[61].register = result
[62].assert.that[0] = result is changed
[63].name = Delete an SCM credential
[63].credential.name = {{ scm_cred_name1 }}
[63].credential.organization = Default
[63].credential.state = absent
[63].credential.credential_type = Source Control
[63].register = result
[64].assert.that[0] = result is changed
[65].name = Create a valid AWS credential
[65].credential.name = {{ aws_cred_name1 }}
[65].credential.organization = Default
[65].credential.state = present
[65].credential.credential_type = Amazon Web Services
[65].credential.inputs.username = joe
[65].credential.inputs.password = secret
[65].credential.inputs.security_token = aws-token
[65].register = result
[65].when = aws_found
[66].assert.that[0] = result is changed
[66].when = aws_found
[67].name = Delete an AWS credential
[67].credential.name = {{ aws_cred_name1 }}
[67].credential.organization = Default
[67].credential.state = absent
[67].credential.credential_type = Amazon Web Services
[67].register = result
[67].when = aws_found
[68].assert.that[0] = result is changed
[68].when = aws_found
[69].name = Create a valid VMWare credential
[69].credential.name = {{ vmware_cred_name1 }}
[69].credential.organization = Default
[69].credential.state = present
[69].credential.credential_type = VMware vCenter
[69].credential.inputs.host = https://example.org
[69].credential.inputs.username = joe
[69].credential.inputs.password = secret
[69].register = result
[69].when = vmware_found
[70].assert.that[0] = result is changed
[70].when = vmware_found
[71].name = Delete an VMWare credential
[71].credential.name = {{ vmware_cred_name1 }}
[71].credential.organization = Default
[71].credential.state = absent
[71].credential.credential_type = VMware vCenter
[71].register = result
[71].when = vmware_found
[72].assert.that[0] = result is changed
[72].when = vmware_found
[73].name = Create a valid Satellite6 credential
[73].credential.name = {{ sat6_cred_name1 }}
[73].credential.organization = Default
[73].credential.state = present
[73].credential.credential_type = Red Hat Satellite 6
[73].credential.inputs.host = https://example.org
[73].credential.inputs.username = joe
[73].credential.inputs.password = secret
[73].register = result
[73].when = satellite_found
[74].assert.that[0] = result is changed
[74].when = satellite_found
[75].name = Delete a Satellite6 credential
[75].credential.name = {{ sat6_cred_name1 }}
[75].credential.organization = Default
[75].credential.state = absent
[75].credential.credential_type = Red Hat Satellite 6
[75].register = result
[75].when = satellite_found
[76].assert.that[0] = result is changed
[76].when = satellite_found
[77].name = Create a valid GCE credential
[77].credential.name = {{ gce_cred_name1 }}
[77].credential.organization = Default
[77].credential.state = present
[77].credential.credential_type = Google Compute Engine
[77].credential.inputs.username = joe
[77].credential.inputs.project = ABC123
[77].credential.inputs.ssh_key_data = {{ ssh_key_data }}
[77].register = result
[77].when = gce_found
[78].assert.that[0] = result is changed
[78].when = gce_found
[79].name = Delete a GCE credential
[79].credential.name = {{ gce_cred_name1 }}
[79].credential.organization = Default
[79].credential.state = absent
[79].credential.credential_type = Google Compute Engine
[79].register = result
[79].when = gce_found
[80].assert.that[0] = result is changed
[80].when = gce_found
[81].name = Create a valid AzureRM credential
[81].credential.name = {{ azurerm_cred_name1 }}
[81].credential.organization = Default
[81].credential.state = present
[81].credential.credential_type = Microsoft Azure Resource Manager
[81].credential.inputs.username = joe
[81].credential.inputs.password = secret
[81].credential.inputs.subscription = some-subscription
[81].register = result
[81].when = azure_found
[82].assert.that[0] = result is changed
[82].when = azure_found
[83].name = Create a valid AzureRM credential with a tenant
[83].credential.name = {{ azurerm_cred_name1 }}
[83].credential.organization = Default
[83].credential.state = present
[83].credential.credential_type = Microsoft Azure Resource Manager
[83].credential.inputs.client = some-client
[83].credential.inputs.secret = some-secret
[83].credential.inputs.tenant = some-tenant
[83].credential.inputs.subscription = some-subscription
[83].register = result
[83].when = azure_found
[84].assert.that[0] = result is changed
[84].when = azure_found
[85].name = Delete an AzureRM credential
[85].credential.name = {{ azurerm_cred_name1 }}
[85].credential.organization = Default
[85].credential.state = absent
[85].credential.credential_type = Microsoft Azure Resource Manager
[85].register = result
[85].when = azure_found
[86].assert.that[0] = result is changed
[86].when = azure_found
[87].name = Create a valid OpenStack credential
[87].credential.name = {{ openstack_cred_name1 }}
[87].credential.organization = Default
[87].credential.state = present
[87].credential.credential_type = OpenStack
[87].credential.inputs.host = https://keystone.example.org
[87].credential.inputs.username = joe
[87].credential.inputs.password = secret
[87].credential.inputs.project = tenant123
[87].credential.inputs.domain = some-domain
[87].register = result
[87].when = openstack_found
[88].assert.that[0] = result is changed
[88].when = openstack_found
[89].name = Delete a OpenStack credential
[89].credential.name = {{ openstack_cred_name1 }}
[89].credential.organization = Default
[89].credential.state = absent
[89].credential.credential_type = OpenStack
[89].register = result
[89].when = openstack_found
[90].assert.that[0] = result is changed
[90].when = openstack_found
[91].name = Create a valid RHV credential
[91].credential.name = {{ rhv_cred_name1 }}
[91].credential.organization = Default
[91].credential.state = present
[91].credential.credential_type = Red Hat Virtualization
[91].credential.inputs.host = https://example.org
[91].credential.inputs.username = joe
[91].credential.inputs.password = secret
[91].register = result
[91].when = rhv_found
[92].assert.that[0] = result is changed
[92].when = rhv_found
[93].name = Delete an RHV credential
[93].credential.name = {{ rhv_cred_name1 }}
[93].credential.organization = Default
[93].credential.state = absent
[93].credential.credential_type = Red Hat Virtualization
[93].register = result
[93].when = rhv_found
[94].assert.that[0] = result is changed
[94].when = rhv_found
[95].name = Create a valid Insights credential
[95].credential.name = {{ insights_cred_name1 }}
[95].credential.organization = Default
[95].credential.state = present
[95].credential.credential_type = Insights
[95].credential.inputs.username = joe
[95].credential.inputs.password = secret
[95].register = result
[95].when = insights_found
[96].assert.that[0] = result is changed
[96].when = insights_found
[97].name = Delete an Insights credential
[97].credential.name = {{ insights_cred_name1 }}
[97].credential.organization = Default
[97].credential.state = absent
[97].credential.credential_type = Insights
[97].register = result
[97].when = insights_found
[98].assert.that[0] = result is changed
[98].when = insights_found
[99].name = Create a valid Insights token credential
[99].credential.name = {{ insights_cred_name2 }}
[99].credential.organization = Default
[99].credential.state = present
[99].credential.credential_type = Insights
[99].credential.inputs.client_id = joe
[99].credential.inputs.client_secret = secret
[99].register = result
[99].when = insights_found
[100].assert.that[0] = result is changed
[100].when = insights_found
[101].name = Delete an Insights token credential
[101].credential.name = {{ insights_cred_name2 }}
[101].credential.organization = Default
[101].credential.state = absent
[101].credential.credential_type = Insights
[101].register = result
[101].when = insights_found
[102].assert.that[0] = result is changed
[102].when = insights_found
[103].name = Create a valid Tower-to-Tower credential
[103].credential.name = {{ tower_cred_name1 }}
[103].credential.organization = Default
[103].credential.state = present
[103].credential.credential_type = Red Hat Ansible Automation Platform
[103].credential.inputs.host = https://controller.example.org
[103].credential.inputs.username = joe
[103].credential.inputs.password = secret
[103].register = result
[104].assert.that[0] = result is changed
[105].name = Delete a Tower-to-Tower credential
[105].credential.name = {{ tower_cred_name1 }}
[105].credential.organization = Default
[105].credential.state = absent
[105].credential.credential_type = Red Hat Ansible Automation Platform
[105].register = result
[106].assert.that[0] = result is changed
[107].name = Check module fails with correct msg
[107].credential.name = test-credential
[107].credential.description = Credential Description
[107].credential.credential_type = Machine
[107].credential.organization = test-non-existing-org
[107].credential.state = present
[107].register = result
[107].ignore_errors = yes
[108].assert.that[0] = result is failed
[108].assert.that[1] = result is not changed
[108].assert.that[2] = 'test-non-existing-org' in result.msg
[108].assert.that[3] = result.total_results == 0
