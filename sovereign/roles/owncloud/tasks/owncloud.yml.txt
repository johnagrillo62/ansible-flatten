[0].name = Install ownCloud dependencies
[0].apt = pkg={{ item }} state=present
[0].with_items[0] = postgresql
[0].with_items[1] = python-psycopg2
[0].tags[0] = dependencies
[1].name = Set password for PostgreSQL admin user
[1].become = true
[1].become_user = postgres
[1].postgresql_user = name={{ db_admin_username }} password={{ db_admin_password }} encrypted=yes
[2].name = Create database user for ownCloud
[2].postgresql_user = login_host=localhost login_user={{ db_admin_username }} login_password="{{ db_admin_password }}" name={{ owncloud_db_username }} password="{{ owncloud_db_password }}" role_attr_flags=CREATEDB state=present
[3].name = Ensure repository key for ownCloud is in place
[3].apt_key = url=https://download.owncloud.org/download/repositories/stable/Debian_8.0/Release.key state=present
[3].tags[0] = dependencies
[4].name = Add ownCloud repository
[4].apt_repository = repo='deb http://download.owncloud.org/download/repositories/stable/Debian_8.0/ /'
[4].tags[0] = dependencies
[5].name = Install ownCloud
[5].apt = pkg=owncloud-files update_cache=yes
[5].tags[0] = dependencies
[6].name = Ensure ownCloud directory is in place
[6].file = state=directory path=/var/www/owncloud
[7].name = Move ownCloud data to encrypted filesystem
[7].command = mv /var/www/owncloud/data /decrypted/owncloud-data creates=/decrypted/owncloud-data
[8].name = Link ownCloud data directory to encrypted filesystem
[8].file = src=/decrypted/owncloud-data dest=/var/www/owncloud/data owner=www-data group=www-data state=link
[9].name = Configure Apache for ownCloud
[9].template = src=etc_apache2_sites-available_owncloud.j2 dest=/etc/apache2/sites-available/owncloud.conf group=root
[9].notify = restart apache
[10].name = Enable ownCloud site
[10].command = a2ensite owncloud.conf creates=/etc/apache2/sites-enabled/owncloud.conf
[10].notify = restart apache
[11].name = Install ownCloud cronjob
[11].cron = name="ownCloud" user="www-data" minute="*/5" job="php -f /var/www/owncloud/cron.php > /dev/null"
