[0].name = Generate a test id
[0]["ansible.builtin.set_fact"].test_id = {{ lookup('password', '/dev/null chars=ascii_letters length=16') }}
[0].when = test_id is not defined
[1].name = Generate names
[1]["ansible.builtin.set_fact"].username = AWX-Collection-tests-role-user-{{ test_id }}
[1]["ansible.builtin.set_fact"].project_name = AWX-Collection-tests-role-project-1-{{ test_id }}
[1]["ansible.builtin.set_fact"].jt1 = AWX-Collection-tests-role-jt1-{{ test_id }}
[1]["ansible.builtin.set_fact"].jt2 = AWX-Collection-tests-role-jt2-{{ test_id }}
[1]["ansible.builtin.set_fact"].wfjt_name = AWX-Collection-tests-role-project-wfjt-{{ test_id }}
[1]["ansible.builtin.set_fact"].team_name = AWX-Collection-tests-team-team-{{ test_id }}
[1]["ansible.builtin.set_fact"].team2_name = AWX-Collection-tests-team-team-{{ test_id }}2
[1]["ansible.builtin.set_fact"].org2_name = AWX-Collection-tests-organization-{{ test_id }}2
[2].name = Main block for user creation
[2].block[0].name = Create a user with a valid sanitized name
[2].block[0]["awx.awx.user"].username = {{ username }}
[2].block[0]["awx.awx.user"].password = {{ 65535 | random | to_uuid }}
[2].block[0]["awx.awx.user"].state = present
[2].block[0].register = result
[2].block[1].name = Assert result changed
[2].block[1]["ansible.builtin.assert"].that[0] = result.changed
[2].block[2].name = Create a 2nd User
[2].block[2]["awx.awx.user"].username = {{ username }}2
[2].block[2]["awx.awx.user"].password = {{ 65535 | random | to_uuid }}
[2].block[2]["awx.awx.user"].state = present
[2].block[2].register = result
[2].block[3].name = Assert result changed
[2].block[3]["ansible.builtin.assert"].that[0] = result.changed
[2].block[4].name = Create teams
[2].block[4].team.name = {{ item }}
[2].block[4].team.organization = Default
[2].block[4].register = result
[2].block[4].loop[0] = {{ team_name }}
[2].block[4].loop[1] = {{ team2_name }}
[2].block[5].name = Assert result changed
[2].block[5]["ansible.builtin.assert"].that[0] = result.changed
[2].block[6].name = Create a project
[2].block[6].project.name = {{ project_name }}
[2].block[6].project.organization = Default
[2].block[6].project.scm_type = git
[2].block[6].project.scm_url = https://github.com/ansible/test-playbooks
[2].block[6].project.wait = true
[2].block[6].register = project_info
[2].block[7].name = Assert project_info is changed
[2].block[7]["ansible.builtin.assert"].that[0] = project_info is changed
[2].block[8].name = Create job templates
[2].block[8].job_template.name = {{ item }}
[2].block[8].job_template.project = {{ project_name }}
[2].block[8].job_template.inventory = Demo Inventory
[2].block[8].job_template.playbook = become.yml
[2].block[8].with_items[0] = jt1
[2].block[8].with_items[1] = jt2
[2].block[8].register = result
[2].block[9].name = Assert result changed
[2].block[9]["ansible.builtin.assert"].that[0] = result.changed
[2].block[10].name = Add Joe and teams to the update role of the default Project with lookup Organization
[2].block[10].role.user = {{ username }}
[2].block[10].role.users[0] = {{ username }}2
[2].block[10].role.teams[0] = {{ team_name }}
[2].block[10].role.teams[1] = {{ team2_name }}
[2].block[10].role.role = update
[2].block[10].role.lookup_organization = Default
[2].block[10].role.project = Demo Project
[2].block[10].role.state = {{ item }}
[2].block[10].register = result
[2].block[10].with_items[0] = present
[2].block[10].with_items[1] = absent
[2].block[11].name = Assert result changed
[2].block[11]["ansible.builtin.assert"].that[0] = result.changed
[2].block[12].name = Add Joe to the new project by ID
[2].block[12].role.user = {{ username }}
[2].block[12].role.users[0] = {{ username }}2
[2].block[12].role.teams[0] = {{ team_name }}
[2].block[12].role.teams[1] = {{ team2_name }}
[2].block[12].role.role = update
[2].block[12].role.project = {{ project_info['id'] }}
[2].block[12].role.state = {{ item }}
[2].block[12].register = result
[2].block[12].with_items[0] = present
[2].block[12].with_items[1] = absent
[2].block[13].name = Assert result changed
[2].block[13]["ansible.builtin.assert"].that[0] = result.changed
[2].block[14].name = Add Joe as execution admin to Default Org.
[2].block[14].role.user = {{ username }}
[2].block[14].role.users[0] = {{ username }}2
[2].block[14].role.role = execution_environment_admin
[2].block[14].role.organizations = Default
[2].block[14].role.state = {{ item }}
[2].block[14].register = result
[2].block[14].with_items[0] = present
[2].block[14].with_items[1] = absent
[2].block[15].name = Assert result changed
[2].block[15]["ansible.builtin.assert"].that[0] = result.changed
[2].block[16].name = Create a workflow
[2].block[16].workflow_job_template.name = test-role-workflow
[2].block[16].workflow_job_template.organization = Default
[2].block[16].workflow_job_template.state = present
[2].block[17].name = Add Joe to workflow execute role
[2].block[17].role.user = {{ username }}
[2].block[17].role.users[0] = {{ username }}2
[2].block[17].role.role = execute
[2].block[17].role.workflow = test-role-workflow
[2].block[17].role.job_templates[0] = jt1
[2].block[17].role.job_templates[1] = jt2
[2].block[17].role.state = present
[2].block[17].register = result
[2].block[18].name = Assert result changed
[2].block[18]["ansible.builtin.assert"].that[0] = result.changed
[2].block[19].name = Add Joe to nonexistent job template execute role
[2].block[19]["awx.awx.role"].user = {{ username }}
[2].block[19]["awx.awx.role"].role = execute
[2].block[19]["awx.awx.role"].job_template = non existant temp
[2].block[19]["awx.awx.role"].state = present
[2].block[19].register = results
[2].block[19].ignore_errors = true
[2].block[20].name = Assert that adding a role to a non-existent template failed correctly
[2].block[20]["ansible.builtin.assert"].that[0] = results.failed
[2].block[20]["ansible.builtin.assert"].that[1] = 'missing items' in results.msg
[2].block[21].name = Add Joe to workflow execute role, no-op
[2].block[21].role.user = {{ username }}
[2].block[21].role.users[0] = {{ username }}2
[2].block[21].role.role = execute
[2].block[21].role.workflow = test-role-workflow
[2].block[21].role.state = present
[2].block[21].register = result
[2].block[22].name = Assert result did not change
[2].block[22]["ansible.builtin.assert"].that[0] = result is not changed
[2].block[23].name = Add Joe to workflow approve role
[2].block[23].role.users[0] = {{ username }}2
[2].block[23].role.role = approval
[2].block[23].role.workflow = test-role-workflow
[2].block[23].role.state = present
[2].block[23].register = result
[2].block[24].name = Assert result changed
[2].block[24]["ansible.builtin.assert"].that[0] = result.changed
[2].block[25].name = Create a 2nd organization
[2].block[25].organization.name = {{ org2_name }}
[2].block[26].name = Create a project in 2nd Organization
[2].block[26].project.name = {{ project_name }}
[2].block[26].project.organization = {{ org2_name }}
[2].block[26].project.scm_type = git
[2].block[26].project.scm_url = https://github.com/ansible/test-playbooks
[2].block[26].project.wait = true
[2].block[26].register = project_info
[2].block[27].name = Add Joe and teams to the update role of the default Project with lookup from the 2nd Organization
[2].block[27].role.user = {{ username }}
[2].block[27].role.users[0] = {{ username }}2
[2].block[27].role.teams[0] = {{ team_name }}
[2].block[27].role.teams[1] = {{ team2_name }}
[2].block[27].role.role = update
[2].block[27].role.lookup_organization = {{ org2_name }}
[2].block[27].role.project = {{ project_name }}
[2].block[27].role.state = {{ item }}
[2].block[27].register = result
[2].block[27].with_items[0] = present
[2].block[27].with_items[1] = absent
[2].block[28].name = Assert result changed
[2].block[28]["ansible.builtin.assert"].that[0] = result.changed
[2].always[0].name = Delete a User
[2].always[0]["ansible.builtin.user"].name = {{ username }}
[2].always[0]["ansible.builtin.user"].state = absent
[2].always[0].register = result
[2].always[1].name = Delete a 2nd User
[2].always[1]["ansible.builtin.user"].name = {{ username }}2
[2].always[1]["ansible.builtin.user"].state = absent
[2].always[1].register = result
[2].always[2].name = Delete teams
[2].always[2].team.name = {{ item }}
[2].always[2].team.organization = Default
[2].always[2].team.state = absent
[2].always[2].register = result
[2].always[2].loop[0] = {{ team_name }}
[2].always[2].loop[1] = {{ team2_name }}
[2].always[3].name = Delete job templates
[2].always[3].job_template.name = {{ item }}
[2].always[3].job_template.project = {{ project_name }}
[2].always[3].job_template.inventory = Demo Inventory
[2].always[3].job_template.playbook = debug.yml
[2].always[3].job_template.state = absent
[2].always[3].with_items[0] = jt1
[2].always[3].with_items[1] = jt2
[2].always[4].name = Delete the project
[2].always[4].project.name = {{ project_name }}
[2].always[4].project.organization = Default
[2].always[4].project.state = absent
[2].always[4].register = del_res
[2].always[4].until = del_res is succeeded
[2].always[4].retries = 5
[2].always[4].delay = 3
[2].always[5].name = Delete the 2nd organization
[2].always[5].organization.name = {{ org2_name }}
[2].always[5].organization.state = absent
