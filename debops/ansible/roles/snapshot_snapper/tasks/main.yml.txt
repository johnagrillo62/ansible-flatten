~d0.name = Import custom Ansible plugins
~d1.ansible.builtin.import_role = 
~d2.name = 'ansible_plugins'
~d0.name = Combine snapper inventory variables
~d1.ansible.builtin.set_fact = 
~d2.snapshot_snapper__templates_combined = '{{
~d2.snapshot_snapper__volumes_combined = '{{
~d2.snapshot_snapper__combined_packages = '{{
~d1.tags = 
~d2.'role = :snapshot_snapper:reinit'
~d0.name = Ensure specified packages are in there desired state
~d1.ansible.builtin.package = 
~d2.name = '{{ q("flattened", snapshot_snapper__combined_packages) }}'
~d2.state = 'present'
~d1.register = snapshot_snapper__register_packages
~d1.until = snapshot_snapper__register_packages is succeeded
~d0.name = 'Divert original configuration under /etc'
~d1.debops.debops.dpkg_divert = 
~d2.path = '{{ item }}'
~d1.register = snapshot_snapper__updatedb_diverted_register
~d1.when = ansible_os_family in ["Debian"]
~d1.loop = '{{ snapshot_snapper__divert_files | flatten }}'
~d0.name = Copy diverted configuration file to original location
~d1.ansible.builtin.copy = # noqa no-handler
~d2.src = '{{ item }}.dpkg-divert'
~d2.dest = '{{ item }}'
~d2.remote_src = True
~d2.force = False
~d2.owner = 'root'
~d2.group = 'root'
~d2.mode = '0644'
~d1.when = snapshot_snapper__updatedb_diverted_register is changed
~d1.loop = '{{ q("flattened", snapshot_snapper__divert_files) }}'
~d0.name = Check if snapshots are already excluded from updatedb
~d1.ansible.builtin.command = grep PRUNENAMES=.*{{ snapshot_snapper__directory }}.* /etc/updatedb.conf
~d1.failed_when = False
~d1.changed_when = False
~d1.check_mode = False
~d1.when = snapshot_snapper__directory | d() and "mlocate" in snapshot_snapper__combined_packages
~d1.register = snapshot_snapper__register_updatedb_configured
~d0.name = Configure updatedb to exclude snapshots
~d1.ansible.builtin.lineinfile = 
~d2.dest = '/etc/updatedb.conf'
~d2.backrefs = yes
~d2.regexp = '^(# )?PRUNENAMES=(".*)"$'
~d2.line = 'PRUNENAMES=\2 {{ snapshot_snapper__directory }}"'
~d2.mode = '0644'
~d1.when = snapshot_snapper__register_updatedb_configured.rc != 0
~d0.name = Check which snapper /etc/snapper/configs/ exist
~d1.ansible.builtin.stat = 
~d2.path = '/etc/snapper/configs/{{ item.name }}'
~d1.when = (snapshot_snapper__auto_reinit | bool and item.path | d() and item.name | d() and
~d1.register = snapshot_snapper__register_snapper_configs
~d1.tags = [ 'role::snapshot_snapper:reinit' ]
~d1.with_items = '{{ snapshot_snapper__volumes_combined }}'
~d0.name = Check which snapper snapshot directories exist
~d1.ansible.builtin.stat = 
~d2.path = '{{ item.path + "/" + snapshot_snapper__directory }}'
~d1.when = (snapshot_snapper__auto_reinit | bool and item.path | d() and item.name | d() and
~d1.tags = [ 'role::snapshot_snapper:reinit' ]
~d1.register = snapshot_snapper__register_snapshot_directory
~d1.with_items = '{{ snapshot_snapper__volumes_combined }}'
~d0.name = Delete snapper configuration to automatically reinit
~d1.ansible.builtin.file = 
~d2.path = '/etc/snapper/configs/{{ item.0.item.name }}'
~d2.state = 'absent'
~d1.tags = [ 'role::snapshot_snapper:reinit' ]
~d1.when = (item.0 is not skipped and item.1 is not skipped and
~d1.register = snapshot_snapper__register_snapper_configs_delete
~d1.with_together = 
~d0.name = Get list of active snapper volumes
~d1.ansible.builtin.find = 
~d2.file_type = 'file'
~d2.paths = [ '/etc/snapper/configs/' ]
~d2.hidden = False
~d2.recurse = False
~d1.register = snapshot_snapper__register_snapper_configs_current
~d1.when = (snapshot_snapper__auto_reinit | bool)
~d1.tags = [ 'role::snapshot_snapper:reinit' ]
~d0.name = Update active snapper volumes in /etc/default/snapper
~d1.ansible.builtin.lineinfile = 
~d2.dest = '/etc/default/snapper'
~d2.state = 'present'
~d2.regexp = '^SNAPPER_CONFIGS="[^"]*"$'
~d2.line = 'SNAPPER_CONFIGS="{{
~d2.mode = '0644'
~d1.when = (snapshot_snapper__auto_reinit | bool)
~d1.tags = [ 'role::snapshot_snapper:reinit' ]
~d0.name = Configure snapper templates
~d1.ansible.builtin.template = 
~d2.src = 'etc/snapper/config-templates/item.j2'
~d2.dest = '/etc/snapper/config-templates/{{ item.key }}'
~d2.owner = 'root'
~d2.group = 'root'
~d2.mode = '0644'
~d1.with_dict = '{{ snapshot_snapper__templates_combined }}'
~d0.name = Create initial configuration per volume
~d1.ansible.builtin.command = snapper --config '{{ item.name | default("root") }}'
~d1.args = 
~d2.creates = '/etc/snapper/configs/{{ item.name }}'
~d1.when = (item.path | d() and item.name | d() and (item.state | d("present") == "present"))
~d1.with_items = '{{ snapshot_snapper__volumes_combined }}'
~d0.name = Adjust configuration per volume
~d1.ansible.builtin.include_tasks = configure_snapper_volume.yml
~d1.loop_control = 
~d2.loop_var = 'snapshot_snapper__volume'
~d1.with_items = '{{ snapshot_snapper__volumes_combined }}'
