[0].name = Clone the app's source code
[0]["ansible.builtin.git"].repo = {{ rails_deploy_git_location }}
[0]["ansible.builtin.git"].dest = {{ rails_deploy_src }}
[0]["ansible.builtin.git"].version = {{ rails_deploy_git_version }}
[0]["ansible.builtin.git"].remote = {{ rails_deploy_git_remote }}
[0]["ansible.builtin.git"].accept_hostkey = True
[0].register = rails_deploy_register_repo_status
[0].when = rails_deploy_git_location is defined and rails_deploy_git_location
[0].become = True
[0].become_user = {{ rails_deploy_service }}
[1].name = Detect a temporary public deploy page
[1]["ansible.builtin.stat"].path = {{ rails_deploy_src }}/public/deploy.html
[1].register = rails_deploy_register_public_deploy_page
[2].name = Enable the temporary deploy page
[2]["ansible.builtin.copy"].src = {{ rails_deploy_src }}/public/deploy.html
[2]["ansible.builtin.copy"].dest = {{ rails_deploy_src }}/public/index.html
[2]["ansible.builtin.copy"].mode = 0644
[2]["ansible.builtin.copy"].remote_src = True
[2].when = rails_deploy_register_public_deploy_page.stat.exists and rails_deploy_register_repo_status is defined and rails_deploy_register_repo_status is changed
[2].changed_when = False
[2].become = True
[2].become_user = {{ rails_deploy_service }}
[3].name = Update gems
[3]["ansible.builtin.command"] = bundle install --deployment --without={{ rails_deploy_bundle_without | difference([rails_deploy_system_env]) | join(',') }}
[3].args.chdir = {{ rails_deploy_src }}
[3].changed_when = False
[3].when = rails_deploy_register_repo_status is defined and rails_deploy_register_repo_status is changed
[3].become = True
[3].become_user = {{ rails_deploy_service }}
[4].name = Restart the background worker asynchronously
[4]["ansible.builtin.service"].name = {{ rails_deploy_worker }}
[4]["ansible.builtin.service"].state = restarted
[4].async = 90
[4].when = rails_deploy_worker_enabled and rails_deploy_register_repo_status is defined and rails_deploy_register_repo_status is changed
[5].name = Prepare the database
[5]["ansible.builtin.shell"] = {{ rails_deploy_env_source }} && bundle exec rake db:schema:load db:seed
[5].args.chdir = {{ rails_deploy_src }}
[5].when = (rails_deploy_database_create and rails_deploy_register_database_created is defined and rails_deploy_register_database_created is changed and rails_app_database_prepare) and inventory_hostname == rails_deploy_hosts_master and rails_deploy_register_repo_status is defined and rails_deploy_register_repo_status is changed
[5].become = True
[5].become_user = {{ rails_deploy_service }}
[5].register = rails_deploy__register_db_schema_load
[5].changed_when = rails_deploy__register_db_schema_load.changed | bool
[6].name = Store mtime of the config folder
[6]["ansible.builtin.stat"].path = {{ rails_deploy_src }}/config
[6].register = rails_deploy_register_mtime_config
[6].when = inventory_hostname == rails_deploy_hosts_master and rails_deploy_git_location is defined and rails_deploy_git_location
[7].name = Store mtime of the db/schema.rb file
[7]["ansible.builtin.stat"].path = {{ rails_deploy_src }}/db/schema.rb
[7].register = rails_deploy_register_mtime_schema
[7].when = inventory_hostname == rails_deploy_hosts_master and rails_deploy_git_location is defined and rails_deploy_git_location
[8].name = Execute shell commands before migration
[8]["ansible.builtin.shell"] = {{ rails_deploy_env_source }} && {{ item }}
[8].args.chdir = {{ rails_deploy_src }}
[8].when = rails_deploy_pre_migrate_shell_commands and rails_deploy_git_location and rails_deploy_register_repo_status is defined and rails_deploy_register_repo_status is changed
[8].with_items = {{ rails_deploy_pre_migrate_shell_commands }}
[8].become = True
[8].become_user = {{ rails_deploy_service }}
[8].register = rails_deploy__register_migration_pre_commands
[8].changed_when = rails_deploy__register_migration_pre_commands.changed | bool
[9].name = Migrate the database
[9]["ansible.builtin.shell"] = {{ rails_deploy_env_source }} && bundle exec rake db:migrate
[9].args.chdir = {{ rails_deploy_src }}
[9].when = inventory_hostname == rails_deploy_hosts_master and (rails_deploy_database_force_migrate or (rails_deploy_register_repo_status is defined and rails_deploy_register_repo_status is changed and (rails_deploy_register_mtime_schema.stat.mtime != ansible_local.rails_deploy[rails_deploy_service].mtime.schema) or ansible_local.rails_deploy[rails_deploy_service].mtime.schema is undefined))
[9].register = rails_deploy_register_migration
[9].changed_when = rails_deploy_register_migration.changed | bool
[9].become = True
[9].become_user = {{ rails_deploy_service }}
[10].name = Execute shell commands after migration
[10]["ansible.builtin.shell"] = {{ rails_deploy_env_source }} && {{ item }}
[10].args.chdir = {{ rails_deploy_src }}
[10].when = rails_deploy_post_migrate_shell_commands and rails_deploy_git_location and rails_deploy_register_repo_status is defined and rails_deploy_register_repo_status is changed
[10].with_items = {{ rails_deploy_post_migrate_shell_commands }}
[10].become = True
[10].become_user = {{ rails_deploy_service }}
[10].register = rails_deploy__register_migration_post_commands
[10].changed_when = rails_deploy__register_migration_post_commands.changed | bool
[11].name = Reload the backend server
[11]["ansible.builtin.service"].name = {{ rails_deploy_service }}
[11]["ansible.builtin.service"].state = reloaded
[11].when = rails_deploy_backend and (rails_deploy_register_repo_status is defined and rails_deploy_register_repo_status is changed and (inventory_hostname == rails_deploy_hosts_master or inventory_hostname != item) and not rails_deploy_register_migration is changed and rails_deploy_register_mtime_config.stat.mtime == ansible_local.rails_deploy[rails_deploy_service].mtime.config and not rails_deploy_backend_always_restart)
[11].delegate_to = {{ item }}
[11].with_items = {{ groups[rails_deploy_hosts_group] }}
[12].name = Restart the backend server
[12]["ansible.builtin.service"].name = {{ rails_deploy_service }}
[12]["ansible.builtin.service"].state = restarted
[12].when = rails_deploy_backend and (rails_deploy_database_force_migrate or ((rails_deploy_register_repo_status is defined and rails_deploy_register_repo_status is changed) and rails_deploy_register_migration is changed) and (inventory_hostname == rails_deploy_hosts_master or inventory_hostname != item) or rails_deploy_register_mtime_config.stat.mtime != ansible_local.rails_deploy[rails_deploy_service].mtime.config or (rails_deploy_backend_always_restart and rails_deploy_git_location and rails_deploy_register_repo_status is defined and rails_deploy_register_repo_status is changed))
[12].delegate_to = {{ item }}
[12].with_items = {{ groups[rails_deploy_hosts_group] }}
[13].name = Set the extra services state
[13]["ansible.builtin.service"].name = {{ item.name }}
[13]["ansible.builtin.service"].state = {{ item.changed_state | default("reloaded") }}
[13].when = rails_deploy_register_repo_status is defined and rails_deploy_register_repo_status is changed and rails_deploy_extra_services
[13].with_items = {{ rails_deploy_extra_services }}
[14].name = Set the initial backend server state
[14]["ansible.builtin.service"].name = {{ rails_deploy_service }}
[14]["ansible.builtin.service"].state = {{ rails_deploy_backend_state }}
[14]["ansible.builtin.service"].enabled = {{ rails_deploy_backend_enabled }}
[14].when = rails_deploy_git_location is defined and rails_deploy_git_location and rails_deploy_backend
[15].name = Set the initial background worker state
[15]["ansible.builtin.service"].name = {{ rails_deploy_worker }}
[15]["ansible.builtin.service"].state = {{ rails_deploy_worker_state }}
[15]["ansible.builtin.service"].enabled = {{ rails_deploy_worker_enabled }}
[15].when = rails_deploy_worker_enabled and rails_deploy_git_location is defined and rails_deploy_git_location
[16].name = Set the initial extra services state
[16]["ansible.builtin.service"].name = {{ item.name }}
[16]["ansible.builtin.service"].state = {{ item.state | default("started") }}
[16]["ansible.builtin.service"].enabled = {{ item.enabled | default(True) }}
[16].when = rails_deploy_git_location is defined and rails_deploy_git_location and rails_deploy_extra_services
[16].with_items = {{ rails_deploy_extra_services }}
[17].name = Execute shell commands after the backend is ready
[17]["ansible.builtin.shell"] = {{ rails_deploy_env_source }} && {{ item }}  # noqa no-handler
[17].args.chdir = {{ rails_deploy_src }}
[17].when = rails_deploy_post_restart_shell_commands and rails_deploy_git_location and rails_deploy_register_repo_status is defined and rails_deploy_register_repo_status is changed
[17].with_items = {{ rails_deploy_post_restart_shell_commands }}
[17].become = True
[17].become_user = {{ rails_deploy_service }}
[17].register = rails_deploy__register_shell_commands
[17].changed_when = rails_deploy__register_shell_commands.changed | bool
[18].name = Disable the temporary deploy page
[18]["ansible.builtin.file"].path = {{ rails_deploy_src + "/public/index.html" }}
[18]["ansible.builtin.file"].state = absent
[18].when = rails_deploy_register_public_deploy_page.stat.exists and rails_deploy_register_repo_status is defined and rails_deploy_register_repo_status is changed
[18].changed_when = False
[18].become = True
[18].become_user = {{ rails_deploy_service }}
