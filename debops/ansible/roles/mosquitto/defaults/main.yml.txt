mosquitto__upstream = {{ True if ansible_distribution_release in ["trusty"]
                         else False }} 
mosquitto__upstream_key_id = 8277 CCB4 9EC5 B595 F2D2 C713 6161 1AE4 3099 3623
mosquitto__upstream_repository.Debian = deb http://repo.mosquitto.org/debian {{ ansible_distribution_release }} main
mosquitto__upstream_repository.Raspbian = deb http://repo.mosquitto.org/debian {{ ansible_distribution_release }} main
mosquitto__upstream_repository.Ubuntu = ppa:mosquitto-dev/mosquitto-ppa
mosquitto__distribution_release = {{ ansible_local.core.distribution_release | d(ansible_distribution_release) }}
mosquitto__base_packages[0] = mosquitto
mosquitto__base_packages[1] = mosquitto-clients
mosquitto__version = {{ mosquitto__register_version.stdout | d("0.0.0") }}
mosquitto__pip_packages = {{ ["paho-mqtt"]
                             if (mosquitto__distribution_release in
                                 ["trusty", "xenial"])
                             else [] }}

mosquitto__user = mosquitto
mosquitto__group = mosquitto
mosquitto__append_groups = {{ ["ssl-cert"] if mosquitto__pki | bool else [] }}
mosquitto__network = True
mosquitto__websockets = {{ mosquitto__register_websockets.stdout | d() }}
mosquitto__websockets_packages[0] = libwebsockets8
mosquitto__fqdn = mqtt.{{ mosquitto__domain }}
mosquitto__domain = {{ ansible_domain }}
mosquitto__http_dir_path = {{ (ansible_local.fhs.data | d("/srv"))
                              + "/mosquitto/www/public" }} 
mosquitto__http_dir_owner = root
mosquitto__http_dir_group = www-data
mosquitto__http_dir_mode = 0755
mosquitto__default_options.password_file = {{ mosquitto__password_file if mosquitto__password | bool else "" }}
mosquitto__default_options.acl_file = {{ mosquitto__acl_file if mosquitto__acl | bool else "" }}
mosquitto__default_options.allow_anonymous = {{ mosquitto__allow_anonymous }}
mosquitto__combined_options = {{ mosquitto__default_options
                                 | combine(mosquitto__options) }} 
mosquitto__default_listeners.1883.comment = The default listener for local clients
mosquitto__default_listeners.1883.listener = {{ "1883" + ("" if mosquitto__allow | d() else " localhost") }}
mosquitto__default_listeners.1883.avahi_state = {{ "present" if (mosquitto__network | bool and mosquitto__allow | d()) else "absent" }}
mosquitto__default_listeners.1883.avahi_type = _mqtt._tcp
mosquitto__default_listeners.1883.avahi_port = 1883
mosquitto__default_listeners.1884.comment = The websocket listener behind a webserver
mosquitto__default_listeners.1884.listener = 1884 127.0.0.1
mosquitto__default_listeners.1884.protocol = websockets
mosquitto__default_listeners.1884.http_dir = {{ mosquitto__http_dir_path }}
mosquitto__default_listeners.1884.state = {{ "present" if mosquitto__websockets | bool else "absent" }}
mosquitto__default_listeners.8883.comment = The default listener for remote clients over TLS
mosquitto__default_listeners.8883.listener = {{ "8883" + ("" if mosquitto__network | bool else " localhost") }}
mosquitto__default_listeners.8883.state = {{ "present" if mosquitto__pki | bool else "absent" }}
mosquitto__default_listeners.8883.cafile = {{ mosquitto__broker_cafile }}
mosquitto__default_listeners.8883.certfile = {{ mosquitto__broker_certfile }}
mosquitto__default_listeners.8883.keyfile = {{ mosquitto__broker_keyfile }}
mosquitto__default_listeners.8883.tls_version = {{ mosquitto__tls_version }}
mosquitto__default_listeners.8883.ciphers = {{ mosquitto__ciphers }}
mosquitto__default_listeners.8883.avahi_state = {{ "present" if (mosquitto__network | bool and mosquitto__pki | bool) else "absent" }}
mosquitto__default_listeners.8883.avahi_type = _secure-mqtt._tcp
mosquitto__default_listeners.8883.avahi_port = 8883
mosquitto__default_listeners.8883.avahi_txt = tls-version={{ mosquitto__tls_version }}
mosquitto__combined_listeners = {{ mosquitto__default_listeners
                                   | combine(mosquitto__listeners) }} 
mosquitto__combined_bridges = {{ mosquitto__bridges
                                 | combine(mosquitto__group_bridges)
                                 | combine(mosquitto__host_bridges) }}

mosquitto__pki = {{ ansible_local.pki.enabled | d(False) | bool }}
mosquitto__pki_path = {{ ansible_local.pki.path | d("/etc/pki/realms") }}
mosquitto__pki_client_realm = domain
mosquitto__pki_bridge_realm = domain
mosquitto__pki_broker_realm = domain
mosquitto__pki_ca = {{ ansible_local.pki.ca | d("CA.crt") }}
mosquitto__pki_crt = {{ ansible_local.pki.crt | d("default.crt") }}
mosquitto__pki_key = {{ ansible_local.pki.key | d("default.key") }}
mosquitto__client_cafile = {{ mosquitto__pki_path + "/" +
                              mosquitto__pki_client_realm + "/" +
                              mosquitto__pki_ca }}

mosquitto__client_certfile = {{ mosquitto__pki_path + "/" +
                                mosquitto__pki_client_realm + "/" +
                                mosquitto__pki_crt }}

mosquitto__client_keyfile = {{ mosquitto__pki_path + "/" +
                               mosquitto__pki_client_realm + "/" +
                               mosquitto__pki_key }}

mosquitto__bridge_cafile = {{ mosquitto__pki_path + "/" +
                              mosquitto__pki_bridge_realm + "/" +
                              mosquitto__pki_ca }}

mosquitto__bridge_certfile = {{ mosquitto__pki_path + "/" +
                                mosquitto__pki_bridge_realm + "/" +
                                mosquitto__pki_crt }}

mosquitto__bridge_keyfile = {{ mosquitto__pki_path + "/" +
                               mosquitto__pki_bridge_realm + "/" +
                               mosquitto__pki_key }}

mosquitto__broker_cafile = {{ mosquitto__pki_path + "/" +
                              mosquitto__pki_broker_realm + "/" +
                              mosquitto__pki_ca }}

mosquitto__broker_certfile = {{ mosquitto__pki_path + "/" +
                                mosquitto__pki_broker_realm + "/" +
                                mosquitto__pki_crt }}

mosquitto__broker_keyfile = {{ mosquitto__pki_path + "/" +
                               mosquitto__pki_broker_realm + "/" +
                               mosquitto__pki_key }}

mosquitto__ciphers = DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-CAMELLIA256-SHA:DHE-RSA-AES256-SHA:DHE-RSA-CAMELLIA128-SHA:DHE-RSA-AES128-SHA:CAMELLIA256-SHA:AES256-SHA:CAMELLIA128-SHA:AES128-SHA
mosquitto__tls_version = tlsv1.2
mosquitto__avahi = {{ ansible_local.avahi.installed | d() | bool }}
mosquitto__avahi_name = Mosquitto MQTT server on %h
mosquitto__password = {{ True
                         if (mosquitto__auth_users or
                             mosquitto__auth_group_users or
                             mosquitto__auth_host_users)
                         else False }}

mosquitto__password_file = /etc/mosquitto/passwd
mosquitto__password_secret_path = {{ secret + "/mosquitto/passwd" }}
mosquitto__allow_anonymous = {{ "false" if mosquitto__password | bool else "true" }}
mosquitto__acl = {{ True
                    if (mosquitto__auth_anonymous or
                        mosquitto__auth_users or
                        mosquitto__auth_group_users or
                        mosquitto__auth_host_users or
                        mosquitto__auth_patterns)
                    else False }}

mosquitto__acl_file = /etc/mosquitto/acl
mosquitto__python__dependent_packages3[0] = {{ []
        if (mosquitto__distribution_release in ["trusty", "xenial"])
        else ["python3-paho-mqtt"] }}

mosquitto__python__dependent_packages2[0] = {{ []
        if (mosquitto__distribution_release in ["trusty", "xenial"])
        else ["python-paho-mqtt"] }}

mosquitto__etc_services__dependent_list[0].name = mqtt
mosquitto__etc_services__dependent_list[0].port = 1883
mosquitto__etc_services__dependent_list[0].comment = Message Queuing Telemetry Transport Protocol
mosquitto__etc_services__dependent_list[1].name = ws-mqtt
mosquitto__etc_services__dependent_list[1].port = 1884
mosquitto__etc_services__dependent_list[1].comment = WebSocket MQTT
mosquitto__etc_services__dependent_list[2].name = secure-mqtt
mosquitto__etc_services__dependent_list[2].port = 8883
mosquitto__etc_services__dependent_list[2].comment = Secure MQTT
mosquitto__keyring__dependent_apt_keys[0].id = {{ mosquitto__upstream_key_id }}
mosquitto__keyring__dependent_apt_keys[0].repo = {{ mosquitto__upstream_repository[ansible_distribution] }}
mosquitto__keyring__dependent_apt_keys[0].state = {{ "present" if mosquitto__upstream | bool else "absent" }}
mosquitto__tcpwrappers__dependent_allow[0].daemon = mosquitto
mosquitto__tcpwrappers__dependent_allow[0].client = {{ mosquitto__allow }}
mosquitto__tcpwrappers__dependent_allow[0].accept_any = False
mosquitto__tcpwrappers__dependent_allow[0].weight = 50
mosquitto__tcpwrappers__dependent_allow[0].filename = mosquitto_dependent_allow
mosquitto__tcpwrappers__dependent_allow[0].comment = Allow remote connections to Mosquitto server
mosquitto__tcpwrappers__dependent_allow[0].state = {{ "present"
               if mosquitto__network | bool
               else "absent" }}

mosquitto__tcpwrappers__dependent_allow[1].daemon = mosquitto
mosquitto__tcpwrappers__dependent_allow[1].client = {{ mosquitto__allow_tls }}
mosquitto__tcpwrappers__dependent_allow[1].accept_any = True
mosquitto__tcpwrappers__dependent_allow[1].weight = 50
mosquitto__tcpwrappers__dependent_allow[1].filename = mosquitto-tls_dependent_allow
mosquitto__tcpwrappers__dependent_allow[1].comment = Allow remote connections to Mosquitto server over TLS
mosquitto__tcpwrappers__dependent_allow[1].state = {{ "present"
               if (mosquitto__network | bool and
                   mosquitto__pki | bool)
               else "absent" }}

mosquitto__ferm__dependent_rules[0].type = accept
mosquitto__ferm__dependent_rules[0].dport[0] = mqtt
mosquitto__ferm__dependent_rules[0].weight = 40
mosquitto__ferm__dependent_rules[0].saddr = {{ mosquitto__allow }}
mosquitto__ferm__dependent_rules[0].accept_any = False
mosquitto__ferm__dependent_rules[0].by_role = debops.mosquitto
mosquitto__ferm__dependent_rules[0].rule_state = {{ "present"
                    if mosquitto__network | bool
                    else "absent" }}

mosquitto__ferm__dependent_rules[1].type = accept
mosquitto__ferm__dependent_rules[1].dport[0] = secure-mqtt
mosquitto__ferm__dependent_rules[1].weight = 40
mosquitto__ferm__dependent_rules[1].saddr = {{ mosquitto__allow + mosquitto__allow_tls }}
mosquitto__ferm__dependent_rules[1].accept_any = True
mosquitto__ferm__dependent_rules[1].by_role = debops.mosquitto
mosquitto__ferm__dependent_rules[1].rule_state = {{ "present"
                    if (mosquitto__network | bool and
                        mosquitto__pki | bool)
                    else "absent" }}

mosquitto__nginx__dependent_servers[0].name = {{ mosquitto__fqdn }}
mosquitto__nginx__dependent_servers[0].filename = mosquitto-websocket
mosquitto__nginx__dependent_servers[0].by_role = debops.mosquitto
mosquitto__nginx__dependent_servers[0].root = {{ mosquitto__http_dir_path }}
mosquitto__nginx__dependent_servers[0].webroot_create = False
mosquitto__nginx__dependent_servers[0].allow = {{ mosquitto__websockets_allow }}
mosquitto__nginx__dependent_servers[0].type = proxy
mosquitto__nginx__dependent_servers[0].proxy_pass = http://mosquitto_websocket
mosquitto__nginx__dependent_servers[0].proxy_redirect = default
mosquitto__nginx__dependent_servers[0].proxy_options = proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection "upgrade";

mosquitto__nginx__dependent_upstreams[0].name = mosquitto_websocket
mosquitto__nginx__dependent_upstreams[0].server = 127.0.0.1:1884
