[0].name = Import DebOps global handlers
[0]["ansible.builtin.import_role"].name = global_handlers
[1].name = Check if other time daemons are installed
[1].environment.LC_MESSAGES = C
[1]["ansible.builtin.shell"] = set -o nounset -o pipefail -o errexit &&
dpkg --get-selections | grep -w -E '({{ timesyncd__skip_packages | join("|") }})'
                      | awk '{print $1}' || true

[1].args.executable = /bin/bash
[1].register = timesyncd__register_time_daemons
[1].changed_when = False
[1].failed_when = False
[1].check_mode = False
[2].name = Set timesyncd deployment state
[2]["ansible.builtin.set_fact"].timesyncd__fact_service_state = {{ "present"
                                       if (not timesyncd__register_time_daemons.stdout | d())
                                       else "absent" }}
[3].name = Install required timesyncd packages
[3]["ansible.builtin.package"].name = {{ timesyncd__base_packages + timesyncd__packages }}
[3]["ansible.builtin.package"].state = present
[3].register = timesyncd__register_packages
[3].until = timesyncd__register_packages is succeeded
[3].when = timesyncd__enabled | bool
[4].name = Make sure that Ansible local facts directory exists
[4]["ansible.builtin.file"].path = /etc/ansible/facts.d
[4]["ansible.builtin.file"].state = directory
[4]["ansible.builtin.file"].mode = 0755
[4].when = timesyncd__enabled | bool
[5].name = Save timesyncd local facts
[5]["ansible.builtin.template"].src = etc/ansible/facts.d/timesyncd.fact.j2
[5]["ansible.builtin.template"].dest = /etc/ansible/facts.d/timesyncd.fact
[5]["ansible.builtin.template"].mode = 0755
[5].notify[0] = Refresh host facts
[5].when = timesyncd__enabled | bool
[5].tags[0] = meta::facts
[6].name = Update Ansible facts if they were modified
[6]["ansible.builtin.meta"] = flush_handlers
[7].name = Remove systemd-timesyncd configuration if requested
[7]["ansible.builtin.file"].path = /etc/systemd/timesyncd.conf.d/ansible.conf
[7]["ansible.builtin.file"].state = absent
[7].notify[0] = Restart systemd-timesyncd service
[7].when = timesyncd__enabled | bool and timesyncd__deploy_state == 'absent'
[8].name = Create systemd-timesyncd configuration directory
[8]["ansible.builtin.file"].path = /etc/systemd/timesyncd.conf.d
[8]["ansible.builtin.file"].state = directory
[8]["ansible.builtin.file"].mode = 0755
[8].when = timesyncd__enabled | bool and timesyncd__deploy_state != 'absent'
[9].name = Generate systemd-timesyncd configuration
[9]["ansible.builtin.template"].src = etc/systemd/timesyncd.conf.d/ansible.conf.j2
[9]["ansible.builtin.template"].dest = /etc/systemd/timesyncd.conf.d/ansible.conf
[9]["ansible.builtin.template"].mode = 0644
[9].notify[0] = Restart systemd-timesyncd service
[9].when = timesyncd__enabled | bool and timesyncd__deploy_state != 'absent'
[10].name = Flush handlers when needed
[10]["ansible.builtin.meta"] = flush_handlers
[11].name = Prepare cleanup during package removal
[11]["ansible.builtin.import_role"].name = dpkg_cleanup
[11].vars.dpkg_cleanup__dependent_packages[0] = {{ timesyncd__dpkg_cleanup__dependent_packages }}
[11].when = timesyncd__enabled | bool
[11].tags[0] = role::dpkg_cleanup
[11].tags[1] = skip::dpkg_cleanup
[11].tags[2] = role::timesyncd:dpkg_cleanup
