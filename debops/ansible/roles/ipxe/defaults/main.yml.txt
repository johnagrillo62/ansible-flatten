ipxe__base_packages[0] = ipxe
ipxe__base_packages[1] = pax
ipxe__base_packages[2] = cpio
ipxe__base_packages[3] = syslinux-common
ipxe__base_packages[4] = openssl
ipxe__base_packages[5] = ca-certificates
ipxe__tftp_root = {{ ansible_local.tftpd.directory | d(ansible_local.dnsmasq.boot_tftp_root | d("/srv/tftp")) }}
ipxe__bootloaders[0] = /usr/lib/syslinux/memdisk
ipxe__bootloaders[1] = /usr/lib/ipxe/undionly.kpxe
ipxe__bootloaders[2] = /boot/ipxe.efi
ipxe__debian_netboot_enabled = True
ipxe__debian_netboot_firmware = {{ ansible_local.apt.nonfree | d() | bool }}
ipxe__debian_netboot_src = {{ (ansible_local.fhs.src | d("/usr/local/src"))
                              + "/ipxe/debian/netboot" }} 
ipxe__debian_netboot_pxe_root = {{ ipxe__tftp_root + "/pxe/linux/debian" }}
ipxe__debian_netboot_mirror = https://deb.debian.org/debian
ipxe__debian_netboot_firmware_mirror = https://cdimage.debian.org/cdimage/unofficial/non-free/firmware
ipxe__debian_netboot_releases[0] = bullseye
ipxe__debian_netboot_releases[1] = bookworm
ipxe__debian_netboot_releases[2] = trixie
ipxe__debian_netboot_architectures[0] = amd64
ipxe__debian_netboot_architectures[1] = i386
ipxe__debian_netboot_architectures[2] = arm64
ipxe__debian_netboot_default_release_map[0].name = bullseye-amd64
ipxe__debian_netboot_default_release_map[0].release = bullseye
ipxe__debian_netboot_default_release_map[0].architecture = amd64
ipxe__debian_netboot_default_release_map[0].netboot_version = 20210731+deb11u12
ipxe__debian_netboot_default_release_map[0].netboot_checksum = sha256:77033ca69a43f0dd06d274f90f40dcf3487e93772c3331d22ad84419305da157
ipxe__debian_netboot_default_release_map[0].firmware_version = 20240831
ipxe__debian_netboot_default_release_map[0].firmware_checksum = sha256:5dff544bad3dc197a8e20b6121ef0c005d2f06085b83e7f24ca9feb7e77e42d2
ipxe__debian_netboot_default_release_map[1].name = bullseye-amd64-gtk
ipxe__debian_netboot_default_release_map[1].release = bullseye
ipxe__debian_netboot_default_release_map[1].architecture = amd64
ipxe__debian_netboot_default_release_map[1].netboot_subdir = /gtk
ipxe__debian_netboot_default_release_map[1].netboot_version = 20210731+deb11u12
ipxe__debian_netboot_default_release_map[1].netboot_checksum = sha256:854d108e35b3d96a71cfb5ddcb96fed14e51915aae9c9fdbaa634d1ad17bafa6
ipxe__debian_netboot_default_release_map[1].firmware_version = 20240831
ipxe__debian_netboot_default_release_map[1].firmware_checksum = sha256:5dff544bad3dc197a8e20b6121ef0c005d2f06085b83e7f24ca9feb7e77e42d2
ipxe__debian_netboot_default_release_map[2].name = bookworm-amd64
ipxe__debian_netboot_default_release_map[2].release = bookworm
ipxe__debian_netboot_default_release_map[2].architecture = amd64
ipxe__debian_netboot_default_release_map[2].netboot_version = 20230607+deb12u12
ipxe__debian_netboot_default_release_map[2].netboot_checksum = sha256:2cc3a5c20f9605ac29ea3afb6376d55b14d827f1ac44c42c3d3eed464a3c255b
ipxe__debian_netboot_default_release_map[2].firmware_version = 20250906
ipxe__debian_netboot_default_release_map[2].firmware_checksum = sha256:09a174c10ea816f1ea704be84005cc7af0a68c2121c282e7d8c89b73b355c36e
ipxe__debian_netboot_default_release_map[3].name = bookworm-amd64-gtk
ipxe__debian_netboot_default_release_map[3].release = bookworm
ipxe__debian_netboot_default_release_map[3].architecture = amd64
ipxe__debian_netboot_default_release_map[3].netboot_subdir = /gtk
ipxe__debian_netboot_default_release_map[3].netboot_version = 20230607+deb12u12
ipxe__debian_netboot_default_release_map[3].netboot_checksum = sha256:130fd44c343e0fe5addbd0afcfc86b2fd3d5f8d77159f238609a6ab3f75ca07e
ipxe__debian_netboot_default_release_map[3].firmware_version = 20250906
ipxe__debian_netboot_default_release_map[3].firmware_checksum = sha256:09a174c10ea816f1ea704be84005cc7af0a68c2121c282e7d8c89b73b355c36e
ipxe__debian_netboot_default_release_map[4].name = trixie-amd64
ipxe__debian_netboot_default_release_map[4].release = trixie
ipxe__debian_netboot_default_release_map[4].architecture = amd64
ipxe__debian_netboot_default_release_map[4].netboot_version = 20250803+deb13u1
ipxe__debian_netboot_default_release_map[4].netboot_checksum = sha256:a75870b27965ef67f13a2cdc9d4c574224e16b9b2764f88bf0ecc7c28b244fcb
ipxe__debian_netboot_default_release_map[4].firmware_version = 20250906
ipxe__debian_netboot_default_release_map[4].firmware_checksum = sha256:e00d0f1c498932e0b8e86663701a96a9d3ad30c0f9200e21427b8db7ce2c900a
ipxe__debian_netboot_default_release_map[5].name = trixie-amd64-gtk
ipxe__debian_netboot_default_release_map[5].release = trixie
ipxe__debian_netboot_default_release_map[5].architecture = amd64
ipxe__debian_netboot_default_release_map[5].netboot_subdir = /gtk
ipxe__debian_netboot_default_release_map[5].netboot_version = 20250803+deb13u1
ipxe__debian_netboot_default_release_map[5].netboot_checksum = sha256:ac444dfe9f4e6d62aa54e8d33eae9c30984fb73ee78a15d115273c39026a08eb
ipxe__debian_netboot_default_release_map[5].firmware_version = 20250906
ipxe__debian_netboot_default_release_map[5].firmware_checksum = sha256:e00d0f1c498932e0b8e86663701a96a9d3ad30c0f9200e21427b8db7ce2c900a
ipxe__debian_netboot_combined_release_map = {{ ipxe__debian_netboot_default_release_map
                                               + ipxe__debian_netboot_release_map }} 
ipxe__default_scripts[0].name = variables.ipxe
ipxe__default_scripts[0].comment = iPXE global variables
ipxe__default_scripts[0].options[0].name = main_menu_title
ipxe__default_scripts[0].options[0].comment = The main menu title
ipxe__default_scripts[0].options[0].value = {{ ansible_local.machine.organization | d("DebOps") + " Boot Menu" }}
ipxe__default_scripts[0].options[1].name = debian_installer_mirror
ipxe__default_scripts[0].options[1].comment = Debian mirror used during automated installation
ipxe__default_scripts[0].options[1].value = deb.debian.org
ipxe__default_scripts[0].options[2].name = debian_installer_preseed
ipxe__default_scripts[0].options[2].comment = Default preseed subdomain to use
ipxe__default_scripts[0].options[2].value = debian.seed
ipxe__default_scripts[0].options[3].name = debian_installer_keymap
ipxe__default_scripts[0].options[3].comment = Default keymap to set for the preseeding
ipxe__default_scripts[0].options[3].value = us
ipxe__default_scripts[0].options[4].name = debian_installer_kernel_params
ipxe__default_scripts[0].options[4].comment = Kernel parameters passed to the Debian Installer at boot
ipxe__default_scripts[0].options[4].value[0] = quiet
ipxe__default_scripts[0].options[5].name = ipxe_boot_path
ipxe__default_scripts[0].options[5].comment = Subdirectory with boot configuration files
ipxe__default_scripts[0].options[5].value = boot/
ipxe__default_scripts[1].name = boot.ipxe
ipxe__default_scripts[1].raw = # iPXE configuration based on https://gist.github.com/robinsmidsrod/2234639

# Global variables used by all other iPXE scripts
chain --autofree variables.ipxe ||

# Boot using a dynamic script if it's specified
# http://ipxe.org/scripting
isset ${ipxe_boot_url} && chain --replace --autofree ${ipxe_boot_url} ||

# Boot <boot-url>/<boot-path>/hostname-<hostname>.ipxe
# if hostname DHCP variable is set and script is present
isset ${hostname} && chain --replace --autofree ${ipxe_boot_path}hostname-${hostname}.ipxe ||

# Boot <boot-url>/<boot-path>/uuid-<UUID>.ipxe
# if SMBIOS UUID variable is set and script is present
isset ${uuid} && chain --replace --autofree ${ipxe_boot_path}uuid-${uuid}.ipxe ||

# Boot <boot-url>/<boot-path>/mac-010203040506.ipxe if script is present
chain --replace --autofree ${ipxe_boot_path}mac-${mac:hexraw}.ipxe ||

# Boot <boot-url>/<boot-path>/pci-8086100e.ipxe if one type of
# PCI Intel adapter is present and script is present
chain --replace --autofree ${ipxe_boot_path}pci-${pci/${busloc}.0.2}${pci/${busloc}.2.2}.ipxe ||

# Boot <boot-url>/<boot-path>/chip-82541pi.ipxe if one type of
# PCI Intel adapter is present and script is present
chain --replace --autofree ${ipxe_boot_path}chip-${chip}.ipxe ||

# Boot <boot-url>/menu.ipxe script if all other options have been exhausted
set post_boot true
chain --replace --autofree menu.ipxe ||

ipxe__default_scripts[1].state = present
ipxe__default_scripts[2].name = menu.ipxe
ipxe__default_scripts[2].options[0].name = initialization
ipxe__default_scripts[2].options[0].raw = :start

chain --autofree variables.ipxe ||

set space:hex 20:20
set space ${space:string}

iseq ${cls} serial && goto ignore_cls ||
set cls:hex 1b:5b:4a  # ANSI clear screen sequence - "^[[J"
set cls ${cls:string}
:ignore_cls

isset ${arch} && goto skip_arch_detect ||
cpuid --ext 29 && set arch x86_64 || set arch i386
iseq ${arch} i386   && set arch5 i586   || set arch5 ${arch}
iseq ${arch} x86_64 && set arch_a amd64 || set arch_a ${arch}
:skip_arch_detect

isset ${menu} && goto ${menu} ||

isset ${ip} || dhcp || echo DHCP failed

isset ${post_boot} || chain --replace --autofree boot.ipxe ||

ipxe__default_scripts[2].options[1].name = main-menu-header
ipxe__default_scripts[2].options[1].raw = :main_menu
isset ${main_menu_cursor} || set main_menu_cursor exit
clear version
menu ${main_menu_title} [IP: ${netX/ip}]
item --gap Default:
item --key x exit ${space} Boot from hard disk [x]
item
item --gap Main menu:

ipxe__default_scripts[2].options[2].name = main-menu
ipxe__default_scripts[2].options[2].raw = item --key d debian-installer ${space} Install Debian GNU/Linux on this host [d]
item

ipxe__default_scripts[2].options[3].name = main-menu-footer
ipxe__default_scripts[2].options[3].raw = item netboot_xyz_boot_menu ${space} -> Netboot.xyz Boot Menu
item sal_boot_menu         ${space} -> SAL Boot Menu
item rackspace_boot_menu   ${space} -> Rackspace Boot Menu
item
item --gap Tools:
item sysinfo ${space} System info
item reboot ${space} Reboot
item shell ${space} iPXE shell

isset ${menu} && set timeout 0 || set timeout 4000
choose --timeout ${timeout} --default ${main_menu_cursor} menu || goto cancel
set main_menu_cursor ${menu}
set timeout 0
goto ${menu} ||
chain ${menu}.ipxe || goto error
goto main_menu

ipxe__default_scripts[2].options[4].name = cancel-shell
ipxe__default_scripts[2].options[4].raw = :cancel
echo You cancelled the menu, dropping you to a shell

:shell
echo Type "exit" to return to menu.
set menu main_menu
shell
goto main_menu

ipxe__default_scripts[2].options[5].name = other-boot-menu
ipxe__default_scripts[2].options[5].raw = :sal_boot_menu
chain http://boot.salstar.sk || goto error
goto main_menu

:rackspace_boot_menu
chain http://boot.rackspace.com/menu.ipxe || goto error
goto main_menu

:netboot_xyz_boot_menu
chain --autofree http://boot.netboot.xyz || goto error
goto main_menu

ipxe__default_scripts[2].options[6].name = reboot-exit-error
ipxe__default_scripts[2].options[6].raw = :reboot
reboot

:exit
echo ${cls}
exit

:error
echo Error occurred, press any key to return to menu ...
prompt
goto main_menu

:reload
echo Reloading menu.ipxe ...
chain menu.ipxe

ipxe__default_scripts[2].options[7].name = sysinfo
ipxe__default_scripts[2].options[7].raw = :sysinfo
menu System info
item --gap UUID:
item mac ${space} ${uuid}
item --gap MAC:
item mac ${space} ${netX/mac}
item --gap IP/mask:
item ip ${space} ${netX/ip}/${netX/netmask}
item --gap Gateway:
item gw ${space} ${netX/gateway}
item --gap Hostname:
item hostname ${space} ${hostname}
item --gap Domain:
item domain ${space} ${netX/domain}
item --gap DNS:
item dns ${space} ${netX/dns}
item --gap DHCP server:
item dhcpserver ${space} ${netX/dhcp-server}
item --gap Next-server:
item nextserver ${space} ${next-server}
item --gap Filename:
item filename ${space} ${netX/filename}
choose empty ||
goto main_menu

ipxe__default_scripts[3].name = debian-installer.ipxe
ipxe__default_scripts[3].raw = chain --autofree variables.ipxe ||

goto ${menu}

:debian-installer
isset ${debian-installer-cursor} || set debian-installer-cursor stable
set os debian
set domain ${netX/domain}

iseq ${manufacturer} Xen && set netcfg netcfg/get_ipaddress=${netX/ip} netcfg/get_netmask=${netX/netmask} netcfg/get_gateway=${netX/gateway} netcfg/get_nameservers=${dns} netcfg/confirm_static=true netcfg/choose_interface=auto netcfg/disable_autoconfig=true ||

menu Install Debian GNU/Linux / ${arch_a}
item --gap Select suite:
item --key e trixie ${space} Debian Stable (Trixie) [e]
# Enable this when Debian Forky gets an installer
#item forky ${space} Debian Testing (Forky)
item
item --gap Select release:
item trixie ${space} Debian GNU/Linux 13 (Trixie)
item bookworm ${space} Debian GNU/Linux 12 (Bookworm)
item bullseye ${space} Debian GNU/Linux 11 (bullseye)
choose --default ${debian-installer-cursor} version || goto debian_exit
set debian-installer-cursor ${version}

set mirrorcfg mirror/suite=${version} mirror/country=manual mirror/http/hostname=${debian_installer_mirror} mirror/http/directory=/${os}

set boot_params -- ${debian_installer_kernel_params}

:deb_boot_type_init
set type text

:deb_boot_type
set dir pxe/linux/debian/${version}/${arch_a}/current

menu Install Debian GNU/Linux / ${arch_a} / ${version}
item --gap Select installer mode:
item text ${space} Text install
item graphical ${space} Graphical install
item
item rescue ${space} Rescue mode
item
item expert ${space} Expert install
item --key b preseed ${space} Preseed install [b]
item
item --gap Preseed parameters:
item config_hostname ${space} Hostname: ${hostname}
item config_domain ${space} Domain: ${domain}
item config_preseed ${space} Flavor: ${debian_installer_preseed}
item config_keymap ${space} Keymap: ${debian_installer_keymap}
item
item --gap Installer parameters:
item config_mirror ${space} Mirror: ${debian_installer_mirror}
item config_boot_params ${space} Boot: ${boot_params}
choose --default ${type} type || goto debian-installer

echo ${cls}
goto deb_${type}

:deb_config_mirror
echo -n Set Debian mirror [${debian_installer_mirror}]: && read change_debian_installer_mirror
isset ${change_debian_installer_mirror} && set debian_installer_mirror ${change_debian_installer_mirror} || goto deb_boot_type
clear change_debian_installer_mirror
set mirrorcfg mirror/suite=${version} mirror/country=manual mirror/http/hostname=${debian_installer_mirror} mirror/http/directory=/${os}
goto deb_boot_type

:deb_config_boot_params
echo -n Edit boot options: && read boot_params
goto deb_boot_type

:deb_config_keymap
echo -n Set keymap [${debian_installer_keymap}]: && read change_debian_installer_keymap
isset ${change_debian_installer_keymap} && set debian_installer_keymap ${change_debian_installer_keymap} || goto deb_boot_type
clear change_debian_installer_keymap
goto deb_boot_type

:deb_config_hostname
echo -n Set hostname: [${hostname}]: && read change_hostname
isset ${change_hostname} && set hostname ${change_hostname} || goto deb_boot_type
clear change_hostname
goto deb_boot_type

:deb_config_domain
echo -n Set domain [${domain}]: && read change_domain
isset ${change_domain} && set domain ${change_domain} || goto deb_boot_type
clear change_domain
goto deb_boot_type

:deb_config_preseed
echo -n Set preseed URL for ${os} ${version} [${debian_installer_preseed}]: && read change_debian_installer_preseed
isset ${change_debian_installer_preseed} && set debian_installer_preseed ${change_debian_installer_preseed} || goto deb_boot_type
clear change_debian_installer_preseed
goto deb_boot_type

:deb_rescue
set install_params rescue/enable=true
goto deb_text

:deb_expert
set install_params priority=low
goto deb_text

:deb_preseed
echo -n Set preseed URL for ${os} ${version} [${debian_installer_preseed}]: && read preseedurl || goto deb_boot_type
isset ${hostname} || goto deb_preseed_get_hostname
:deb_preseed_has_hostname
isset ${preseedurl} && set install_params auto=true priority=critical preseed/url=${preseedurl} keymap=${debian_installer_keymap} netcfg/hostname=${hostname} domain=${domain} || goto deb_default_preseed
goto deb_text
:deb_default_preseed
set install_params auto=true priority=critical preseed/url=${debian_installer_preseed} keymap=${debian_installer_keymap} netcfg/hostname=${hostname} domain=${domain} ||
goto deb_text

:deb_preseed_get_hostname
echo -n Set hostname [${hostname}]: && read hostname || goto deb_preseed_no_hostname
isset ${hostname} || goto deb_preseed_no_hostname
goto deb_preseed_has_hostname

:deb_preseed_no_hostname
echo Error: Preseeding requires a valid hostname. Press <Enter> to continue.
prompt
goto deb_boot_type

:deb_text
set dir ${dir}/debian-installer/${arch_a}
goto deb_boot

:deb_graphical
set dir ${dir}/gtk/debian-installer/${arch_a}
set install_params vga=788
goto deb_boot

:deb_boot
imgfree
echo Boot parameters: ${install_params} ${boot_params}
kernel ${dir}/linux initrd=initrd.gz ${netcfg} ${mirrorcfg} ${install_params} ${boot_params}
initrd ${dir}/initrd.gz
boot
goto debian_exit

:debian_exit
set menu main_menu
chain menu.ipxe

ipxe__default_scripts[3].state = present
ipxe__combined_scripts = {{ ipxe__default_scripts
                            + ipxe__scripts
                            + ipxe__group_scripts
                            + ipxe__host_scripts }}

